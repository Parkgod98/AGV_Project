[
    {
        "id": "49f8711fc297a8c1",
        "type": "tab",
        "label": "í”Œë¡œìš° 1",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "048a808c4f50c1eb",
        "type": "telegram receiver",
        "z": "49f8711fc297a8c1",
        "name": "",
        "bot": "d10c4415b361b866",
        "saveDataDir": "",
        "filterCommands": false,
        "hasinput": false,
        "inputs": 0,
        "handleallupdates": false,
        "x": 410,
        "y": 480,
        "wires": [
            [
                "7476d3bed8965c26"
            ],
            []
        ]
    },
    {
        "id": "d1e13ead5e796c2d",
        "type": "telegram sender",
        "z": "49f8711fc297a8c1",
        "name": "",
        "bot": "d10c4415b361b866",
        "haserroroutput": false,
        "outputs": 1,
        "x": 1030,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "7476d3bed8965c26",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "function 1",
        "func": "node.warn(\"GMS_KEY = \" + global.get(\"GMS_KEY\"));\n\nconst chatId = msg.payload.chatId;\nconst text = (msg.payload.content || \"\").trim();\n\n// âœ… 1) contentê°€ file_idì²˜ëŸ¼ ë³´ì´ë©´ ìŒì„±/íŒŒì¼ë¡œ ê°„ì£¼í•˜ê³  ë§‰ê¸°\nconst looksLikeFileId = typeof text === \"string\" && /^Aw[A-Za-z0-9_-]{10,}$/.test(text);\n\nif (looksLikeFileId) {\n  msg.payload = {\n    chatId,\n    type: \"message\",\n    content: \"ğŸ™ï¸ ìŒì„± ëª…ë ¹(STT)ì€ ì•„ì§ ì—°ê²° ì „ì´ì—ìš”.\\nì§€ê¸ˆì€ ë²„íŠ¼ ë˜ëŠ” í…ìŠ¤íŠ¸ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.\",\n    options: {}\n  };\n  return [msg, null, null]; // í…”ë ˆê·¸ë¨ë§Œ ì‘ë‹µ, MQTT/LLM ì•ˆ íƒ\n}\n\nlet reply = {\n  chatId,\n  type: \"message\",\n  content: \"\",\n  options: {}\n};\n\nlet mqttMsg = null;   // output2\nlet llmReq = null;    // output3\n\nfunction makeMqtt(topic, type, target_area, inputKind) {\n  return {\n    topic,\n    payload: JSON.stringify({\n      type,\n      target_area,\n      user_id: `tg_${chatId}`,\n      meta: { source: \"telegram\", input: inputKind, raw: text }\n    })\n  };\n}\n\n// /start\nif (text === \"/start\") {\n  if (!flow.get(\"default_area_\" + chatId)) flow.set(\"default_area_\" + chatId, \"USER1\");\n  reply.content = \"ì•ˆë…•í•˜ì„¸ìš”! AGV ì„œë¹„ìŠ¤ ë´‡ì…ë‹ˆë‹¤.\\në¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?\";\n  reply.options = {\n    reply_markup: {\n      keyboard: [\n        [\"â˜• ë¬¼ ê°€ì ¸ì™€ì¤˜\", \"ğŸ¥¤ ì»µ ê°€ì ¸ê°€ì¤˜\"],\n        [\"ğŸ§º ì„¸íƒë¬¼ ìˆ˜ê±°í•´ì¤˜\"],\n        [\"ğŸ“ ì§€ê¸ˆ ìƒíƒœ ë³´ì—¬ì¤˜\", \"ğŸ“Š ì˜¤ëŠ˜ ìš”ì•½ ë³´ì—¬ì¤˜\"]\n      ],\n      resize_keyboard: true,\n      one_time_keyboard: false\n    }\n  };\n  msg.payload = reply;\n  return [msg, null, null];\n}\n\n// ë²„íŠ¼ ëª…ë ¹(ë£° ê¸°ë°˜ ì¦‰ì‹œ publish)\nif (text === \"â˜• ë¬¼ ê°€ì ¸ì™€ì¤˜\") {\n  mqttMsg = makeMqtt(\"cmd/water/request\", \"deliver_water\", \"USER1\", \"button\");\n  reply.content = \"ë¬¼ ë°°ë‹¬ ìš”ì²­ì„ ì ‘ìˆ˜í–ˆì–´ìš” ğŸ’§\";\n  msg.payload = reply;\n  return [msg, mqttMsg, null];\n}\nif (text === \"ğŸ¥¤ ì»µ ê°€ì ¸ê°€ì¤˜\") {\n  mqttMsg = makeMqtt(\"cmd/cup/request\", \"collect_cup\", \"USER1\", \"button\");\n  reply.content = \"ì»µ íšŒìˆ˜ ìš”ì²­ì„ ì ‘ìˆ˜í–ˆì–´ìš” ğŸ¥¤\";\n  msg.payload = reply;\n  return [msg, mqttMsg, null];\n}\nif (text === \"ğŸ§º ì„¸íƒë¬¼ ìˆ˜ê±°í•´ì¤˜\") {\n  mqttMsg = makeMqtt(\"cmd/laundry/request\", \"collect_laundry\", \"USER1\", \"button\");\n  reply.content = \"ì„¸íƒë¬¼ ìˆ˜ê±° ìš”ì²­ì„ ì ‘ìˆ˜í–ˆì–´ìš” ğŸ§º\";\n  msg.payload = reply;\n  return [msg, mqttMsg, null];\n}\n\n// ê·¸ ì™¸ í…ìŠ¤íŠ¸ = ìì—°ì–´/ìŒì„±(STT ê²°ê³¼) â†’ LLM\nreply.content = `ìš”ì²­ì„ í•´ì„ ì¤‘ì´ì—ìš”â€¦ ğŸ¤–\\nì…ë ¥: ${text}`;\nmsg.payload = reply;\n\n// LLM API í˜¸ì¶œìš© msg êµ¬ì„± (http requestë¡œ ë³´ë‚¼ body + headers)\nllmReq = {\n  headers: {\n    \"Content-Type\": \"application/json\",\n    // í™˜ê²½ë³€ìˆ˜ ì‚¬ìš© (í•„ìˆ˜)\n    \"Authorization\": `Bearer ${global.get(\"GMS_KEY\")}`\n  },\n  payload: {\n    model: \"gpt-4.1-nano\",\n    temperature: 0.2,\n    max_tokens: 200,\n    messages: [\n      {\n        role: \"system\",\n        content:\n          \"ë„ˆëŠ” AGV ì‚¬ìš©ì ì•±ì˜ ëª…ë ¹ íŒŒì„œë‹¤. ë°˜ë“œì‹œ JSONë§Œ ì¶œë ¥í•´.\\n\" +\n          \"í—ˆìš© type: deliver_water, collect_cup, collect_laundry\\n\" +\n          \"í—ˆìš© target_area: USER1, USER2, DOCK, BASE\\n\" +\n          'í˜•ì‹: {\"type\":\"...\",\"target_area\":\"...\",\"confidence\":0.0}\\n' +\n          \"ì¶”ë¡  ì„¤ëª… ê¸ˆì§€. JSON ì™¸ í…ìŠ¤íŠ¸ ê¸ˆì§€.\"\n      },\n      {\n        role: \"user\",\n        content: text\n      }\n    ]\n  },\n  _tg: { chatId, raw: text } // í›„ë‹¨ì—ì„œ í…”ë ˆê·¸ë¨ ì‘ë‹µ ë§Œë“¤ ë•Œ ì“°ë ¤ê³  ë³´ê´€\n};\n\nreturn [msg, null, llmReq];\n",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 480,
        "wires": [
            [
                "d1e13ead5e796c2d"
            ],
            [
                "6b5f1a99de2569f0"
            ],
            [
                "54431a46252d1602"
            ]
        ]
    },
    {
        "id": "6b5f1a99de2569f0",
        "type": "mqtt out",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3c16a07776b27396",
        "x": 990,
        "y": 400,
        "wires": []
    },
    {
        "id": "bea82cdd7f9e1fa3",
        "type": "mqtt in",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "cmd/+/request",
        "qos": "2",
        "datatype": "utf8",
        "broker": "3c16a07776b27396",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 390,
        "y": 640,
        "wires": [
            [
                "e0253ffdf7c81394",
                "084632d493b02014"
            ]
        ]
    },
    {
        "id": "e0253ffdf7c81394",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "function 2",
        "func": "// cmd/*/request ì—ì„œ ë„˜ì–´ì˜¨ msg\n// msg.topic ì˜ˆ: \"cmd/water/request\"\n// msg.payload ì˜ˆ: JSON ë¬¸ìì—´: {\"type\":\"deliver_water\",\"target_area\":\"USER1\",\"user_id\":\"tg_1234\"}\n\nlet data = {};\ntry {\n    data = JSON.parse(msg.payload || '{}');\n} catch (e) {\n    node.error('Invalid JSON payload in cmd request', msg);\n    return null;\n}\n\n// ê¸€ë¡œë²Œ taskQueue ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´)\nlet queue = global.get('taskQueue') || [];\n\n// task_id ìƒì„± (ê°„ë‹¨ ë²„ì „)\nconst taskId = 'task_' + Date.now();\n\n// typeì€ payloadì— ì—†ìœ¼ë©´ topicì—ì„œ ìœ ì¶”í•´ë„ ë¨ (ì§€ê¸ˆì€ payload ê¸°ì¤€ìœ¼ë¡œ)\nconst taskType = data.type || (() => {\n    if (msg.topic.startsWith('cmd/water/')) \n        return 'deliver_water';\n    if (msg.topic.startsWith('cmd/cup/')) \n        return 'collect_cup';\n    if (msg.topic.startsWith('cmd/laundry/')) \n        return 'collect_laundry';\n    return 'unknown';\n})();\n\n// Task ê°ì²´ ì •ì˜ (v0.1)\nconst task = {\n    task_id: taskId,\n    type: taskType,                          // deliver_water / collect_cup / collect_laundry ...\n    target_area: data.target_area || 'USER1',\n    user_id: data.user_id || null,\n    status: 'pending',                       // pending / running / done / failed\n    created_at: Date.now(),\n    // ë‚˜ì¤‘ì— assigned_robot / started_at / finished_at ì¶”ê°€ ì˜ˆì •\n};\n\n// íì— push\nqueue.push(task);\nglobal.set('taskQueue', queue);\n\n// ë””ë²„ê·¸ìš© ë¡œê·¸\nnode.warn({ action: 'TASK_CREATED', task: task });\n\n// ì•„ë˜ë¡œ ë„˜ê²¨ì¤„ ë©”ì‹œì§€ ì„¸íŒ…\nmsg.task = task;           // ë‹¤ìŒ ë…¸ë“œì—ì„œ ì‚¬ìš©\nmsg.payload = JSON.stringify(task);      // ë””ë²„ê·¸ í•˜ê¸° ì¢‹ê²Œ payloadì—ë„ ë„£ì–´ë‘ \n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 640,
        "wires": [
            [
                "2ccacb1608c5ba74"
            ]
        ]
    },
    {
        "id": "8fa070ba704430fc",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "function 3",
        "func": "// v0.1: ë“¤ì–´ì˜¨ taskë¥¼ ë¬´ì¡°ê±´ agv1ì— ë°”ë¡œ í• ë‹¹í•´ì„œ ë³´ëƒ„\n\nlet task = msg.task;\nif (!task) {\n    node.warn('No task found in msg');\n    return null;\n}\n\n// ìƒíƒœ ë³€ê²½\ntask.status = 'running';\ntask.assigned_robot = 'agv1';\ntask.started_at = Date.now();\n\n// ê¸€ë¡œë²Œ íì—ë„ ë°˜ì˜\nlet queue = global.get('taskQueue') || [];\nfor (let i = 0; i < queue.length; i++) {\n    if (queue[i].task_id === task.task_id) {\n        queue[i] = task;\n        break;\n    }\n}\nglobal.set('taskQueue', queue);\n\n// ë””ë²„ê·¸ìš©\nnode.warn({ action: 'TASK_ASSIGNED', task: task });\n\n// ì´ msgë¥¼ mqtt outìœ¼ë¡œ ë³´ë‚¼ ì¤€ë¹„\nmsg.topic = 'robot/agv1/task';\nmsg.payload = JSON.stringify(task);\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 860,
        "y": 640,
        "wires": [
            [
                "58d8d616da6872e1"
            ]
        ]
    },
    {
        "id": "c02ac5399c925f84",
        "type": "mqtt out",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3c16a07776b27396",
        "x": 1270,
        "y": 640,
        "wires": []
    },
    {
        "id": "084632d493b02014",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 520,
        "y": 720,
        "wires": []
    },
    {
        "id": "a8cdfef7f11748d6",
        "type": "mqtt in",
        "z": "49f8711fc297a8c1",
        "name": "robot status",
        "topic": "robot/+/status",
        "qos": "2",
        "datatype": "utf8",
        "broker": "3c16a07776b27396",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 390,
        "y": 840,
        "wires": [
            [
                "95ebc22a961575da"
            ]
        ]
    },
    {
        "id": "95ebc22a961575da",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "function(updateStatus)",
        "func": "// robot/+/status ë¡œë¶€í„° ë“¤ì–´ì˜¤ëŠ” msgë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜\n\n// 1) payload JSON íŒŒì‹±\nlet status;\ntry {\n    status = JSON.parse(msg.payload || '{}');\n} catch (e) {\n    node.error('Invalid JSON in robot status', msg);\n    return null;\n}\n\n// 2) í† í”½ì—ì„œ robot_id ì¶”ì¶œ: robot/agv1/status\nconst parts = msg.topic.split('/');\nconst robotIdFromTopic = parts[1] || null;\nconst robotId = status.robot_id || robotIdFromTopic || 'unknown';\n\n// 3) robots ìƒíƒœ ê°±ì‹  (global.robots)\nlet robots = global.get('robots') || {};\nconst now = Date.now();\nrobots[robotId] = {\n    // ê¸°ì¡´ ê°’ ìœ ì§€(ì¶”ê°€ í•„ë“œ ì•ˆ ë‚ ë¦¬ê¸°)\n    ...(robots[robotId] || {}),\n\n    // í‘œì¤€ í•„ë“œ\n    robot_id: robotId,\n    state: status.state || 'unknown',\n    task_id: status.task_id || null,\n    battery: status.battery ?? null,\n    area: status.area || null,\n    error_code: status.error_code || null,\n\n    // ë””ì§€í„¸ íŠ¸ìœˆ í•µì‹¬ í•„ë“œ (ì¶”ê°€)\n    pose: status.pose || (robots[robotId]?.pose ?? null),\n    target_area: status.target_area || (robots[robotId]?.target_area ?? null),\n\n    updated_at: status.updated_at || now\n};\nglobal.set('robots', robots);\n\n// 4) taskQueue/events ë°˜ì˜ (task_id ìˆì„ ë•Œë§Œ)\nlet taskQueue = global.get('taskQueue') || [];\nlet events = global.get('events') || [];\n\nif (status.task_id) {\n    const taskId = status.task_id;\n\n    for (let i = 0; i < taskQueue.length; i++) {\n        if (taskQueue[i].task_id === taskId) {\n\n            if (status.state === 'done' || status.state === 'idle') {\n                taskQueue[i].status = 'done';\n                taskQueue[i].finished_at = Date.now();\n            } else if (status.state === 'running') {\n                taskQueue[i].status = 'running';\n                if (!taskQueue[i].started_at) taskQueue[i].started_at = Date.now();\n            } else if (status.state === 'error') {\n                taskQueue[i].status = 'failed';\n                taskQueue[i].finished_at = Date.now();\n                taskQueue[i].error_code = status.error_code || null;\n            }\n\n            taskQueue[i].assigned_robot = robotId;\n            break;\n        }\n    }\n    global.set('taskQueue', taskQueue);\n\n    events.push({\n        ts: Date.now(),\n        type: 'task_status_update',\n        robot_id: robotId,\n        task_id: taskId,\n        state: status.state,\n        area: status.area || null,\n        target_area: status.target_area || null,\n        pose: status.pose || null,\n        error_code: status.error_code || null\n    });\n\n    if (events.length > 200) events = events.slice(events.length - 200);\n    global.set('events', events);\n}\n\n// 5) ë””ë²„ê·¸ payload ì„¸íŒ…\nmsg.payload = {\n    last_status: status,\n    robots: robots\n};\n\n// ----------------------\n// Firestore write (ì¶”ê°€)\n// ----------------------\nconst db = global.get(\"db\");\nif (db) {\n    // robots/{robotId}\n    db.collection(\"robots\").doc(robotId).set(robots[robotId], { merge: true })\n        .catch(err => node.error(\"[robots write] \" + err));\n\n    // tasks/{task_id} (ìˆì„ ë•Œë§Œ)\n    if (status.task_id) {\n        const mappedStatus =\n            (status.state === \"error\") ? \"failed\" :\n            (status.state === \"done\" || status.state === \"idle\") ? \"done\" :\n            (status.state === \"running\") ? \"running\" : \"unknown\";\n\n        const taskPatch = {\n            status: mappedStatus,\n            assigned_robot: robotId,\n            error_code: status.error_code || null,\n        };\n\n        if (status.state === \"done\" || status.state === \"idle\" || status.state === \"error\") {\n            taskPatch.finished_at = Date.now();\n        }\n\n        db.collection(\"tasks\").doc(status.task_id).set(taskPatch, { merge: true })\n            .catch(err => node.error(\"[tasks write] \" + err));\n    }\n\n    // events add\n    db.collection(\"events\").add({\n        ts: Date.now(),\n        type: \"task_status_update\",\n        robot_id: robotId,\n        task_id: status.task_id || null,\n        state: status.state || null,\n        area: status.area || null,\n        target_area: status.target_area || null,\n        pose: status.pose || null,\n        error_code: status.error_code || null\n    }).catch(err => node.error(\"[events add] \" + err));\n}\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 840,
        "wires": [
            [
                "0ea75d0a1dd47579"
            ]
        ]
    },
    {
        "id": "0ea75d0a1dd47579",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 960,
        "y": 840,
        "wires": []
    },
    {
        "id": "b9b40ef75eda6086",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "refresh robots",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "1",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 240,
        "y": 2960,
        "wires": [
            [
                "62da11a590d356e1"
            ]
        ]
    },
    {
        "id": "62da11a590d356e1",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "getRobots",
        "func": "const robots = global.get('robots') || {};\nconst arr = [];\n\nfor (const id in robots) {\n    const r = robots[id];\n    // updated_at ëˆ„ë½ ë°©ì–´\n    if (!r.updated_at) r.updated_at = Date.now();\n    arr.push(r);\n}\n\nmsg.robots = arr;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 550,
        "y": 2960,
        "wires": [
            [
                "b1495853d26db37c"
            ]
        ]
    },
    {
        "id": "c8bbc855845ed80c",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "refresh tasks",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "1",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 260,
        "y": 3080,
        "wires": [
            [
                "49c2e81ae9744bc4"
            ]
        ]
    },
    {
        "id": "49c2e81ae9744bc4",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "getTasks",
        "func": "let tasks = global.get('taskQueue') || [];\n\n// ìµœê·¼ ìƒì„±ëœ ìˆœì„œëŒ€ë¡œ ë³´ê³  ì‹¶ìœ¼ë©´ ì •ë ¬\ntasks = tasks.slice().sort((a, b) => (b.created_at || 0) - (a.created_at || 0));\n\nmsg.tasks = tasks;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 3080,
        "wires": [
            [
                "c915a198b0c6cae3"
            ]
        ]
    },
    {
        "id": "6867664da4b8f9fd",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "refresh events",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "1",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 260,
        "y": 3200,
        "wires": [
            [
                "b6c7d07a0458179a"
            ]
        ]
    },
    {
        "id": "b6c7d07a0458179a",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "getEvents",
        "func": "let events = global.get('events') || [];\n\n// ìµœì‹  ì´ë²¤íŠ¸ê°€ ìœ„ì— ë³´ì´ë„ë¡ ì—­ìˆœ ì •ë ¬\nevents = events.slice().sort((a, b) => (b.ts || 0) - (a.ts || 0));\n\nmsg.events = events;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 3200,
        "wires": [
            [
                "5b2975efe1ee8e3a"
            ]
        ]
    },
    {
        "id": "b1495853d26db37c",
        "type": "ui_template",
        "z": "49f8711fc297a8c1",
        "group": "e6e1b7942a2b8330",
        "name": "Robots cards",
        "order": 0,
        "width": 0,
        "height": 0,
        "format": "<div class=\"robots-wrapper\">\n  <div ng-repeat=\"r in msg.robots\" \n       class=\"robot-card\" \n       ng-class=\"(r.state || 'unknown').toLowerCase()\">\n       \n    <div class=\"robot-header\">\n      <span class=\"robot-id\">{{r.robot_id}}</span>\n      <span class=\"state-pill\" \n            ng-class=\"(r.state || 'unknown').toLowerCase()\">\n        {{(r.state || 'unknown') | uppercase}}\n      </span>\n    </div>\n\n    <div class=\"robot-main\">\n      <div class=\"battery\">\n        ğŸ”‹ {{r.battery !== null && r.battery !== undefined ? (r.battery + '%') : '-'}}\n      </div>\n      <div class=\"area\">\n        ğŸ“ {{r.area || '-'}}\n      </div>\n      <div class=\"task\">\n        ğŸ§¾ {{r.task_id || '-'}}\n      </div>\n      <div class=\"error\" ng-if=\"r.error_code\">\n        âš  ERROR: {{r.error_code}}\n      </div>\n    </div>\n\n    <div class=\"robot-footer\">\n      <span class=\"updated-label\">UPDATED</span>\n      <span class=\"updated-at\">\n        {{ r.updated_at | date:'HH:mm:ss' }}\n      </span>\n    </div>\n  </div>\n\n  <div ng-if=\"!msg.robots || msg.robots.length === 0\" class=\"robot-empty\">\n    No robot data yet.\n  </div>\n</div>\n\n<style>\n  .robots-wrapper {\n    display:flex;\n    flex-wrap:wrap;\n    gap:16px;\n    padding-top:4px;\n  }\n  .robot-card {\n    width: 220px;\n    background: radial-gradient(circle at top left, #0f172a, #020617);\n    border-radius:16px;\n    padding:12px 14px;\n    box-shadow:0 0 18px rgba(15,23,42,0.9);\n    border:1px solid rgba(148,163,184,0.35);\n    color:#E5E7EB;\n    display:flex;\n    flex-direction:column;\n    justify-content:space-between;\n  }\n  .robot-header {\n    display:flex;\n    justify-content:space-between;\n    align-items:center;\n    margin-bottom:8px;\n  }\n  .robot-id {\n    font-weight:700;\n    font-size:16px;\n    color:#F9FAFB;\n  }\n  .state-pill {\n    padding:2px 8px;\n    border-radius:999px;\n    font-size:10px;\n    font-weight:600;\n    letter-spacing:0.5px;\n    border:1px solid rgba(148,163,184,0.5);\n  }\n  .state-pill.idle {\n    background:rgba(148,163,184,0.15);\n    border-color:#9CA3AF;\n    color:#E5E7EB;\n  }\n  .state-pill.running {\n    background:rgba(34,197,94,0.15);\n    border-color:#22C55E;\n    color:#BBF7D0;\n  }\n  .state-pill.charging {\n    background:rgba(234,179,8,0.12);\n    border-color:#EAB308;\n    color:#FEF9C3;\n  }\n  .state-pill.error, .state-pill.failed, .state-pill.fault {\n    background:rgba(239,68,68,0.16);\n    border-color:#EF4444;\n    color:#FECACA;\n  }\n  .state-pill.unknown {\n    background:rgba(59,130,246,0.12);\n    border-color:#3B82F6;\n    color:#BFDBFE;\n  }\n\n  .robot-main {\n    font-size:13px;\n    line-height:1.4;\n    margin-top:4px;\n    margin-bottom:8px;\n  }\n  .robot-main > div {\n    margin:2px 0;\n  }\n  .robot-main .error {\n    color:#FCA5A5;\n    font-size:12px;\n  }\n\n  .robot-footer {\n    display:flex;\n    justify-content:space-between;\n    font-size:10px;\n    color:#9CA3AF;\n    border-top:1px dashed rgba(55,65,81,0.8);\n    padding-top:4px;\n    margin-top:4px;\n  }\n  .robot-empty {\n    font-size:12px;\n    color:#9CA3AF;\n    padding:10px;\n  }\n</style>\n",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 870,
        "y": 2960,
        "wires": [
            []
        ]
    },
    {
        "id": "4cc056840f379311",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "Summary",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "1",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 210,
        "y": 2860,
        "wires": [
            [
                "cc62e9eae576026f"
            ]
        ]
    },
    {
        "id": "cc62e9eae576026f",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "Summary",
        "func": "// robots ìš”ì•½\nconst robots = global.get('robots') || {};\nconst taskQueue = global.get('taskQueue') || [];\n\nlet total = 0, idle = 0, running = 0, charging = 0, error = 0, others = 0;\n\nfor (const id in robots) {\n    total++;\n    const s = (robots[id].state || '').toLowerCase();\n    if (s === 'idle') idle++;\n    else if (s === 'running') running++;\n    else if (s === 'charging') charging++;\n    else if (s === 'error' || s === 'failed' || s === 'fault') error++;\n    else others++;\n}\n\nmsg.summary = { total, idle, running, charging, error, others };\n\n// tasks ìš”ì•½\nlet tTotal = taskQueue.length;\nlet tPending = 0, tRunning = 0, tDone = 0, tFailed = 0;\n\nfor (const t of taskQueue) {\n    const s = (t.status || '').toLowerCase();\n    if (s === 'pending') tPending++;\n    else if (s === 'running') tRunning++;\n    else if (s === 'done') tDone++;\n    else if (s === 'failed') tFailed++;\n}\n\nmsg.taskSummary = {\n    total: tTotal,\n    pending: tPending,\n    running: tRunning,\n    done: tDone,\n    failed: tFailed\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 2860,
        "wires": [
            [
                "74d6b228f443bd37"
            ]
        ]
    },
    {
        "id": "74d6b228f443bd37",
        "type": "ui_template",
        "z": "49f8711fc297a8c1",
        "group": "7e8e44e7110066b9",
        "name": "",
        "order": 0,
        "width": 0,
        "height": 0,
        "format": "<div class=\"dash-summary\">\n  <div class=\"summary-card total\">\n    <div class=\"label\">ROBOTS</div>\n    <div class=\"value\">{{msg.summary.total || 0}}</div>\n  </div>\n  <div class=\"summary-card idle\">\n    <div class=\"label\">IDLE</div>\n    <div class=\"value\">{{msg.summary.idle || 0}}</div>\n  </div>\n  <div class=\"summary-card running\">\n    <div class=\"label\">RUNNING</div>\n    <div class=\"value\">{{msg.summary.running || 0}}</div>\n  </div>\n  <div class=\"summary-card charging\">\n    <div class=\"label\">CHARGING</div>\n    <div class=\"value\">{{msg.summary.charging || 0}}</div>\n  </div>\n  <div class=\"summary-card error\">\n    <div class=\"label\">ERROR/OTHER</div>\n    <div class=\"value\">\n      {{(msg.summary.error || 0) + (msg.summary.others || 0)}}\n    </div>\n  </div>\n</div>\n\n<div class=\"dash-summary\" style=\"margin-top:6px;\">\n  <div class=\"summary-card task-total\">\n    <div class=\"label\">TASKS</div>\n    <div class=\"value\">{{msg.taskSummary.total || 0}}</div>\n  </div>\n  <div class=\"summary-card task-pending\">\n    <div class=\"label\">PENDING</div>\n    <div class=\"value\">{{msg.taskSummary.pending || 0}}</div>\n  </div>\n  <div class=\"summary-card task-running\">\n    <div class=\"label\">RUNNING</div>\n    <div class=\"value\">{{msg.taskSummary.running || 0}}</div>\n  </div>\n  <div class=\"summary-card task-done\">\n    <div class=\"label\">DONE</div>\n    <div class=\"value\">{{msg.taskSummary.done || 0}}</div>\n  </div>\n  <div class=\"summary-card task-failed\">\n    <div class=\"label\">FAILED</div>\n    <div class=\"value\">{{msg.taskSummary.failed || 0}}</div>\n  </div>\n</div>\n\n<style>\n  .dash-summary {\n    display:flex;\n    flex-wrap:wrap;\n    gap:16px;\n    padding:4px 0 4px 0;\n  }\n  .summary-card {\n    flex:0 0 150px;\n    background:#020617;\n    border-radius:14px;\n    padding:10px 14px;\n    box-shadow:0 0 18px rgba(0,0,0,0.45);\n    border:1px solid rgba(148,163,184,0.25);\n  }\n  .summary-card .label {\n    font-size:11px;\n    letter-spacing:1px;\n    color:#9CA3AF;\n  }\n  .summary-card .value {\n    margin-top:4px;\n    font-size:22px;\n    font-weight:700;\n    color:#F9FAFB;\n  }\n\n  .summary-card.total      { border-left:3px solid #38BDF8; }\n  .summary-card.idle       { border-left:3px solid #9CA3AF; }\n  .summary-card.running    { border-left:3px solid #22C55E; }\n  .summary-card.charging   { border-left:3px solid #EAB308; }\n  .summary-card.error      { border-left:3px solid #EF4444; }\n\n  .summary-card.task-total   { border-left:3px solid #6366F1; }\n  .summary-card.task-pending { border-left:3px solid #9CA3AF; }\n  .summary-card.task-running { border-left:3px solid #22C55E; }\n  .summary-card.task-done    { border-left:3px solid #0EA5E9; }\n  .summary-card.task-failed  { border-left:3px solid #F97316; }\n</style>\n",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 860,
        "y": 2860,
        "wires": [
            []
        ]
    },
    {
        "id": "c915a198b0c6cae3",
        "type": "ui_template",
        "z": "49f8711fc297a8c1",
        "group": "920df32220cd089d",
        "name": "",
        "order": 0,
        "width": 0,
        "height": 0,
        "format": "<div class=\"tasks-wrapper\">\n  <table class=\"tasks-table\" ng-if=\"msg.tasks && msg.tasks.length\">\n    <thead>\n      <tr>\n        <th>Task ID</th>\n        <th>Type</th>\n        <th>Target</th>\n        <th>Status</th>\n        <th>Robot</th>\n        <th>Created</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr ng-repeat=\"t in msg.tasks\">\n        <td>{{t.task_id}}</td>\n        <td>{{t.type}}</td>\n        <td>{{t.target_area}}</td>\n        <td>\n          <span class=\"task-status\" ng-class=\"(t.status || 'unknown').toLowerCase()\">\n            {{(t.status || 'unknown') | uppercase}}\n          </span>\n        </td>\n        <td>{{t.assigned_robot || '-'}}</td>\n        <td>{{t.created_at | date:'MM-dd HH:mm:ss'}}</td>\n      </tr>\n    </tbody>\n  </table>\n\n  <div ng-if=\"!msg.tasks || !msg.tasks.length\" class=\"tasks-empty\">\n    No tasks yet.\n  </div>\n</div>\n\n<style>\n  .tasks-wrapper {\n    padding-top:4px;\n  }\n  .tasks-table {\n    width:100%;\n    border-collapse:collapse;\n    font-size:12px;\n    background:#020617;\n    border-radius:10px;\n    overflow:hidden;\n    box-shadow:0 0 18px rgba(15,23,42,0.7);\n  }\n  .tasks-table thead {\n    background:linear-gradient(to right,#0f172a,#020617);\n  }\n  .tasks-table th,\n  .tasks-table td {\n    padding:6px 8px;\n    text-align:left;\n    border-bottom:1px solid rgba(30,41,59,0.9);\n    color:#E5E7EB;\n  }\n  .tasks-table th {\n    font-weight:600;\n    font-size:11px;\n    color:#9CA3AF;\n  }\n  .tasks-table tbody tr:hover {\n    background:rgba(15,23,42,0.8);\n  }\n\n  .task-status {\n    padding:2px 6px;\n    border-radius:999px;\n    font-size:10px;\n    border:1px solid rgba(148,163,184,0.4);\n  }\n  .task-status.pending {\n    background:rgba(148,163,184,0.1);\n    border-color:#9CA3AF;\n  }\n  .task-status.running {\n    background:rgba(34,197,94,0.15);\n    border-color:#22C55E;\n    color:#BBF7D0;\n  }\n  .task-status.done {\n    background:rgba(59,130,246,0.18);\n    border-color:#3B82F6;\n    color:#DBEAFE;\n  }\n  .task-status.failed {\n    background:rgba(239,68,68,0.18);\n    border-color:#EF4444;\n    color:#FECACA;\n  }\n  .task-status.unknown {\n    background:rgba(107,114,128,0.18);\n    border-color:#6B7280;\n    color:#E5E7EB;\n  }\n\n  .tasks-empty {\n    font-size:12px;\n    color:#9CA3AF;\n    padding:8px;\n  }\n</style>\n",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 880,
        "y": 3080,
        "wires": [
            []
        ]
    },
    {
        "id": "5b2975efe1ee8e3a",
        "type": "ui_template",
        "z": "49f8711fc297a8c1",
        "group": "ab2f507577ca5dbe",
        "name": "",
        "order": 0,
        "width": 0,
        "height": 0,
        "format": "<div class=\"events-wrapper\">\n  <table class=\"events-table\" ng-if=\"msg.events && msg.events.length\">\n    <thead>\n      <tr>\n        <th>Time</th>\n        <th>Type</th>\n        <th>Robot</th>\n        <th>Task</th>\n        <th>State</th>\n        <th>Area</th>\n        <th>Error</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr ng-repeat=\"e in msg.events | limitTo:50\">\n        <td>{{e.ts | date:'HH:mm:ss'}}</td>\n        <td>{{e.type}}</td>\n        <td>{{e.robot_id}}</td>\n        <td>{{e.task_id}}</td>\n        <td>{{e.state}}</td>\n        <td>{{e.area || '-'}}</td>\n        <td>{{e.error_code || '-'}}</td>\n      </tr>\n    </tbody>\n  </table>\n\n  <div ng-if=\"!msg.events || !msg.events.length\" class=\"events-empty\">\n    No events yet.\n  </div>\n</div>\n\n<style>\n  .events-wrapper {\n    padding-top:4px;\n  }\n  .events-table {\n    width:100%;\n    border-collapse:collapse;\n    font-size:11px;\n    background:#020617;\n    border-radius:10px;\n    overflow:hidden;\n    box-shadow:0 0 18px rgba(15,23,42,0.7);\n  }\n  .events-table thead {\n    background:linear-gradient(to right,#0f172a,#020617);\n  }\n  .events-table th,\n  .events-table td {\n    padding:4px 6px;\n    text-align:left;\n    border-bottom:1px solid rgba(30,41,59,0.9);\n    color:#E5E7EB;\n  }\n  .events-table th {\n    font-weight:600;\n    font-size:10px;\n    color:#9CA3AF;\n  }\n  .events-table tbody tr:hover {\n    background:rgba(15,23,42,0.8);\n  }\n  .events-empty {\n    font-size:12px;\n    color:#9CA3AF;\n    padding:8px;\n  }\n</style>\n",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 880,
        "y": 3200,
        "wires": [
            []
        ]
    },
    {
        "id": "f4058cf1557c02ec",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "Init global state",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 420,
        "y": 340,
        "wires": [
            [
                "dd5be1ad5697a1f2"
            ]
        ]
    },
    {
        "id": "dd5be1ad5697a1f2",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "initGlobalState",
        "func": "// ì „ì—­ ìƒíƒœ ê¸°ë³¸ê°’ ì„¸íŒ…\n// area -> grid ì¢Œí‘œ (Vueì˜ mapConfig.jsë‘ ë™ì¼í•˜ê²Œ ë§ì¶”ë©´ ìµœê³ )\nconst AREA_POS = {\n  BASE:  { x: 2,  y: 7 },\n  DOCK:  { x: 2,  y: 2 },\n  USER1: { x: 9,  y: 3 },\n  USER2: { x: 10, y: 6 },\n};\n\nglobal.set(\"AREA_POS\", AREA_POS);\nnode.warn(\"AREA_POS loaded\");\nreturn msg;\n\n// ì´ë¯¸ ìˆìœ¼ë©´ ìœ ì§€, ì—†ìœ¼ë©´ ìƒˆë¡œ ë§Œë“ ë‹¤\nlet robots = global.get('robots') || {};\nlet taskQueue = global.get('taskQueue') || [];\nlet events = global.get('events') || [];\n\n// agv1 ê¸°ë³¸ ì—”íŠ¸ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±\nif (!robots['agv1']) {\n    robots['agv1'] = {\n        robot_id: 'agv1',\n        state: 'idle',          // idle | running | error | charging | offline\n        task_id: null,\n        battery: 100,\n        area: 'HOME',\n        error_code: null,\n        updated_at: Date.now()\n    };\n}\n\n// ì „ì—­ì— ì €ì¥\nglobal.set('robots', robots);\nglobal.set('taskQueue', taskQueue);\nglobal.set('events', events);\n\nnode.status({ fill: \"green\", shape: \"dot\", text: \"global initialized\" });\nreturn null;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "5683f1a5e869fec8",
        "type": "mqtt in",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "robot/agv1/task",
        "qos": "2",
        "datatype": "utf8",
        "broker": "3c16a07776b27396",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 400,
        "y": 1020,
        "wires": [
            [
                "4319d8f20df90726",
                "a50e6fc76e6e8f77"
            ]
        ]
    },
    {
        "id": "4319d8f20df90726",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "simulateAGV",
        "func": "// robot/agv1/task ë¡œ ë“¤ì–´ì˜¨ Taskë¥¼ ë°›ì•„ì„œ\n// 1) running status (poseë¥¼ 200msë§ˆë‹¤ ì—…ë°ì´íŠ¸í•˜ë©° ì—¬ëŸ¬ ë²ˆ ë°œí–‰)\n// 2) 5ì´ˆ í›„ done/idle status (ë§ˆì§€ë§‰ pose í¬í•¨)\n// output1: running ìŠ¤íŠ¸ë¦¼(ì—¬ëŸ¬ ë©”ì‹œì§€), output2: done(ë”œë ˆì´ íƒ€ê³  ë‚˜ê°ˆ ì˜ˆì •)\n\nlet task;\ntry {\n    task = JSON.parse(msg.payload || '{}');\n} catch (e) {\n    node.error('Invalid task JSON in simulateAGV', msg);\n    return null;\n}\n\nconst robotId = 'agv1';\n\n// ë°°í„°ë¦¬/area/poseë¥¼ contextì—ì„œ ê´€ë¦¬\nlet battery = context.get('battery') ?? 80;\nlet area = context.get('area') || 'BASE';\n\n// poseëŠ” \"ê°€ìƒ ì¢Œí‘œ\" (grid ì¢Œí‘œê³„ float)\nlet pose = context.get('pose') || { x: 2, y: 7, theta: 0 }; // BASE ê·¼ì²˜ ê¸°ë³¸ê°’\n\n// ë°°í„°ë¦¬ ì‚´ì§ ê¹ê¸°\nbattery = Math.max(0, battery - 1);\ncontext.set('battery', battery);\n\n// ---- area ì¢Œí‘œ ë§¤í•‘ ë¡œë“œ ----\nconst AREA_POS = global.get(\"AREA_POS\") || {\n  BASE:  { x: 2,  y: 7 },\n  DOCK:  { x: 2,  y: 2 },\n  USER1: { x: 9,  y: 3 },\n  USER2: { x: 10, y: 6 },\n};\n\n// ëª©í‘œ ì§€ì  ê²°ì •: task.target_area ìš°ì„ , ì—†ìœ¼ë©´ í˜„ì¬ area ìœ ì§€\nconst targetArea = task.target_area || area;\nconst startArea = area;\nconst startPos = { x: pose.x, y: pose.y };\nconst endPos = AREA_POS[targetArea] || startPos;\n\n// heading ê³„ì‚°\nfunction heading(from, to) {\n  const dx = to.x - from.x;\n  const dy = to.y - from.y;\n  return Math.atan2(dy, dx);\n}\nfunction lerp(a, b, t) { return a + (b - a) * t; }\n\n// ---- running ìŠ¤íŠ¸ë¦¼ ìƒì„± ----\nconst DURATION_MS = 5000;\nconst STEP_MS = 200;\nconst steps = Math.max(1, Math.floor(DURATION_MS / STEP_MS));\n\nconst msgsRunning = [];\n\nfor (let i = 0; i <= steps; i++) {\n  const t = i / steps;\n  const x = lerp(startPos.x, endPos.x, t);\n  const y = lerp(startPos.y, endPos.y, t);\n  const theta = heading({x, y}, endPos);\n\n  const runningStatus = {\n    robot_id: robotId,\n    state: 'running',\n    task_id: task.task_id || null,\n    battery: battery,\n    area: startArea,          // \"í˜„ì¬ êµ¬ì—­\"ì€ í° ì˜ë¯¸ë¡œ ì‹œì‘ area ìœ ì§€ (ì›í•˜ë©´ ì¤‘ê°„ì— ë°”ê¿”ë„ ë¨)\n    target_area: targetArea,  // ëª©í‘œ êµ¬ì—­ í‘œì‹œ(Overview ë¯¸ë‹ˆë§µ ë§ˆì»¤ìš©)\n    error_code: null,\n    pose: { x, y, theta },\n    updated_at: Date.now()\n  };\n\n  msgsRunning.push({\n    topic: `robot/${robotId}/status`,\n    payload: JSON.stringify(runningStatus),\n    // Delay ë…¸ë“œê°€ \"msg.delay\"ë¥¼ ì½ë„ë¡ ì„¸íŒ… (Delay ë…¸ë“œ ì„¤ì •ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)\n    delay: i * STEP_MS\n  });\n}\n\n// ë§ˆì§€ë§‰ poseë¥¼ contextì— ì €ì¥ (ì‘ì—… ëë‚œ ìœ„ì¹˜)\npose = { x: endPos.x, y: endPos.y, theta: heading(endPos, endPos) };\ncontext.set('pose', pose);\n\n// ì‘ì—…ì´ ëë‚˜ë©´ areaë¥¼ targetAreaë¡œ ê°±ì‹ \narea = targetArea;\ncontext.set('area', area);\n\n// ---- done/idle ë©”ì‹œì§€ ì¤€ë¹„ ----\nconst doneStatus = {\n    robot_id: robotId,\n    state: 'idle',\n    task_id: task.task_id || null,\n    battery: battery,\n    area: area,\n    target_area: null,\n    error_code: null,\n    pose: { x: endPos.x, y: endPos.y, theta: heading(startPos, endPos) },\n    updated_at: Date.now()\n};\n\nlet msgDone = {\n    topic: `robot/${robotId}/status`,\n    payload: JSON.stringify(doneStatus)\n};\n\n// output1: running ìŠ¤íŠ¸ë¦¼(ì—¬ëŸ¬ ë©”ì‹œì§€), output2: done(ë”œë ˆì´ íƒ€ê³  ë‚˜ê°ˆ ì˜ˆì •)\nreturn [msgsRunning, msgDone];\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 1020,
        "wires": [
            [
                "241f54b35e15895f"
            ],
            [
                "c892835546595db4"
            ]
        ]
    },
    {
        "id": "e5f2fa78b4c8f5b4",
        "type": "mqtt out",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3c16a07776b27396",
        "x": 970,
        "y": 1020,
        "wires": []
    },
    {
        "id": "5462d48ba72465a3",
        "type": "mqtt out",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3c16a07776b27396",
        "x": 970,
        "y": 1100,
        "wires": []
    },
    {
        "id": "c892835546595db4",
        "type": "delay",
        "z": "49f8711fc297a8c1",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 820,
        "y": 1100,
        "wires": [
            [
                "5462d48ba72465a3",
                "d79424313dccb2f0"
            ]
        ]
    },
    {
        "id": "a50e6fc76e6e8f77",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 3",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 580,
        "y": 1140,
        "wires": []
    },
    {
        "id": "d79424313dccb2f0",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 4",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1100,
        "y": 1220,
        "wires": []
    },
    {
        "id": "0e18ed358d9967fb",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 5",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1260,
        "y": 1100,
        "wires": []
    },
    {
        "id": "9a5002eb64eee3d0",
        "type": "http in",
        "z": "49f8711fc297a8c1",
        "name": "GET /api/robots",
        "url": "/api/robots",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 400,
        "y": 1440,
        "wires": [
            [
                "1099aa542425c508"
            ]
        ]
    },
    {
        "id": "1099aa542425c508",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "buildRobotsResponse",
        "func": "// // global.robotsë¥¼ ì½ì–´ì„œ API ì‘ë‹µ í˜•íƒœë¡œ ë§Œë“¤ì–´ì£¼ëŠ” í•¨ìˆ˜\n\n// const robotsObj = global.get('robots') || {};\n// const robotsArr = [];\n\n// // ê°ì²´ â†’ ë°°ì—´ë¡œ ë³€í™˜\n// for (const id in robotsObj) {\n//     const r = robotsObj[id] || {};\n//     robotsArr.push(r);\n// }\n\n// // JSON ì‘ë‹µ í˜•íƒœ ì„¸íŒ…\n// msg.payload = {\n//     robots: robotsArr\n// };\n\n// // í—¤ë”ì— JSONì´ë¼ê³  ëª…ì‹œ\n// msg.headers = {\n//     'Content-Type': 'application/json'\n// };\n\n// return msg;\n\nconst db = global.get(\"db\");\nif (!db) {\n  msg.statusCode = 503;\n  msg.headers = { \"Content-Type\": \"application/json\" };\n  msg.payload = { error: \"firestore not ready\" };\n  return msg;\n}\n\nconst limit = Math.min(parseInt((msg.req?.query?.limit ?? \"100\"), 10) || 100, 500);\n\nreturn new Promise(async (resolve) => {\n  try {\n    // updated_at ê¸°ì¤€ ìµœì‹ ìˆœ (í•„ë“œ ì—†ìœ¼ë©´ ì¸ë±ìŠ¤/ì •ë ¬ ì´ìŠˆ ê°€ëŠ¥)\n    let q = db.collection(\"robots\");\n\n    // orderByëŠ” í•„ë“œê°€ ì•ˆì •ì ìœ¼ë¡œ ë“¤ì–´ê°€ì•¼ í•¨. ì•ˆ ë“¤ì–´ê°„ ë¬¸ì„œê°€ ìˆìœ¼ë©´ ì •ë ¬ì—ì„œ ë¹ ì§ˆ ìˆ˜ ìˆìŒ.\n    // ë„ˆ updateStatusì—ì„œ updated_atì„ í•­ìƒ ë„£ê³  ìˆì–´ì„œ OK. :contentReference[oaicite:2]{index=2}\n    q = q.orderBy(\"updated_at\", \"desc\").limit(limit);\n\n    const snap = await q.get();\n    const robots = snap.docs.map(d => d.data());\n\n    msg.statusCode = 200;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { robots };\n    resolve(msg);\n  } catch (err) {\n    node.error(err);\n    msg.statusCode = 500;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { error: \"failed to fetch robots\", detail: String(err?.message || err) };\n    resolve(msg);\n  }\n});",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 1440,
        "wires": [
            [
                "04c572829db161a8"
            ]
        ]
    },
    {
        "id": "04c572829db161a8",
        "type": "http response",
        "z": "49f8711fc297a8c1",
        "name": "res /api/robots",
        "statusCode": "",
        "headers": {},
        "x": 900,
        "y": 1440,
        "wires": []
    },
    {
        "id": "cf9e4d5c0ec26f3f",
        "type": "http in",
        "z": "49f8711fc297a8c1",
        "name": "GET /api/tasks",
        "url": "/api/tasks",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 400,
        "y": 1520,
        "wires": [
            [
                "4db69741e35d7aaa"
            ]
        ]
    },
    {
        "id": "4db69741e35d7aaa",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "buildTasksResponse",
        "func": "// let tasks = global.get('taskQueue') || [];\n\n// // ìµœì‹ ìˆœ ì •ë ¬ (Vueì—ì„œ ë³´ê¸° ì¢‹ê²Œ)\n// tasks = tasks.slice().sort((a, b) => (b.created_at || 0) - (a.created_at || 0));\n\n// msg.payload = { tasks };\n// msg.headers = { \"Content-Type\": \"application/json\" };\n// return msg;\n\nconst db = global.get(\"db\");\nif (!db) {\n  msg.statusCode = 503;\n  msg.headers = { \"Content-Type\": \"application/json\" };\n  msg.payload = { error: \"firestore not ready\" };\n  return msg;\n}\n\nconst q = msg.req?.query || {};\nconst status = (q.status || \"\").toString().trim(); // pending|running|done|failed ë“±\nconst limit = Math.min(parseInt((q.limit ?? \"50\"), 10) || 50, 500);\n\nreturn new Promise(async (resolve) => {\n  try {\n    let ref = db.collection(\"tasks\");\n\n    // status í•„í„° (ì˜µì…˜)\n    if (status) {\n      ref = ref.where(\"status\", \"==\", status);\n      // where + orderBy ì¡°í•© ì‹œ ì¸ë±ìŠ¤ í•„ìš”í•  ìˆ˜ ìˆìŒ (ì—ëŸ¬ ë©”ì‹œì§€ì— ìƒì„± ë§í¬ ë‚˜ì˜´)\n    }\n\n    // created_at ìµœì‹ ìˆœ\n    ref = ref.orderBy(\"created_at\", \"desc\").limit(limit);\n\n    const snap = await ref.get();\n    const tasks = snap.docs.map(d => d.data());\n\n    msg.statusCode = 200;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { tasks };\n    resolve(msg);\n  } catch (err) {\n    node.error(err);\n    msg.statusCode = 500;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { error: \"failed to fetch tasks\", detail: String(err?.message || err) };\n    resolve(msg);\n  }\n});\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 1520,
        "wires": [
            [
                "bd552ae11c61fc7b"
            ]
        ]
    },
    {
        "id": "bd552ae11c61fc7b",
        "type": "http response",
        "z": "49f8711fc297a8c1",
        "name": "res /api/tasks",
        "statusCode": "",
        "headers": {},
        "x": 910,
        "y": 1520,
        "wires": []
    },
    {
        "id": "3dc12e5ce8d5567e",
        "type": "http in",
        "z": "49f8711fc297a8c1",
        "name": "GET /api/events",
        "url": "/api/events",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 400,
        "y": 1600,
        "wires": [
            [
                "47eeabd70b7c449b"
            ]
        ]
    },
    {
        "id": "47eeabd70b7c449b",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "buildEventsResponse",
        "func": "// let events = global.get('events') || [];\n\n// // ìµœì‹ ìˆœ ì •ë ¬\n// events = events.slice().sort((a, b) => (b.ts || 0) - (a.ts || 0));\n\n// msg.payload = { events };\n// msg.headers = { \"Content-Type\": \"application/json\" };\n// return msg;\n\nconst db = global.get(\"db\");\nif (!db) {\n  msg.statusCode = 503;\n  msg.headers = { \"Content-Type\": \"application/json\" };\n  msg.payload = { error: \"firestore not ready\" };\n  return msg;\n}\n\nconst limit = Math.min(parseInt((msg.req?.query?.limit ?? \"50\"), 10) || 50, 500);\n\nreturn new Promise(async (resolve) => {\n  try {\n    const snap = await db\n      .collection(\"events\")\n      .orderBy(\"ts\", \"desc\")\n      .limit(limit)\n      .get();\n\n    const events = snap.docs.map(d => d.data());\n\n    msg.statusCode = 200;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { events };\n    resolve(msg);\n  } catch (err) {\n    node.error(err);\n    msg.statusCode = 500;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { error: \"failed to fetch events\", detail: String(err?.message || err) };\n    resolve(msg);\n  }\n});\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 1600,
        "wires": [
            [
                "14173b48771091af"
            ]
        ]
    },
    {
        "id": "14173b48771091af",
        "type": "http response",
        "z": "49f8711fc297a8c1",
        "name": "res /api/events",
        "statusCode": "",
        "headers": {},
        "x": 920,
        "y": 1600,
        "wires": []
    },
    {
        "id": "aae26e35525d4347",
        "type": "http in",
        "z": "49f8711fc297a8c1",
        "name": "GET /api/summary",
        "url": "/api/summary",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 410,
        "y": 1680,
        "wires": [
            [
                "3252b669c8d4ee2a"
            ]
        ]
    },
    {
        "id": "3252b669c8d4ee2a",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "buildSummaryResponse",
        "func": "// const robots = global.get('robots') || {};\n// const tasks = global.get('taskQueue') || [];\n\n// let total = 0, idle = 0, running = 0, charging = 0, error = 0, others = 0;\n// for (const id in robots) {\n//     total++;\n//     const s = (robots[id].state || '').toLowerCase();\n//     if (s === 'idle') idle++;\n//     else if (s === 'running') running++;\n//     else if (s === 'charging') charging++;\n//     else if (s === 'error' || s === 'failed' || s === 'fault') error++;\n//     else others++;\n// }\n\n// let tTotal = tasks.length;\n// let tPending = 0, tRunning = 0, tDone = 0, tFailed = 0;\n// for (const t of tasks) {\n//     const s = (t.status || '').toLowerCase();\n//     if (s === 'pending') tPending++;\n//     else if (s === 'running') tRunning++;\n//     else if (s === 'done') tDone++;\n//     else if (s === 'failed') tFailed++;\n// }\n\n// msg.payload = {\n//     robots: { total, idle, running, charging, error, others },\n//     tasks:  { total: tTotal, pending: tPending, running: tRunning, done: tDone, failed: tFailed }\n// };\n// msg.headers = { \"Content-Type\": \"application/json\" };\n// return msg;\n\nconst db = global.get(\"db\");\nif (!db) {\n  msg.statusCode = 503;\n  msg.headers = { \"Content-Type\": \"application/json\" };\n  msg.payload = { error: \"firestore not ready\" };\n  return msg;\n}\n\nconst q = msg.req?.query || {};\nconst taskLimit = Math.min(parseInt((q.taskLimit ?? \"200\"), 10) || 200, 1000);\n\nfunction countBy(list, keyFn) {\n  const m = {};\n  for (const x of list) {\n    const k = (keyFn(x) || \"unknown\").toLowerCase();\n    m[k] = (m[k] || 0) + 1;\n  }\n  return m;\n}\n\nreturn new Promise(async (resolve) => {\n  try {\n    // 1) robots ì „ë¶€ ì½ì–´ì„œ ìƒíƒœ ì¹´ìš´íŠ¸\n    const robotsSnap = await db.collection(\"robots\").get();\n    const robots = robotsSnap.docs.map(d => d.data());\n    const robotCounts = countBy(robots, r => r.state);\n\n    const robotSummary = {\n      total: robots.length,\n      idle: robotCounts.idle || 0,\n      running: robotCounts.running || 0,\n      charging: robotCounts.charging || 0,\n      error: (robotCounts.error || 0) + (robotCounts.failed || 0) + (robotCounts.fault || 0),\n      others:\n        (robotCounts.offline || 0) +\n        (robotCounts.unknown || 0)\n    };\n\n    // 2) tasksëŠ” ìµœê·¼ Nê°œë§Œ ì½ì–´ì„œ ìƒíƒœ ì¹´ìš´íŠ¸ (Phase 0 ê°€ë²¼ìš´ ì§‘ê³„)\n    const tasksSnap = await db\n      .collection(\"tasks\")\n      .orderBy(\"created_at\", \"desc\")\n      .limit(taskLimit)\n      .get();\n\n    const tasks = tasksSnap.docs.map(d => d.data());\n    const taskCounts = countBy(tasks, t => t.status);\n\n    const taskSummary = {\n      total: tasks.length,\n      pending: taskCounts.pending || 0,\n      running: taskCounts.running || 0,\n      done: taskCounts.done || 0,\n      failed: taskCounts.failed || 0\n    };\n\n    msg.statusCode = 200;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { robots: robotSummary, tasks: taskSummary, meta: { taskLimit } };\n    resolve(msg);\n  } catch (err) {\n    node.error(err);\n    msg.statusCode = 500;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { error: \"failed to fetch summary\", detail: String(err?.message || err) };\n    resolve(msg);\n  }\n});\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 1680,
        "wires": [
            [
                "bb5bd9f96e8e8313"
            ]
        ]
    },
    {
        "id": "bb5bd9f96e8e8313",
        "type": "http response",
        "z": "49f8711fc297a8c1",
        "name": "res /api/summary",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 1680,
        "wires": []
    },
    {
        "id": "a90b7ad07ef61884",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "FIrestore Client Init",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 430,
        "y": 240,
        "wires": [
            [
                "f1509788aad45a75"
            ]
        ]
    },
    {
        "id": "f1509788aad45a75",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "Init Firestore",
        "func": "// admin, fs ëŠ” Function ë…¸ë“œ Setup(Modules)ì—ì„œ ì£¼ì…ë°›ëŠ”ë‹¤ê³  ê°€ì •\n\nconst keyPath = \"C:/Users/wp3wk/AppData/Roaming/SPB_Data/.node-red/agv-pjt2-firebase-adminsdk-fbsvc-18055a3bd9.json\";\n\n// 0) ì„œë¹„ìŠ¤ ê³„ì • íŒŒì¼ ì¡´ì¬ í™•ì¸\nif (!fs.existsSync(keyPath)) {\n  node.error(\"âŒ Service account json not found: \" + keyPath);\n  return null;\n}\n\nconst serviceAccount = JSON.parse(fs.readFileSync(keyPath, \"utf8\"));\n\n// 1) ê¸°ì¡´ firebase-admin ì•±ì´ ìˆìœ¼ë©´ ì œê±° (í”„ë¡œì íŠ¸ ë³€ê²½ ì‹œ í•„ìˆ˜)\nif (admin.apps && admin.apps.length > 0) {\n  return admin.app().delete().then(() => {\n    node.warn(\"â™»ï¸ Old firebase app deleted. Re-initializing...\");\n    return init();\n  }).catch(err => {\n    node.error(\"âŒ Failed to delete old firebase app: \" + err.message);\n    return null;\n  });\n}\n\n// 2) ì‹¤ì œ ì´ˆê¸°í™” í•¨ìˆ˜\nfunction init() {\n  admin.initializeApp({\n    credential: admin.credential.cert(serviceAccount),\n  });\n\n  const db = admin.firestore();\n\n  global.set(\"admin\", admin);\n  global.set(\"db\", db);\n  global.set(\"firestoreReady\", true);\n\n  // 3) healthcheck write (ì„±ê³µ ì—¬ë¶€ ëª…í™•íˆ í™•ì¸)\n  return db.collection(\"_healthcheck\").doc(\"init\").set({\n    ts: Date.now(),\n    project_id: serviceAccount.project_id,\n  }).then(() => {\n    node.warn(\"âœ… Firestore initialized!\");\n    node.warn(\"ğŸ‘‰ project_id = \" + serviceAccount.project_id);\n    return null;\n  }).catch(err => {\n    node.error(\"âŒ Firestore healthcheck write failed: \" + err.message);\n    return null;\n  });\n}\n\nreturn init();\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "admin",
                "module": "firebase-admin"
            },
            {
                "var": "fs",
                "module": "fs"
            }
        ],
        "x": 670,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "2ccacb1608c5ba74",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "FS : write task (create)",
        "func": "const db = global.get(\"db\");\nif (!db) {\n    node.warn(\"Firestore not ready - skip write\");\n    return msg;\n}\n\nconst task = msg.task;\nif (!task || !task.task_id) return msg;\n\ndb.collection(\"tasks\").doc(task.task_id).set(task, { merge: true })\n    .then(() => node.warn(`FS task created: ${task.task_id}`))\n    .catch(err => node.error(err));\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 720,
        "wires": [
            [
                "8fa070ba704430fc"
            ]
        ]
    },
    {
        "id": "58d8d616da6872e1",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "FS: update task (assigned)",
        "func": "const db = global.get(\"db\");\nif (!db) return msg;\n\nconst task = msg.task;\nif (!task || !task.task_id) return msg;\n\ndb.collection(\"tasks\").doc(task.task_id).set(task, { merge: true })\n    .then(() => node.warn(`FS task assigned: ${task.task_id}`))\n    .catch(err => node.error(err));\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1120,
        "y": 720,
        "wires": [
            [
                "c02ac5399c925f84"
            ]
        ]
    },
    {
        "id": "241f54b35e15895f",
        "type": "delay",
        "z": "49f8711fc297a8c1",
        "name": "",
        "pauseType": "delay",
        "timeout": "200",
        "timeoutUnits": "milliseconds",
        "rate": "2",
        "nbRateUnits": "",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": true,
        "outputs": 1,
        "x": 870,
        "y": 960,
        "wires": [
            [
                "e5f2fa78b4c8f5b4",
                "0e18ed358d9967fb"
            ]
        ]
    },
    {
        "id": "54431a46252d1602",
        "type": "http request",
        "z": "49f8711fc297a8c1",
        "name": "",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://gms.ssafy.io/gmsapi/api.openai.com/v1/chat/completions",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1010,
        "y": 480,
        "wires": [
            [
                "7dea3543f230c5e1",
                "fd22aea86440924f"
            ]
        ]
    },
    {
        "id": "c301115701d2a789",
        "type": "mqtt out",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3c16a07776b27396",
        "x": 1510,
        "y": 500,
        "wires": []
    },
    {
        "id": "1f3be0f0cf23a955",
        "type": "telegram sender",
        "z": "49f8711fc297a8c1",
        "name": "",
        "bot": "d10c4415b361b866",
        "haserroroutput": false,
        "outputs": 1,
        "x": 1530,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "7dea3543f230c5e1",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "LLMValidate",
        "func": "const chatId = msg._tg?.chatId;\nconst raw = msg._tg?.raw || \"\";\n\nfunction makeReply(content) {\n  return { payload: { chatId, type: \"message\", content } };\n}\n\n// content êº¼ë‚´ê¸°\nlet content = msg.payload?.choices?.[0]?.message?.content || \"\";\n\n// JSONë§Œ ì¶”ì¶œ\nfunction extractJson(text) {\n  if (!text) return null;\n  text = text.replace(/```json\\s*/g, \"\").replace(/```\\s*/g, \"\").trim();\n  const s = text.indexOf(\"{\");\n  const e = text.lastIndexOf(\"}\");\n  if (s === -1 || e === -1 || e <= s) return null;\n  return text.slice(s, e + 1);\n}\n\nconst jsonStr = extractJson(content);\nif (!jsonStr) return [makeReply(\"ì£„ì†¡í•´ìš” ğŸ˜¥ ìš”ì²­ì„ ì´í•´í•˜ì§€ ëª»í–ˆì–´ìš”. ë²„íŠ¼ìœ¼ë¡œ ë‹¤ì‹œ í•´ì£¼ì„¸ìš”.\"), null];\n\nlet parsed;\ntry { parsed = JSON.parse(jsonStr); }\ncatch { return [makeReply(\"ì£„ì†¡í•´ìš” ğŸ˜¥ ìš”ì²­ í•´ì„ ê²°ê³¼ê°€ ê¹¨ì¡Œì–´ìš”. ë²„íŠ¼ìœ¼ë¡œ ë‹¤ì‹œ í•´ì£¼ì„¸ìš”.\"), null]; }\n\n// allow-list\nconst ALLOW_TYPE = new Set([\"deliver_water\", \"collect_cup\", \"collect_laundry\"]);\nconst ALLOW_AREA = new Set([\"USER1\", \"USER2\", \"DOCK\", \"BASE\"]);\n\nconst type = parsed.type;\nlet area = parsed.target_area;\n\n// typeì€ ë°˜ë“œì‹œ ìˆì–´ì•¼ í•¨\nif (!ALLOW_TYPE.has(type)) {\n  return [makeReply(\"ë¬´ìŠ¨ ìš”ì²­ì¸ì§€ íŒë‹¨í•˜ì§€ ëª»í–ˆì–´ìš” ğŸ˜¥\\në²„íŠ¼ìœ¼ë¡œ ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.\"), null];\n}\n\n// âœ… default area fallback (ì„ì‹œ: flowì— ì €ì¥, ì—†ìœ¼ë©´ USER1)\nlet defaultArea = flow.get(\"default_area_\" + chatId);\nif (!defaultArea) defaultArea = \"USER1\";\n\n// âœ… areaê°€ ì—†ê±°ë‚˜ ì´ìƒí•˜ë©´ defaultë¡œ ì±„ì›€\nif (!ALLOW_AREA.has(area)) {\n  area = defaultArea;\n}\n\n// topic ê²°ì •\nconst topic =\n  type === \"deliver_water\" ? \"cmd/water/request\" :\n  type === \"collect_cup\" ? \"cmd/cup/request\" :\n  \"cmd/laundry/request\";\n\n// mqtt\nconst mqttMsg = {\n  topic,\n  payload: JSON.stringify({\n    type,\n    target_area: area,\n    user_id: `tg_${chatId}`,\n    meta: { source: \"telegram\", input: \"text\", raw, default_area_used: !parsed.target_area }\n  })\n};\n\nconst pretty =\n  type === \"deliver_water\" ? \"ë¬¼ ë°°ë‹¬\" :\n  type === \"collect_cup\" ? \"ì»µ ìˆ˜ê±°\" : \"ì„¸íƒë¬¼ ìˆ˜ê±°\";\n\nconst usedMsg = (!parsed.target_area) ? ` (ê¸°ë³¸ ìœ„ì¹˜: ${area})` : \"\";\nreturn [makeReply(`âœ… ${pretty} ìš”ì²­ì„ ì ‘ìˆ˜í–ˆì–´ìš”!${usedMsg}`), mqttMsg];\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1250,
        "y": 480,
        "wires": [
            [
                "1f3be0f0cf23a955"
            ],
            [
                "c301115701d2a789"
            ]
        ]
    },
    {
        "id": "fd22aea86440924f",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 6",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1160,
        "y": 540,
        "wires": []
    },
    {
        "id": "d10c4415b361b866",
        "type": "telegram bot",
        "botname": "yujinnnojin",
        "usernames": "",
        "chatids": "",
        "baseapiurl": "",
        "testenvironment": false,
        "updatemode": "polling",
        "pollinterval": 300,
        "usesocks": false,
        "sockshost": "",
        "socksprotocol": "socks5",
        "socksport": 6667,
        "socksusername": "anonymous",
        "sockspassword": "",
        "bothost": "",
        "botpath": "",
        "localbothost": "0.0.0.0",
        "localbotport": 8443,
        "publicbotport": 8443,
        "privatekey": "",
        "certificate": "",
        "useselfsignedcertificate": false,
        "sslterminated": false,
        "verboselogging": false
    },
    {
        "id": "3c16a07776b27396",
        "type": "mqtt-broker",
        "name": "Server",
        "broker": "localhost",
        "port": 1883,
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": 4,
        "keepalive": 60,
        "cleansession": true,
        "autoUnsubscribe": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthRetain": "false",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closeRetain": "false",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willRetain": "false",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "e6e1b7942a2b8330",
        "type": "ui_group",
        "name": "Robots",
        "tab": "8949e4e33e605647",
        "order": 2,
        "disp": true,
        "width": 6,
        "collapse": false,
        "className": ""
    },
    {
        "id": "7e8e44e7110066b9",
        "type": "ui_group",
        "name": "Summary",
        "tab": "8949e4e33e605647",
        "order": 1,
        "disp": true,
        "width": 6,
        "collapse": false,
        "className": ""
    },
    {
        "id": "920df32220cd089d",
        "type": "ui_group",
        "name": "Tasks",
        "tab": "8949e4e33e605647",
        "order": 3,
        "disp": true,
        "width": 6,
        "collapse": false,
        "className": ""
    },
    {
        "id": "ab2f507577ca5dbe",
        "type": "ui_group",
        "name": "Events",
        "tab": "8949e4e33e605647",
        "order": 4,
        "disp": true,
        "width": 6,
        "collapse": false,
        "className": ""
    },
    {
        "id": "8949e4e33e605647",
        "type": "ui_tab",
        "name": "AGV Control Center",
        "icon": "dashboard",
        "order": 1,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "2ed468cba4100726",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-telegrambot": "17.0.3",
            "node-red-dashboard": "3.6.6"
        }
    }
]