[
    {
        "id": "7476d3bed8965c26",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "function 1",
        "func": "function pad(n, w = 2) { return String(n).padStart(w, '0'); }\n\n// KST ê¸°ì¤€: YYYYMMDD_HHMMSS_mmm\nfunction tsKST() {\n  const k = new Date(Date.now() + 9 * 60 * 60 * 1000); // UTC+9\n  const y = k.getUTCFullYear();\n  const mo = pad(k.getUTCMonth() + 1);\n  const d = pad(k.getUTCDate());\n  const hh = pad(k.getUTCHours());\n  const mm = pad(k.getUTCMinutes());\n  const ss = pad(k.getUTCSeconds());\n  const ms = pad(k.getUTCMilliseconds(), 3);\n  return `${y}${mo}${d}_${hh}${mm}${ss}_${ms}`;\n}\n\nfunction makeInteractionId(chatId, mode) {\n  const ts = tsKST();\n  const safeMode = (mode || \"text\").toLowerCase();\n  return `it_${ts}_tg_${chatId}_${safeMode}`;\n}\n\nfunction makeMqtt(chatId, text, interactionId, topic, type, target_area, inputKind) {\n  return {\n    topic,\n    payload: JSON.stringify({\n      type,\n      target_area,\n      user_id: `tg_${chatId}`,\n      meta: { source: \"telegram\", input: inputKind, raw: text, interaction_id: interactionId }\n    })\n  };\n}\n\nfunction makeFsMsg(interactionObj) {\n  // task_idëŠ” null ë®ì–´ì“°ê¸° ë°©ì§€(ì•„ì˜ˆ ì œê±°)\n  const copy = { ...interactionObj };\n  if (\"task_id\" in copy) delete copy.task_id;\n  return { payload: copy };\n}\n\nfunction makeInteractionBase(chatId, interactionId, inputMode, rawInput) {\n  return {\n    ts: Date.now(),\n    interaction_id: interactionId,\n    source: \"telegram\",\n    user_id: `tg_${chatId}`,\n    input_mode: inputMode,\n    raw_input: rawInput,\n    parsed: null,\n    result: \"pending\",\n    error: null\n  };\n}\n\n// -------------------- ì…ë ¥ ì¶”ì¶œ --------------------\nconst chatId = msg.payload?.chatId;\nconst text = (msg.payload?.content || \"\").trim();\n\n// WebApp URL\nconst WEBAPP_URL = global.get(\"WEBAPP_URL\") || \"https://subaru-pod-visit-woods.trycloudflare.com/user\";\n\n// ë²„íŠ¼ ëª©ë¡(ì •í™•íˆ ë§¤ì¹­)\nconst BUTTONS = new Set([\n  \"â˜• ë¬¼ ê°€ì ¸ì™€ì¤˜\",\n  \"ğŸ¥¤ ì»µ ê°€ì ¸ê°€ì¤˜\",\n  \"ğŸ§¹ í™˜ê²½ ì •ë¦¬í•´ì¤˜\",\n  \"ğŸ“ ì§€ê¸ˆ ìƒíƒœ ì•Œë ¤ì¤˜\",\n  \"ğŸ“Š ë¦¬í¬íŠ¸ & ëŒ€ì‹œë³´ë“œ ì—´ê¸°\"\n]);\n\n// -------------------- 0) voice (ê°€ì¥ ë¨¼ì € return) --------------------\nif (msg.payload?.type === \"voice\" && msg.payload?.weblink) {\n  const interactionId = makeInteractionId(chatId, \"voice\");\n  msg._interactionId = interactionId;\n\n  const weblink = msg.payload.weblink;\n  const fileId = msg.payload.content;\n\n  const interaction = makeInteractionBase(chatId, interactionId, \"voice\", fileId);\n  interaction.meta = { weblink };\n\n  const tgMsg = {\n    ...msg,\n    payload: { chatId, type: \"message\", content: \"ğŸ™ï¸ ìŒì„± ì¸ì‹ ì¤‘ì´ì—ìš”â€¦\", options: {} }\n  };\n\n  const sttMsg = {\n    _tg: { chatId },\n    _interactionId: interactionId,\n    weblink\n  };\n\n  // out1: tg, out4: fs, out5: stt\n  return [tgMsg, null, null, makeFsMsg(interaction), sttMsg];\n}\n\n// -------------------- 1) ë¹ˆ ì…ë ¥ --------------------\nif (!text) {\n  const interactionId = makeInteractionId(chatId, \"text\");\n  msg._interactionId = interactionId;\n\n  const interaction = makeInteractionBase(chatId, interactionId, \"text\", text);\n  interaction.result = \"rejected\";\n  interaction.error = { stage: \"input\", message: \"empty text\" };\n\n  msg.payload = {\n    chatId, type: \"message\",\n    content: \"ë‚´ìš©ì´ ë¹„ì–´ ìˆì–´ìš” ğŸ™‚\\nì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ìš”ì²­í•´ ì£¼ì„¸ìš”.\",\n    options: {}\n  };\n  return [msg, null, null, makeFsMsg(interaction)];\n}\n\n// -------------------- 2) /start --------------------\nif (text === \"/start\") {\n  const interactionId = makeInteractionId(chatId, \"command\");\n  msg._interactionId = interactionId;\n\n  if (!flow.get(\"default_area_\" + chatId)) flow.set(\"default_area_\" + chatId, \"USER1\");\n\n  const interaction = makeInteractionBase(chatId, interactionId, \"command\", text);\n  interaction.result = \"accepted\";\n\n  msg.payload = {\n    chatId,\n    type: \"message\",\n    content: \"ì•ˆë…•í•˜ì„¸ìš”! AGV ì„œë¹„ìŠ¤ ë´‡ í˜„ì„±ì´ì…ë‹ˆë‹¤.\\në¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?\",\n    options: {\n      reply_markup: {\n        keyboard: [\n          [\"â˜• ë¬¼ ê°€ì ¸ì™€ì¤˜\", \"ğŸ¥¤ ì»µ ê°€ì ¸ê°€ì¤˜\"],\n          [\"ğŸ§¹ í™˜ê²½ ì •ë¦¬í•´ì¤˜\"],\n          [\"ğŸ“ ì§€ê¸ˆ ìƒíƒœ ì•Œë ¤ì¤˜\", \"ğŸ“Š ë¦¬í¬íŠ¸ & ëŒ€ì‹œë³´ë“œ ì—´ê¸°\"]\n        ],\n        resize_keyboard: true,\n        one_time_keyboard: false\n      }\n    }\n  };\n\n  return [msg, null, null, makeFsMsg(interaction)];\n}\n\n// -------------------- 3) button --------------------\nif (BUTTONS.has(text)) {\n  const interactionId = makeInteractionId(chatId, \"button\");\n  msg._interactionId = interactionId;\n\n  const interaction = makeInteractionBase(chatId, interactionId, \"button\", text);\n\n  // ê¸°ë³¸ íƒ€ê²Ÿ(ì§€ê¸ˆì€ USER1 ê³ ì •, ë‚˜ì¤‘ì— default_areaë¡œ ë°”ê¿”ë„ ë¨)\n  const area = \"USER1\";\n\n  // ë²„íŠ¼ë³„ ì²˜ë¦¬\n  if (text === \"â˜• ë¬¼ ê°€ì ¸ì™€ì¤˜\") {\n    interaction.parsed = { type: \"deliver_water\", target_area: area, confidence: 1.0 };\n    interaction.result = \"accepted\";\n\n    const mqttMsg = makeMqtt(chatId, text, interactionId, \"cmd/water/request\", \"deliver_water\", area, \"button\");\n\n    msg.payload = {\n      chatId, type: \"message\",\n      content: \"ë¬¼ ë°°ë‹¬ ìš”ì²­ì„ ì ‘ìˆ˜í–ˆì–´ìš” ğŸ’§\\nê¸ˆë°© ê°–ë‹¤ë“œë¦´ê²Œìš”!\",\n      options: {}\n    };\n\n    return [msg, mqttMsg, null, makeFsMsg(interaction)];\n  }\n\n  if (text === \"ğŸ¥¤ ì»µ ê°€ì ¸ê°€ì¤˜\") {\n    interaction.parsed = { type: \"collect_cup\", target_area: area, confidence: 1.0 };\n    interaction.result = \"accepted\";\n\n    const mqttMsg = makeMqtt(chatId, text, interactionId, \"cmd/cup/request\", \"collect_cup\", area, \"button\");\n\n    msg.payload = {\n      chatId, type: \"message\",\n      content: \"ì»µ íšŒìˆ˜ ìš”ì²­ì„ ì ‘ìˆ˜í–ˆì–´ìš” ğŸ¥¤\\në°”ë¡œ ì²˜ë¦¬í• ê²Œìš”!\",\n      options: {}\n    };\n\n    return [msg, mqttMsg, null, makeFsMsg(interaction)];\n  }\n\n  if (text === \"ğŸ§¹ í™˜ê²½ ì •ë¦¬í•´ì¤˜\") {\n    // ë‚´ë¶€ typeì€ ê¸°ì¡´ ìœ ì§€(collect_laundry)\n    interaction.parsed = { type: \"collect_laundry\", target_area: area, confidence: 1.0 };\n    interaction.result = \"accepted\";\n\n    const mqttMsg = makeMqtt(chatId, text, interactionId, \"cmd/laundry/request\", \"collect_laundry\", area, \"button\");\n\n    msg.payload = {\n      chatId, type: \"message\",\n      content: \"í™˜ê²½ ì •ë¦¬ ìš”ì²­ì„ ì ‘ìˆ˜í–ˆì–´ìš” ğŸ§¹\\nì£¼ë³€ì„ ê¹”ë”í•˜ê²Œ ì •ë¦¬í• ê²Œìš”!\",\n      options: {}\n    };\n\n    return [msg, mqttMsg, null, makeFsMsg(interaction)];\n  }\n\n  if (text === \"ğŸ“ ì§€ê¸ˆ ìƒíƒœ ì•Œë ¤ì¤˜\") {\n    interaction.parsed = { type: \"show_status\", target_area: null, confidence: 1.0 };\n    interaction.result = \"accepted\";\n\n    const robots = global.get(\"robots\") || {};\n    const taskQueue = global.get(\"taskQueue\") || [];\n    const r = robots[\"agv1\"];\n\n    if (!r) {\n      msg.payload = {\n        chatId,\n        type: \"message\",\n        content: \"ğŸ“ ì•„ì§ AGV ìƒíƒœë¥¼ ëª» ë°›ì•˜ì–´ìš”.\\n(ë¡œë´‡ status ìˆ˜ì‹  í™•ì¸ í•„ìš”)\",\n        options: {}\n      };\n      return [msg, null, null, makeFsMsg(interaction)];\n    }\n\n    const AREA_LABEL = { BASE: \"ë² ì´ìŠ¤\", DOCK: \"ë„í‚¹\", USER1: \"ì‚¬ìš©ì êµ¬ì—­ 1\", USER2: \"ì‚¬ìš©ì êµ¬ì—­ 2\" };\n    const TASK_LABEL = { deliver_water: \"â˜• ë¬¼ ë°°ë‹¬\", collect_cup: \"ğŸ¥¤ ì»µ íšŒìˆ˜\", collect_laundry: \"ğŸ§¹ í™˜ê²½ ì •ë¦¬\" };\n\n    function areaName(a) { return AREA_LABEL[a] || a || \"â€”\"; }\n\n    const state = (r.state || \"unknown\").toLowerCase();\n    const prettyState =\n      (r.error_code) ? \"ì˜¤ë¥˜ â—\" :\n        (state === \"running\") ? \"ì´ë™ ì¤‘ ğŸšš\" :\n          (state === \"idle\") ? \"ëŒ€ê¸° ì¤‘ âœ…\" :\n            (state === \"charging\") ? \"ì¶©ì „ ì¤‘ ğŸ”Œ\" : state;\n\n    // í˜„ì¬ task ì°¾ê¸°: robot.task_id ìš°ì„ \n    let t = null;\n    if (r.task_id) t = taskQueue.find(x => x.task_id === r.task_id) || null;\n    if (!t) t = taskQueue.find(x => x.assigned_robot === \"agv1\" && x.status === \"running\") || null;\n\n    const lines = [];\n    lines.push(`ğŸ“ AGV ìƒíƒœ: ${prettyState}`);\n    if (r.battery != null) lines.push(`ğŸ”‹ ë°°í„°ë¦¬: ${r.battery}%`);\n    if (r.area) lines.push(`ğŸ“Œ ìœ„ì¹˜: ${areaName(r.area)}`);\n    if (r.error_code) lines.push(`âš ï¸ ì›ì¸: ${r.error_code}`);\n\n    if (!t) {\n      lines.push(\"\");\n      lines.push(\"ğŸ§¾ ì§„í–‰ ì¤‘ ì‘ì—…: ì—†ìŒ\");\n    } else {\n      const label = TASK_LABEL[t.type] || t.type || \"ì‘ì—…\";\n      const target = areaName(t.target_area);\n\n      // ë‚¨ì€ì‹œê°„ ê³„ì‚° (ë²„íŠ¼ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ 20â†’15ì²˜ëŸ¼ ê°ì†Œ)\n      const expectedMs = Number(t.expected_duration_ms || 0);\n      const startedAt = Number(t.started_at || t.created_at || 0);\n      let remainSec = null;\n\n      if (expectedMs > 0 && startedAt > 0 && (state === \"running\" || t.status === \"running\")) {\n        const elapsedMs = Date.now() - startedAt;\n        const remainMs = Math.max(0, expectedMs - elapsedMs);\n        remainSec = Math.ceil(remainMs / 1000);\n      } else if (expectedMs > 0) {\n        remainSec = Math.ceil(expectedMs / 1000); // ì•„ì§ running ì „ì´ë©´ \"ì˜ˆìƒ\"ë§Œ í‘œì‹œ\n      }\n\n      lines.push(\"\");\n      lines.push(`ğŸ§¾ ì§„í–‰ ì¤‘ ì‘ì—…: ${label} â†’ ${target}`);\n      if (remainSec != null) lines.push(`â³ ì˜ˆìƒ ë‚¨ì€ ì‹œê°„: ì•½ ${remainSec}ì´ˆ`);\n    }\n\n    msg.payload = {\n      chatId,\n      type: \"message\",\n      content: lines.join(\"\\n\"),\n      options: {}\n    };\n\n    return [msg, null, null, makeFsMsg(interaction)];\n  }\n\n\n  if (text === \"ğŸ“Š ë¦¬í¬íŠ¸ & ëŒ€ì‹œë³´ë“œ ì—´ê¸°\") {\n    interaction.parsed = { type: \"open_dashboard\", target_area: null, confidence: 1.0 };\n    interaction.result = \"accepted\";\n\n    msg.payload = {\n      chatId,\n      type: \"message\",\n      content: \"ğŸ“Š ë¦¬í¬íŠ¸ & ëŒ€ì‹œë³´ë“œë¥¼ ì—´ì–´ë“œë¦´ê²Œìš” ğŸ™‚\",\n      options: {\n        reply_markup: {\n          inline_keyboard: [[\n            { text: \"ì—´ê¸°\", web_app: { url: WEBAPP_URL } }\n          ]]\n        }\n      }\n    };\n\n    return [msg, null, null, makeFsMsg(interaction)];\n  }\n}\n\n// -------------------- 4) ê·¸ ì™¸ = text â†’ LLM --------------------\n{\n  const interactionId = makeInteractionId(chatId, \"text\");\n  msg._interactionId = interactionId;\n\n  const interaction = makeInteractionBase(chatId, interactionId, \"text\", text);\n  interaction.result = \"pending\";\n\n  msg.payload = {\n    chatId,\n    type: \"message\",\n    content: \"ìš”ì²­ì„ í™•ì¸í•˜ê³  ìˆì–´ìš” ğŸ¤–\\nì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.\",\n    options: {}\n  };\n\n  const llmReq = {\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"Authorization\": `Bearer ${global.get(\"GMS_KEY\")}`\n    },\n    payload: {\n      model: \"gpt-4.1-nano\",\n      temperature: 0.2,\n      max_tokens: 200,\n      messages: [\n        {\n          role: \"system\",\n          content:\n            \"ë„ˆëŠ” AGV ì‚¬ìš©ì ì•±ì˜ ëª…ë ¹ íŒŒì„œë‹¤. ë°˜ë“œì‹œ JSONë§Œ ì¶œë ¥í•´.\\n\" +\n            \"í—ˆìš© type: deliver_water, collect_cup, collect_laundry\\n\" +\n            \"í—ˆìš© target_area: USER1, USER2, DOCK, BASE\\n\" +\n            \"ì‚¬ìš©ì í‘œí˜„ 'í™˜ê²½ ì •ë¦¬/ë°”ë‹¥ ì •ë¦¬/ì •ë¦¬í•´ì¤˜' ëŠ” collect_laundryë¡œ ë§¤í•‘í•´.\\n\" +\n            'í˜•ì‹: {\"type\":\"...\",\"target_area\":\"...\",\"confidence\":0.0}\\n' +\n            \"ì¶”ë¡  ì„¤ëª… ê¸ˆì§€. JSON ì™¸ í…ìŠ¤íŠ¸ ê¸ˆì§€.\"\n        },\n        { role: \"user\", content: text }\n      ]\n    },\n    _tg: { chatId, raw: text },\n    _interactionId: interactionId\n  };\n\n  // out1: tg reply, out3: llm, out4: fs\n  return [msg, null, llmReq, makeFsMsg(interaction)];\n}\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 480,
        "wires": [
            [
                "d1e13ead5e796c2d"
            ],
            [
                "6b5f1a99de2569f0"
            ],
            [
                "54431a46252d1602"
            ],
            [
                "350dfce793e04058"
            ],
            [
                "f65016bb2f2505ba"
            ]
        ]
    }
]