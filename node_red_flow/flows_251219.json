[
    {
        "id": "f2b669875e6c945e",
        "type": "tab",
        "label": "ÌîåÎ°úÏö∞ 1",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "49f8711fc297a8c1",
        "type": "tab",
        "label": "ÌîåÎ°úÏö∞ 1",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "d10c4415b361b866",
        "type": "telegram bot",
        "botname": "yujinnnojin",
        "usernames": "",
        "chatids": "",
        "baseapiurl": "",
        "testenvironment": false,
        "updatemode": "polling",
        "pollinterval": 300,
        "usesocks": false,
        "sockshost": "",
        "socksprotocol": "socks5",
        "socksport": 6667,
        "socksusername": "anonymous",
        "sockspassword": "",
        "bothost": "",
        "botpath": "",
        "localbothost": "0.0.0.0",
        "localbotport": 8443,
        "publicbotport": 8443,
        "privatekey": "",
        "certificate": "",
        "useselfsignedcertificate": false,
        "sslterminated": false,
        "verboselogging": false
    },
    {
        "id": "3c16a07776b27396",
        "type": "mqtt-broker",
        "name": "Server",
        "broker": "localhost",
        "port": 1883,
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": 4,
        "keepalive": 60,
        "cleansession": true,
        "autoUnsubscribe": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthRetain": "false",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closeRetain": "false",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willRetain": "false",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "8949e4e33e605647",
        "type": "ui_tab",
        "name": "AGV Control Center",
        "icon": "dashboard",
        "order": 1,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "e6e1b7942a2b8330",
        "type": "ui_group",
        "name": "Robots",
        "tab": "8949e4e33e605647",
        "order": 2,
        "disp": true,
        "width": 6,
        "collapse": false,
        "className": ""
    },
    {
        "id": "7e8e44e7110066b9",
        "type": "ui_group",
        "name": "Summary",
        "tab": "8949e4e33e605647",
        "order": 1,
        "disp": true,
        "width": 6,
        "collapse": false,
        "className": ""
    },
    {
        "id": "920df32220cd089d",
        "type": "ui_group",
        "name": "Tasks",
        "tab": "8949e4e33e605647",
        "order": 3,
        "disp": true,
        "width": 6,
        "collapse": false,
        "className": ""
    },
    {
        "id": "ab2f507577ca5dbe",
        "type": "ui_group",
        "name": "Events",
        "tab": "8949e4e33e605647",
        "order": 4,
        "disp": true,
        "width": 6,
        "collapse": false,
        "className": ""
    },
    {
        "id": "2c0b413ab733893e",
        "type": "ui_base",
        "theme": {
            "name": "theme-light",
            "lightTheme": {
                "default": "#0094CE",
                "baseColor": "#0094CE",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": true,
                "reset": false
            },
            "darkTheme": {
                "default": "#097479",
                "baseColor": "#097479",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": false
            },
            "customTheme": {
                "name": "Untitled Theme 1",
                "default": "#4B7930",
                "baseColor": "#4B7930",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
            },
            "themeState": {
                "base-color": {
                    "default": "#0094CE",
                    "value": "#0094CE",
                    "edited": false
                },
                "page-titlebar-backgroundColor": {
                    "value": "#0094CE",
                    "edited": false
                },
                "page-backgroundColor": {
                    "value": "#fafafa",
                    "edited": false
                },
                "page-sidebar-backgroundColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "group-textColor": {
                    "value": "#1bbfff",
                    "edited": false
                },
                "group-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "group-backgroundColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "widget-textColor": {
                    "value": "#111111",
                    "edited": false
                },
                "widget-backgroundColor": {
                    "value": "#0094ce",
                    "edited": false
                },
                "widget-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "base-font": {
                    "value": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
                }
            },
            "angularTheme": {
                "primary": "indigo",
                "accents": "blue",
                "warn": "red",
                "background": "grey",
                "palette": "light"
            }
        },
        "site": {
            "name": "Node-RED Dashboard",
            "hideToolbar": "false",
            "allowSwipe": "false",
            "lockMenu": "false",
            "allowTempTheme": "true",
            "dateFormat": "DD/MM/YYYY",
            "sizes": {
                "sx": 48,
                "sy": 48,
                "gx": 6,
                "gy": 6,
                "cx": 6,
                "cy": 6,
                "px": 0,
                "py": 0
            }
        }
    },
    {
        "id": "048a808c4f50c1eb",
        "type": "telegram receiver",
        "z": "49f8711fc297a8c1",
        "name": "",
        "bot": "d10c4415b361b866",
        "saveDataDir": "",
        "filterCommands": false,
        "hasinput": false,
        "inputs": 0,
        "handleallupdates": false,
        "x": 350,
        "y": 480,
        "wires": [
            [
                "7476d3bed8965c26"
            ],
            []
        ]
    },
    {
        "id": "d1e13ead5e796c2d",
        "type": "telegram sender",
        "z": "49f8711fc297a8c1",
        "name": "",
        "bot": "d10c4415b361b866",
        "haserroroutput": false,
        "outputs": 1,
        "x": 1170,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "7476d3bed8965c26",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "function 1",
        "func": "function pad(n, w = 2) { return String(n).padStart(w, '0'); }\n\n// KST Í∏∞Ï§Ä: YYYYMMDD_HHMMSS_mmm\nfunction tsKST() {\n  const k = new Date(Date.now() + 9 * 60 * 60 * 1000); // UTC+9\n  const y = k.getUTCFullYear();\n  const mo = pad(k.getUTCMonth() + 1);\n  const d = pad(k.getUTCDate());\n  const hh = pad(k.getUTCHours());\n  const mm = pad(k.getUTCMinutes());\n  const ss = pad(k.getUTCSeconds());\n  const ms = pad(k.getUTCMilliseconds(), 3);\n  return `${y}${mo}${d}_${hh}${mm}${ss}_${ms}`;\n}\n\nfunction makeInteractionId(chatId, mode) {\n  const ts = tsKST();\n  const safeMode = (mode || \"text\").toLowerCase();\n  return `it_${ts}_tg_${chatId}_${safeMode}`;\n}\n\nfunction makeMqtt(chatId, text, interactionId, topic, type, target_area, inputKind) {\n  return {\n    topic,\n    payload: JSON.stringify({\n      type,\n      target_area,\n      user_id: `tg_${chatId}`,\n      meta: { source: \"telegram\", input: inputKind, raw: text, interaction_id: interactionId }\n    })\n  };\n}\n\nfunction makeFsMsg(interactionObj) {\n  // task_idÎäî null ÎçÆÏñ¥Ïì∞Í∏∞ Î∞©ÏßÄ(ÏïÑÏòà Ï†úÍ±∞)\n  const copy = { ...interactionObj };\n  if (\"task_id\" in copy) delete copy.task_id;\n  return { payload: copy };\n}\n\nfunction makeInteractionBase(chatId, interactionId, inputMode, rawInput) {\n  return {\n    ts: Date.now(),\n    interaction_id: interactionId,\n    source: \"telegram\",\n    user_id: `tg_${chatId}`,\n    input_mode: inputMode,\n    raw_input: rawInput,\n    parsed: null,\n    result: \"pending\",\n    error: null\n  };\n}\n\n// -------------------- ÏûÖÎ†• Ï∂îÏ∂ú --------------------\nconst chatId = msg.payload?.chatId;\nconst text = (msg.payload?.content || \"\").trim();\n\n// WebApp URL\nconst WEBAPP_URL = global.get(\"WEBAPP_URL\") || \"https://commander-emily-hop-linux.trycloudflare.com/user\";\n\n// Î≤ÑÌäº Î™©Î°ù(Ï†ïÌôïÌûà Îß§Ïπ≠)\nconst BUTTONS = new Set([\n  \"‚òï Î¨º Í∞ÄÏ†∏ÏôÄÏ§ò\",\n  \"ü•§ Ïªµ Í∞ÄÏ†∏Í∞ÄÏ§ò\",\n  \"üßπ ÌôòÍ≤Ω Ï†ïÎ¶¨Ìï¥Ï§ò\",\n  \"üìç ÏßÄÍ∏à ÏÉÅÌÉú ÏïåÎ†§Ï§ò\",\n  \"üìä Î¶¨Ìè¨Ìä∏ & ÎåÄÏãúÎ≥¥Îìú Ïó¥Í∏∞\"\n]);\n\n// -------------------- 0) voice (Í∞ÄÏû• Î®ºÏ†Ä return) --------------------\nif (msg.payload?.type === \"voice\" && msg.payload?.weblink) {\n  const interactionId = makeInteractionId(chatId, \"voice\");\n  msg._interactionId = interactionId;\n\n  const weblink = msg.payload.weblink;\n  const fileId = msg.payload.content;\n\n  const interaction = makeInteractionBase(chatId, interactionId, \"voice\", fileId);\n  interaction.meta = { weblink };\n\n  const tgMsg = {\n    ...msg,\n    payload: { chatId, type: \"message\", content: \"üéôÔ∏è ÏùåÏÑ± Ïù∏Ïãù Ï§ëÏù¥ÏóêÏöî‚Ä¶\", options: {} }\n  };\n\n  const sttMsg = {\n    _tg: { chatId },\n    _interactionId: interactionId,\n    weblink\n  };\n\n  // out1: tg, out4: fs, out5: stt\n  return [tgMsg, null, null, makeFsMsg(interaction), sttMsg];\n}\n\n// -------------------- 1) Îπà ÏûÖÎ†• --------------------\nif (!text) {\n  const interactionId = makeInteractionId(chatId, \"text\");\n  msg._interactionId = interactionId;\n\n  const interaction = makeInteractionBase(chatId, interactionId, \"text\", text);\n  interaction.result = \"rejected\";\n  interaction.error = { stage: \"input\", message: \"empty text\" };\n\n  msg.payload = {\n    chatId, type: \"message\",\n    content: \"ÎÇ¥Ïö©Ïù¥ ÎπÑÏñ¥ ÏûàÏñ¥Ïöî üôÇ\\nÏïÑÎûò Î≤ÑÌäºÏùÑ ÎàåÎü¨ÏÑú ÏöîÏ≤≠Ìï¥ Ï£ºÏÑ∏Ïöî.\",\n    options: {}\n  };\n  return [msg, null, null, makeFsMsg(interaction)];\n}\n\n// -------------------- 2) /start --------------------\nif (text === \"/start\") {\n  const interactionId = makeInteractionId(chatId, \"command\");\n  msg._interactionId = interactionId;\n\n  if (!flow.get(\"default_area_\" + chatId)) flow.set(\"default_area_\" + chatId, \"USER1\");\n\n  const interaction = makeInteractionBase(chatId, interactionId, \"command\", text);\n  interaction.result = \"accepted\";\n\n  msg.payload = {\n    chatId,\n    type: \"message\",\n    content: \"ÏïàÎÖïÌïòÏÑ∏Ïöî! AGV ÏÑúÎπÑÏä§ Î¥á ÌòÑÏÑ±Ïù¥ÏûÖÎãàÎã§.\\nÎ¨¥ÏóáÏùÑ ÎèÑÏôÄÎìúÎ¶¥ÍπåÏöî?\",\n    options: {\n      reply_markup: {\n        keyboard: [\n          [\"‚òï Î¨º Í∞ÄÏ†∏ÏôÄÏ§ò\", \"ü•§ Ïªµ Í∞ÄÏ†∏Í∞ÄÏ§ò\"],\n          [\"üßπ ÌôòÍ≤Ω Ï†ïÎ¶¨Ìï¥Ï§ò\"],\n          [\"üìç ÏßÄÍ∏à ÏÉÅÌÉú ÏïåÎ†§Ï§ò\", \"üìä Î¶¨Ìè¨Ìä∏ & ÎåÄÏãúÎ≥¥Îìú Ïó¥Í∏∞\"]\n        ],\n        resize_keyboard: true,\n        one_time_keyboard: false\n      }\n    }\n  };\n\n  return [msg, null, null, makeFsMsg(interaction)];\n}\n\n// -------------------- 3) button --------------------\nif (BUTTONS.has(text)) {\n  const interactionId = makeInteractionId(chatId, \"button\");\n  msg._interactionId = interactionId;\n\n  const interaction = makeInteractionBase(chatId, interactionId, \"button\", text);\n\n  // Í∏∞Î≥∏ ÌÉÄÍ≤ü(ÏßÄÍ∏àÏùÄ USER1 Í≥†Ï†ï, ÎÇòÏ§ëÏóê default_areaÎ°ú Î∞îÍøîÎèÑ Îê®)\n  const area = \"USER1\";\n\n  // Î≤ÑÌäºÎ≥Ñ Ï≤òÎ¶¨\n  if (text === \"‚òï Î¨º Í∞ÄÏ†∏ÏôÄÏ§ò\") {\n    interaction.parsed = { type: \"deliver_water\", target_area: area, confidence: 1.0 };\n    interaction.result = \"accepted\";\n\n    const mqttMsg = makeMqtt(chatId, text, interactionId, \"cmd/water/request\", \"deliver_water\", area, \"button\");\n\n    msg.payload = {\n      chatId, type: \"message\",\n      content: \"Î¨º Î∞∞Îã¨ ÏöîÏ≤≠ÏùÑ Ï†ëÏàòÌñàÏñ¥Ïöî üíß\\nÍ∏àÎ∞© Í∞ñÎã§ÎìúÎ¶¥Í≤åÏöî!\",\n      options: {}\n    };\n\n    return [msg, mqttMsg, null, makeFsMsg(interaction)];\n  }\n\n  if (text === \"ü•§ Ïªµ Í∞ÄÏ†∏Í∞ÄÏ§ò\") {\n    interaction.parsed = { type: \"collect_cup\", target_area: area, confidence: 1.0 };\n    interaction.result = \"accepted\";\n\n    const mqttMsg = makeMqtt(chatId, text, interactionId, \"cmd/cup/request\", \"collect_cup\", area, \"button\");\n\n    msg.payload = {\n      chatId, type: \"message\",\n      content: \"Ïªµ ÌöåÏàò ÏöîÏ≤≠ÏùÑ Ï†ëÏàòÌñàÏñ¥Ïöî ü•§\\nÎ∞îÎ°ú Ï≤òÎ¶¨Ìï†Í≤åÏöî!\",\n      options: {}\n    };\n\n    return [msg, mqttMsg, null, makeFsMsg(interaction)];\n  }\n\n  if (text === \"üßπ ÌôòÍ≤Ω Ï†ïÎ¶¨Ìï¥Ï§ò\") {\n    // ÎÇ¥Î∂Ä typeÏùÄ Í∏∞Ï°¥ Ïú†ÏßÄ(collect_laundry)\n    interaction.parsed = { type: \"collect_laundry\", target_area: area, confidence: 1.0 };\n    interaction.result = \"accepted\";\n\n    const mqttMsg = makeMqtt(chatId, text, interactionId, \"cmd/laundry/request\", \"collect_laundry\", area, \"button\");\n\n    msg.payload = {\n      chatId, type: \"message\",\n      content: \"ÌôòÍ≤Ω Ï†ïÎ¶¨ ÏöîÏ≤≠ÏùÑ Ï†ëÏàòÌñàÏñ¥Ïöî üßπ\\nÏ£ºÎ≥ÄÏùÑ ÍπîÎÅîÌïòÍ≤å Ï†ïÎ¶¨Ìï†Í≤åÏöî!\",\n      options: {}\n    };\n\n    return [msg, mqttMsg, null, makeFsMsg(interaction)];\n  }\n\n  if (text === \"üìç ÏßÄÍ∏à ÏÉÅÌÉú ÏïåÎ†§Ï§ò\") {\n    interaction.parsed = { type: \"show_status\", target_area: null, confidence: 1.0 };\n    interaction.result = \"accepted\";\n\n    const robots = global.get(\"robots\") || {};\n    const taskQueue = global.get(\"taskQueue\") || [];\n    const r = robots[\"agv1\"];\n\n    if (!r) {\n      msg.payload = {\n        chatId,\n        type: \"message\",\n        content: \"üìç ÏïÑÏßÅ AGV ÏÉÅÌÉúÎ•º Î™ª Î∞õÏïòÏñ¥Ïöî.\\n(Î°úÎ¥á status ÏàòÏã† ÌôïÏù∏ ÌïÑÏöî)\",\n        options: {}\n      };\n      return [msg, null, null, makeFsMsg(interaction)];\n    }\n\n    const AREA_LABEL = { BASE: \"Î≤†Ïù¥Ïä§\", DOCK: \"ÎèÑÌÇπ\", USER1: \"ÏÇ¨Ïö©Ïûê Íµ¨Ïó≠ 1\", USER2: \"ÏÇ¨Ïö©Ïûê Íµ¨Ïó≠ 2\" };\n    const TASK_LABEL = { deliver_water: \"‚òï Î¨º Î∞∞Îã¨\", collect_cup: \"ü•§ Ïªµ ÌöåÏàò\", collect_laundry: \"üßπ ÌôòÍ≤Ω Ï†ïÎ¶¨\" };\n\n    function areaName(a) { return AREA_LABEL[a] || a || \"‚Äî\"; }\n\n    const state = (r.state || \"unknown\").toLowerCase();\n    const prettyState =\n      (r.error_code) ? \"Ïò§Î•ò ‚ùó\" :\n        (state === \"running\") ? \"Ïù¥Îèô Ï§ë üöö\" :\n          (state === \"idle\") ? \"ÎåÄÍ∏∞ Ï§ë ‚úÖ\" :\n            (state === \"charging\") ? \"Ï∂©Ï†Ñ Ï§ë üîå\" : state;\n\n    // ÌòÑÏû¨ task Ï∞æÍ∏∞: robot.task_id Ïö∞ÏÑ†\n    let t = null;\n    if (r.task_id) t = taskQueue.find(x => x.task_id === r.task_id) || null;\n    if (!t) t = taskQueue.find(x => x.assigned_robot === \"agv1\" && x.status === \"running\") || null;\n\n    const lines = [];\n    lines.push(`üìç AGV ÏÉÅÌÉú: ${prettyState}`);\n    if (r.battery != null) lines.push(`üîã Î∞∞ÌÑ∞Î¶¨: ${r.battery}%`);\n    if (r.area) lines.push(`üìå ÏúÑÏπò: ${areaName(r.area)}`);\n    if (r.error_code) lines.push(`‚ö†Ô∏è ÏõêÏù∏: ${r.error_code}`);\n\n    if (!t) {\n      lines.push(\"\");\n      lines.push(\"üßæ ÏßÑÌñâ Ï§ë ÏûëÏóÖ: ÏóÜÏùå\");\n    } else {\n      const label = TASK_LABEL[t.type] || t.type || \"ÏûëÏóÖ\";\n      const target = areaName(t.target_area);\n\n      // ÎÇ®ÏùÄÏãúÍ∞Ñ Í≥ÑÏÇ∞ (Î≤ÑÌäº ÎàÑÎ•º ÎïåÎßàÎã§ 20‚Üí15Ï≤òÎüº Í∞êÏÜå)\n      const expectedMs = Number(t.expected_duration_ms || 0);\n      const startedAt = Number(t.started_at || t.created_at || 0);\n      let remainSec = null;\n\n      if (expectedMs > 0 && startedAt > 0 && (state === \"running\" || t.status === \"running\")) {\n        const elapsedMs = Date.now() - startedAt;\n        const remainMs = Math.max(0, expectedMs - elapsedMs);\n        remainSec = Math.ceil(remainMs / 1000);\n      } else if (expectedMs > 0) {\n        remainSec = Math.ceil(expectedMs / 1000); // ÏïÑÏßÅ running Ï†ÑÏù¥Î©¥ \"ÏòàÏÉÅ\"Îßå ÌëúÏãú\n      }\n\n      lines.push(\"\");\n      lines.push(`üßæ ÏßÑÌñâ Ï§ë ÏûëÏóÖ: ${label} ‚Üí ${target}`);\n      if (remainSec != null) lines.push(`‚è≥ ÏòàÏÉÅ ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ÏïΩ ${remainSec}Ï¥à`);\n    }\n\n    msg.payload = {\n      chatId,\n      type: \"message\",\n      content: lines.join(\"\\n\"),\n      options: {}\n    };\n\n    return [msg, null, null, makeFsMsg(interaction)];\n  }\n\n\n  if (text === \"üìä Î¶¨Ìè¨Ìä∏ & ÎåÄÏãúÎ≥¥Îìú Ïó¥Í∏∞\") {\n    interaction.parsed = { type: \"open_dashboard\", target_area: null, confidence: 1.0 };\n    interaction.result = \"accepted\";\n\n    msg.payload = {\n      chatId,\n      type: \"message\",\n      content: \"üìä Î¶¨Ìè¨Ìä∏ & ÎåÄÏãúÎ≥¥ÎìúÎ•º Ïó¥Ïñ¥ÎìúÎ¶¥Í≤åÏöî üôÇ\",\n      options: {\n        reply_markup: {\n          inline_keyboard: [[\n            { text: \"Ïó¥Í∏∞\", web_app: { url: WEBAPP_URL } }\n          ]]\n        }\n      }\n    };\n\n    return [msg, null, null, makeFsMsg(interaction)];\n  }\n}\n\n// -------------------- 4) Í∑∏ Ïô∏ = text ‚Üí LLM --------------------\n{\n  const interactionId = makeInteractionId(chatId, \"text\");\n  msg._interactionId = interactionId;\n\n  const interaction = makeInteractionBase(chatId, interactionId, \"text\", text);\n  interaction.result = \"pending\";\n\n  msg.payload = {\n    chatId,\n    type: \"message\",\n    content: \"ÏöîÏ≤≠ÏùÑ ÌôïÏù∏ÌïòÍ≥† ÏûàÏñ¥Ïöî ü§ñ\\nÏû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.\",\n    options: {}\n  };\n\n  const llmReq = {\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"Authorization\": `Bearer ${global.get(\"GMS_KEY\")}`\n    },\n    payload: {\n      model: \"gpt-4.1-nano\",\n      temperature: 0.2,\n      max_tokens: 200,\n      messages: [\n        {\n          role: \"system\",\n          content:\n            \"ÎÑàÎäî AGV ÏÇ¨Ïö©Ïûê Ïï±Ïùò Î™ÖÎ†π ÌååÏÑúÎã§. Î∞òÎìúÏãú JSONÎßå Ï∂úÎ†•Ìï¥.\\n\" +\n            \"ÌóàÏö© type: deliver_water, collect_cup, collect_laundry\\n\" +\n            \"ÌóàÏö© target_area: USER1, USER2, DOCK, BASE\\n\" +\n            \"ÏÇ¨Ïö©Ïûê ÌëúÌòÑ 'ÌôòÍ≤Ω Ï†ïÎ¶¨/Î∞îÎã• Ï†ïÎ¶¨/Ï†ïÎ¶¨Ìï¥Ï§ò' Îäî collect_laundryÎ°ú Îß§ÌïëÌï¥.\\n\" +\n            'ÌòïÏãù: {\"type\":\"...\",\"target_area\":\"...\",\"confidence\":0.0}\\n' +\n            \"Ï∂îÎ°† ÏÑ§Î™Ö Í∏àÏßÄ. JSON Ïô∏ ÌÖçÏä§Ìä∏ Í∏àÏßÄ.\"\n        },\n        { role: \"user\", content: text }\n      ]\n    },\n    _tg: { chatId, raw: text },\n    _interactionId: interactionId\n  };\n\n  // out1: tg reply, out3: llm, out4: fs\n  return [msg, null, llmReq, makeFsMsg(interaction)];\n}\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 480,
        "wires": [
            [
                "d1e13ead5e796c2d"
            ],
            [
                "6b5f1a99de2569f0"
            ],
            [
                "54431a46252d1602"
            ],
            [
                "350dfce793e04058"
            ],
            [
                "f65016bb2f2505ba"
            ]
        ]
    },
    {
        "id": "6b5f1a99de2569f0",
        "type": "mqtt out",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3c16a07776b27396",
        "x": 1130,
        "y": 320,
        "wires": []
    },
    {
        "id": "bea82cdd7f9e1fa3",
        "type": "mqtt in",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "cmd/+/request",
        "qos": "2",
        "datatype": "utf8",
        "broker": "3c16a07776b27396",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 350,
        "y": 1120,
        "wires": [
            [
                "e0253ffdf7c81394",
                "084632d493b02014"
            ]
        ]
    },
    {
        "id": "e0253ffdf7c81394",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "function 2",
        "func": "function pad(n, w=2){ return String(n).padStart(w,'0'); }\n\n// KST Í∏∞Ï§Ä ÌÖçÏä§Ìä∏ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏÉùÏÑ±\nfunction tsKST() {\n  const k = new Date(Date.now() + 9*60*60*1000); // UTC+9\n  const y = k.getUTCFullYear();\n  const mo = pad(k.getUTCMonth()+1);\n  const d = pad(k.getUTCDate());\n  const hh = pad(k.getUTCHours());\n  const mm = pad(k.getUTCMinutes());\n  const ss = pad(k.getUTCSeconds());\n  const ms = pad(k.getUTCMilliseconds(), 3);\n  return `${y}${mo}${d}_${hh}${mm}${ss}_${ms}`; // 20251216_000305_123\n}\n\nlet data = {};\ntry {\n    data = JSON.parse(msg.payload || '{}');\n} catch (e) {\n    node.error('Invalid JSON payload in cmd request', msg);\n    return null;\n}\n\n// ‚úÖ interaction_id Ï∂îÏ∂ú (telegram/llmÏóêÏÑú metaÎ°ú ÎÑ£Ïñ¥Ï§Ä Í∞í)\nconst interactionId = data?.meta?.interaction_id || null;\n\n// Í∏ÄÎ°úÎ≤å taskQueue Í∞ÄÏ†∏Ïò§Í∏∞ (ÏóÜÏúºÎ©¥ Îπà Î∞∞Ïó¥)\nlet queue = global.get('taskQueue') || [];\n\n// task_id ÏÉùÏÑ±\nconst ts = tsKST();\nconst area = (data.target_area || 'USER1').toUpperCase();\nconst typeForId = (data.type || 'unknown').toLowerCase(); // ÌòπÏùÄ taskType Í≥ÑÏÇ∞ Ïù¥ÌõÑ ÏÇ¨Ïö©Ìï¥ÎèÑ Îê®\n\nconst taskId = interactionId;   // ‚úÖ task_id = interaction_id\n\n// type Í≤∞Ï†ï\nconst taskType = data.type || (() => {\n    if (msg.topic.startsWith('cmd/water/')) \n        return 'deliver_water';\n    if (msg.topic.startsWith('cmd/cup/')) \n        return 'collect_cup';\n    if (msg.topic.startsWith('cmd/laundry/')) \n        return 'collect_laundry';\n    return 'unknown';\n})();\n\n// Task Í∞ùÏ≤¥ (v0.1)\nconst task = {\n    task_id: taskId,\n    type: taskType,\n    target_area: data.target_area || 'USER1',\n    user_id: data.user_id || null,\n\n    // ‚úÖ Ïó∞Í≤∞ ÌÇ§\n    interaction_id: interactionId,\n\n    status: 'pending',\n    created_at: Date.now(),\n};\n\n// ---- ÏòàÏÉÅ ÏÜåÏöîÏãúÍ∞Ñ(ms) : EMAÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏Í±∏ Ïì∞Í≥†, ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í ----\nconst taskStats = global.get(\"taskStats\") || {};        // { deliver_water: { ema_ms, n }, ... }\nconst baseMsMap = { deliver_water: 20000, collect_cup: 15000, collect_laundry: 25000, unknown: 20000 };\n\nconst stat = taskStats[taskType];\nconst expectedMs = (stat && stat.ema_ms) ? Math.round(stat.ema_ms) : (baseMsMap[taskType] || 20000);\n\ntask.expected_duration_ms = expectedMs;\ntask.expected_duration_s = Math.ceil(expectedMs / 1000);\ntask.eta_basis = (stat && stat.ema_ms) ? \"ema\" : \"default\";\n\n// ÌÅêÏóê push\nqueue.push(task);\nglobal.set('taskQueue', queue);\n\n// ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏\nnode.warn({ action: 'TASK_CREATED', task });\n\n// ‚úÖ interaction Î¨∏ÏÑúÏóê task_id backfill (ÏóÖÏÑúÌä∏)\nconst db = global.get(\"db\");\nif (db && interactionId) {\n    db.collection(\"interactions\").doc(interactionId).set({\n        task_id: taskId,\n        linked_at: Date.now()\n    }, { merge: true })\n    .then(() => node.warn(`FS interaction linked: ${interactionId} -> ${taskId}`))\n    .catch(err => node.error(err));\n}\n\n// ÏïÑÎûòÎ°ú ÎÑòÍ≤®Ï§Ñ Î©îÏãúÏßÄ ÏÑ∏ÌåÖ\nmsg.task = task;\nmsg.payload = JSON.stringify(task);\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 1120,
        "wires": [
            [
                "2ccacb1608c5ba74"
            ]
        ]
    },
    {
        "id": "8fa070ba704430fc",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "function 3",
        "func": "// v0.1: Îì§Ïñ¥Ïò® taskÎ•º Î¨¥Ï°∞Í±¥ agv1Ïóê Î∞îÎ°ú Ìï†ÎãπÌï¥ÏÑú Î≥¥ÎÉÑ\n\nlet task = msg.task;\nif (!task) {\n    node.warn('No task found in msg');\n    return null;\n}\n\n// ÏÉÅÌÉú Î≥ÄÍ≤Ω\ntask.status = 'running';\ntask.assigned_robot = 'agv1';\ntask.started_at = Date.now();\n\n// Í∏ÄÎ°úÎ≤å ÌÅêÏóêÎèÑ Î∞òÏòÅ\nlet queue = global.get('taskQueue') || [];\nfor (let i = 0; i < queue.length; i++) {\n    if (queue[i].task_id === task.task_id) {\n        queue[i] = task;\n        break;\n    }\n}\nglobal.set('taskQueue', queue);\n\n// ÎîîÎ≤ÑÍ∑∏Ïö©\nnode.warn({ action: 'TASK_ASSIGNED', task: task });\n\n// Ïù¥ msgÎ•º mqtt outÏúºÎ°ú Î≥¥ÎÇº Ï§ÄÎπÑ\nmsg.topic = 'robot/agv1/task';\nmsg.payload = JSON.stringify(task);\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1400,
        "y": 1120,
        "wires": [
            [
                "58d8d616da6872e1"
            ]
        ]
    },
    {
        "id": "c02ac5399c925f84",
        "type": "mqtt out",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3c16a07776b27396",
        "x": 2090,
        "y": 1120,
        "wires": []
    },
    {
        "id": "084632d493b02014",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 520,
        "y": 1140,
        "wires": []
    },
    {
        "id": "a8cdfef7f11748d6",
        "type": "mqtt in",
        "z": "49f8711fc297a8c1",
        "name": "robot status",
        "topic": "robot/+/status",
        "qos": "2",
        "datatype": "utf8",
        "broker": "3c16a07776b27396",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 350,
        "y": 1300,
        "wires": [
            [
                "95ebc22a961575da"
            ]
        ]
    },
    {
        "id": "95ebc22a961575da",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "function(updateStatus)",
        "func": "// robot/+/status Î°úÎ∂ÄÌÑ∞ Îì§Ïñ¥Ïò§Îäî msgÎ•º Ï≤òÎ¶¨ÌïòÎäî Ìï®Ïàò\n\n// 1) payload JSON ÌååÏã±\nlet status;\ntry {\n    status = JSON.parse(msg.payload || '{}');\n} catch (e) {\n    node.error('Invalid JSON in robot status', msg);\n    return null;\n}\n\n// 2) ÌÜ†ÌîΩÏóêÏÑú robot_id Ï∂îÏ∂ú: robot/agv1/status\nconst parts = msg.topic.split('/');\nconst robotIdFromTopic = parts[1] || null;\nconst robotId = status.robot_id || robotIdFromTopic || 'unknown';\n\n// 3) robots ÏÉÅÌÉú Í∞±Ïã† (global.robots)\nlet robots = global.get('robots') || {};\nconst now = Date.now();\nrobots[robotId] = {\n    // Í∏∞Ï°¥ Í∞í Ïú†ÏßÄ(Ï∂îÍ∞Ä ÌïÑÎìú Ïïà ÎÇ†Î¶¨Í∏∞)\n    ...(robots[robotId] || {}),\n\n    // ÌëúÏ§Ä ÌïÑÎìú\n    robot_id: robotId,\n    state: status.state || 'unknown',\n    task_id: status.task_id || null,\n    battery: status.battery ?? null,\n    area: status.area || null,\n    error_code: status.error_code || null,\n\n    // ÎîîÏßÄÌÑ∏ Ìä∏Ïúà ÌïµÏã¨ ÌïÑÎìú (Ï∂îÍ∞Ä)\n    pose: status.pose || (robots[robotId]?.pose ?? null),\n    target_area: status.target_area || (robots[robotId]?.target_area ?? null),\n\n    updated_at: status.updated_at || now\n};\nglobal.set('robots', robots);\n\n// ----------------------\n// EMA stats helpers\n// ----------------------\nlet taskStats = global.get(\"taskStats\") || {};  // { deliver_water: { ema_ms, n, updated_at }, ... }\nconst EMA_ALPHA = 0.3;\n\nfunction emaUpdate(key, sampleMs) {\n    const prev = taskStats[key]?.ema_ms;\n    const next = (prev == null) ? sampleMs : (EMA_ALPHA * sampleMs + (1 - EMA_ALPHA) * prev);\n    taskStats[key] = {\n        ema_ms: next,\n        n: (taskStats[key]?.n || 0) + 1,\n        updated_at: Date.now()\n    };\n}\n\n// 4) taskQueue/events Î∞òÏòÅ (task_id ÏûàÏùÑ ÎïåÎßå)\nlet taskQueue = global.get('taskQueue') || [];\nlet events = global.get('events') || [];\n\nif (status.task_id) {\n    const taskId = status.task_id;\n\n    for (let i = 0; i < taskQueue.length; i++) {\n        if (taskQueue[i].task_id === taskId) {\n\n            if (status.state === 'done' || status.state === 'idle') {\n                taskQueue[i].status = 'done';\n                taskQueue[i].finished_at = Date.now();\n\n                // ‚úÖ Ï∂îÍ∞Ä: Ïã§Ï†ú Í±∏Î¶∞ ÏãúÍ∞Ñ Í≥ÑÏÇ∞ + EMA ÏóÖÎç∞Ïù¥Ìä∏\n                const started = taskQueue[i].started_at || taskQueue[i].created_at || taskQueue[i].finished_at;\n                const actualMs = Math.max(0, taskQueue[i].finished_at - started);\n                taskQueue[i].actual_duration_ms = actualMs;\n\n                const key = taskQueue[i].type || \"unknown\"; // Îçî ÏÑ∏Î∂ÑÌôî ÏõêÌïòÎ©¥ `${type}|${target_area}`\n                emaUpdate(key, actualMs);\n                global.set(\"taskStats\", taskStats);\n            } else if (status.state === 'running') {\n                taskQueue[i].status = 'running';\n                if (!taskQueue[i].started_at) taskQueue[i].started_at = Date.now();\n            } else if (status.state === 'error') {\n                taskQueue[i].status = 'failed';\n                taskQueue[i].finished_at = Date.now();\n                taskQueue[i].error_code = status.error_code || null;\n\n                // ‚úÖ Ï∂îÍ∞Ä: Ïã§Ï†ú Í±∏Î¶∞ ÏãúÍ∞Ñ Í≥ÑÏÇ∞ + EMA ÏóÖÎç∞Ïù¥Ìä∏\n                const started = taskQueue[i].started_at || taskQueue[i].created_at || taskQueue[i].finished_at;\n                const actualMs = Math.max(0, taskQueue[i].finished_at - started);\n                taskQueue[i].actual_duration_ms = actualMs;\n\n                const key = taskQueue[i].type || \"unknown\";\n                emaUpdate(key, actualMs);\n                global.set(\"taskStats\", taskStats);\n            }\n\n            taskQueue[i].assigned_robot = robotId;\n            break;\n        }\n    }\n    global.set('taskQueue', taskQueue);\n\n    events.push({\n        ts: Date.now(),\n        type: 'task_status_update',\n        robot_id: robotId,\n        task_id: taskId,\n        state: status.state,\n        area: status.area || null,\n        target_area: status.target_area || null,\n        pose: status.pose || null,\n        error_code: status.error_code || null\n    });\n\n    if (events.length > 200) events = events.slice(events.length - 200);\n    global.set('events', events);\n}\n\n// 5) ÎîîÎ≤ÑÍ∑∏ payload ÏÑ∏ÌåÖ\nmsg.payload = {\n    last_status: status,\n    robots: robots\n};\n\n// ----------------------\n// Firestore write (Ï∂îÍ∞Ä)\n// ----------------------\nconst db = global.get(\"db\");\nif (db) {\n    // robots/{robotId}\n    db.collection(\"robots\").doc(robotId).set(robots[robotId], { merge: true })\n        .catch(err => node.error(\"[robots write] \" + err));\n\n    // tasks/{task_id} (ÏûàÏùÑ ÎïåÎßå)\n    if (status.task_id) {\n        const mappedStatus =\n            (status.state === \"error\") ? \"failed\" :\n            (status.state === \"done\" || status.state === \"idle\") ? \"done\" :\n            (status.state === \"running\") ? \"running\" : \"unknown\";\n\n        const taskPatch = {\n            status: mappedStatus,\n            assigned_robot: robotId,\n            error_code: status.error_code || null,\n        };\n\n        const tq = global.get(\"taskQueue\") || [];\n        const tt = tq.find(x => x.task_id === status.task_id);\n        if (tt?.actual_duration_ms != null) taskPatch.actual_duration_ms = tt.actual_duration_ms;\n        if (tt?.expected_duration_ms != null) taskPatch.expected_duration_ms = tt.expected_duration_ms;\n\n        if (status.state === \"done\" || status.state === \"idle\" || status.state === \"error\") {\n            taskPatch.finished_at = Date.now();\n        }\n\n        db.collection(\"tasks\").doc(status.task_id).set(taskPatch, { merge: true })\n            .catch(err => node.error(\"[tasks write] \" + err));\n    }\n\n    // events add\n    db.collection(\"events\").add({\n        ts: Date.now(),\n        type: \"task_status_update\",\n        robot_id: robotId,\n        task_id: status.task_id || null,\n        state: status.state || null,\n        area: status.area || null,\n        target_area: status.target_area || null,\n        pose: status.pose || null,\n        error_code: status.error_code || null\n    }).catch(err => node.error(\"[events add] \" + err));\n}\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 1300,
        "wires": [
            [
                "0ea75d0a1dd47579"
            ]
        ]
    },
    {
        "id": "0ea75d0a1dd47579",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 920,
        "y": 1300,
        "wires": []
    },
    {
        "id": "b9b40ef75eda6086",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "refresh robots",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "1",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 420,
        "y": 2140,
        "wires": [
            [
                "62da11a590d356e1"
            ]
        ]
    },
    {
        "id": "62da11a590d356e1",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "getRobots",
        "func": "const robots = global.get('robots') || {};\nconst arr = [];\n\nfor (const id in robots) {\n    const r = robots[id];\n    // updated_at ÎàÑÎùΩ Î∞©Ïñ¥\n    if (!r.updated_at) r.updated_at = Date.now();\n    arr.push(r);\n}\n\nmsg.robots = arr;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 2140,
        "wires": [
            [
                "b1495853d26db37c"
            ]
        ]
    },
    {
        "id": "c8bbc855845ed80c",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "refresh tasks",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "1",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 420,
        "y": 2200,
        "wires": [
            [
                "49c2e81ae9744bc4"
            ]
        ]
    },
    {
        "id": "49c2e81ae9744bc4",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "getTasks",
        "func": "let tasks = global.get('taskQueue') || [];\n\n// ÏµúÍ∑º ÏÉùÏÑ±Îêú ÏàúÏÑúÎåÄÎ°ú Î≥¥Í≥† Ïã∂ÏúºÎ©¥ Ï†ïÎ†¨\ntasks = tasks.slice().sort((a, b) => (b.created_at || 0) - (a.created_at || 0));\n\nmsg.tasks = tasks;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 720,
        "y": 2200,
        "wires": [
            [
                "c915a198b0c6cae3"
            ]
        ]
    },
    {
        "id": "6867664da4b8f9fd",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "refresh events",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "1",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 420,
        "y": 2260,
        "wires": [
            [
                "b6c7d07a0458179a"
            ]
        ]
    },
    {
        "id": "b6c7d07a0458179a",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "getEvents",
        "func": "let events = global.get('events') || [];\n\n// ÏµúÏã† Ïù¥Î≤§Ìä∏Í∞Ä ÏúÑÏóê Î≥¥Ïù¥ÎèÑÎ°ù Ïó≠Ïàú Ï†ïÎ†¨\nevents = events.slice().sort((a, b) => (b.ts || 0) - (a.ts || 0));\n\nmsg.events = events;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 720,
        "y": 2260,
        "wires": [
            [
                "5b2975efe1ee8e3a"
            ]
        ]
    },
    {
        "id": "b1495853d26db37c",
        "type": "ui_template",
        "z": "49f8711fc297a8c1",
        "group": "e6e1b7942a2b8330",
        "name": "Robots cards",
        "order": 0,
        "width": 0,
        "height": 0,
        "format": "<div class=\"robots-wrapper\">\n  <div ng-repeat=\"r in msg.robots\" \n       class=\"robot-card\" \n       ng-class=\"(r.state || 'unknown').toLowerCase()\">\n       \n    <div class=\"robot-header\">\n      <span class=\"robot-id\">{{r.robot_id}}</span>\n      <span class=\"state-pill\" \n            ng-class=\"(r.state || 'unknown').toLowerCase()\">\n        {{(r.state || 'unknown') | uppercase}}\n      </span>\n    </div>\n\n    <div class=\"robot-main\">\n      <div class=\"battery\">\n        üîã {{r.battery !== null && r.battery !== undefined ? (r.battery + '%') : '-'}}\n      </div>\n      <div class=\"area\">\n        üìç {{r.area || '-'}}\n      </div>\n      <div class=\"task\">\n        üßæ {{r.task_id || '-'}}\n      </div>\n      <div class=\"error\" ng-if=\"r.error_code\">\n        ‚ö† ERROR: {{r.error_code}}\n      </div>\n    </div>\n\n    <div class=\"robot-footer\">\n      <span class=\"updated-label\">UPDATED</span>\n      <span class=\"updated-at\">\n        {{ r.updated_at | date:'HH:mm:ss' }}\n      </span>\n    </div>\n  </div>\n\n  <div ng-if=\"!msg.robots || msg.robots.length === 0\" class=\"robot-empty\">\n    No robot data yet.\n  </div>\n</div>\n\n<style>\n  .robots-wrapper {\n    display:flex;\n    flex-wrap:wrap;\n    gap:16px;\n    padding-top:4px;\n  }\n  .robot-card {\n    width: 220px;\n    background: radial-gradient(circle at top left, #0f172a, #020617);\n    border-radius:16px;\n    padding:12px 14px;\n    box-shadow:0 0 18px rgba(15,23,42,0.9);\n    border:1px solid rgba(148,163,184,0.35);\n    color:#E5E7EB;\n    display:flex;\n    flex-direction:column;\n    justify-content:space-between;\n  }\n  .robot-header {\n    display:flex;\n    justify-content:space-between;\n    align-items:center;\n    margin-bottom:8px;\n  }\n  .robot-id {\n    font-weight:700;\n    font-size:16px;\n    color:#F9FAFB;\n  }\n  .state-pill {\n    padding:2px 8px;\n    border-radius:999px;\n    font-size:10px;\n    font-weight:600;\n    letter-spacing:0.5px;\n    border:1px solid rgba(148,163,184,0.5);\n  }\n  .state-pill.idle {\n    background:rgba(148,163,184,0.15);\n    border-color:#9CA3AF;\n    color:#E5E7EB;\n  }\n  .state-pill.running {\n    background:rgba(34,197,94,0.15);\n    border-color:#22C55E;\n    color:#BBF7D0;\n  }\n  .state-pill.charging {\n    background:rgba(234,179,8,0.12);\n    border-color:#EAB308;\n    color:#FEF9C3;\n  }\n  .state-pill.error, .state-pill.failed, .state-pill.fault {\n    background:rgba(239,68,68,0.16);\n    border-color:#EF4444;\n    color:#FECACA;\n  }\n  .state-pill.unknown {\n    background:rgba(59,130,246,0.12);\n    border-color:#3B82F6;\n    color:#BFDBFE;\n  }\n\n  .robot-main {\n    font-size:13px;\n    line-height:1.4;\n    margin-top:4px;\n    margin-bottom:8px;\n  }\n  .robot-main > div {\n    margin:2px 0;\n  }\n  .robot-main .error {\n    color:#FCA5A5;\n    font-size:12px;\n  }\n\n  .robot-footer {\n    display:flex;\n    justify-content:space-between;\n    font-size:10px;\n    color:#9CA3AF;\n    border-top:1px dashed rgba(55,65,81,0.8);\n    padding-top:4px;\n    margin-top:4px;\n  }\n  .robot-empty {\n    font-size:12px;\n    color:#9CA3AF;\n    padding:10px;\n  }\n</style>\n",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1050,
        "y": 2140,
        "wires": [
            []
        ]
    },
    {
        "id": "4cc056840f379311",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "Summary",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "1",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 410,
        "y": 2080,
        "wires": [
            [
                "cc62e9eae576026f"
            ]
        ]
    },
    {
        "id": "cc62e9eae576026f",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "Summary",
        "func": "// robots ÏöîÏïΩ\nconst robots = global.get('robots') || {};\nconst taskQueue = global.get('taskQueue') || [];\n\nlet total = 0, idle = 0, running = 0, charging = 0, error = 0, others = 0;\n\nfor (const id in robots) {\n    total++;\n    const s = (robots[id].state || '').toLowerCase();\n    if (s === 'idle') idle++;\n    else if (s === 'running') running++;\n    else if (s === 'charging') charging++;\n    else if (s === 'error' || s === 'failed' || s === 'fault') error++;\n    else others++;\n}\n\nmsg.summary = { total, idle, running, charging, error, others };\n\n// tasks ÏöîÏïΩ\nlet tTotal = taskQueue.length;\nlet tPending = 0, tRunning = 0, tDone = 0, tFailed = 0;\n\nfor (const t of taskQueue) {\n    const s = (t.status || '').toLowerCase();\n    if (s === 'pending') tPending++;\n    else if (s === 'running') tRunning++;\n    else if (s === 'done') tDone++;\n    else if (s === 'failed') tFailed++;\n}\n\nmsg.taskSummary = {\n    total: tTotal,\n    pending: tPending,\n    running: tRunning,\n    done: tDone,\n    failed: tFailed\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 720,
        "y": 2080,
        "wires": [
            [
                "74d6b228f443bd37"
            ]
        ]
    },
    {
        "id": "74d6b228f443bd37",
        "type": "ui_template",
        "z": "49f8711fc297a8c1",
        "group": "7e8e44e7110066b9",
        "name": "",
        "order": 0,
        "width": 0,
        "height": 0,
        "format": "<div class=\"dash-summary\">\n  <div class=\"summary-card total\">\n    <div class=\"label\">ROBOTS</div>\n    <div class=\"value\">{{msg.summary.total || 0}}</div>\n  </div>\n  <div class=\"summary-card idle\">\n    <div class=\"label\">IDLE</div>\n    <div class=\"value\">{{msg.summary.idle || 0}}</div>\n  </div>\n  <div class=\"summary-card running\">\n    <div class=\"label\">RUNNING</div>\n    <div class=\"value\">{{msg.summary.running || 0}}</div>\n  </div>\n  <div class=\"summary-card charging\">\n    <div class=\"label\">CHARGING</div>\n    <div class=\"value\">{{msg.summary.charging || 0}}</div>\n  </div>\n  <div class=\"summary-card error\">\n    <div class=\"label\">ERROR/OTHER</div>\n    <div class=\"value\">\n      {{(msg.summary.error || 0) + (msg.summary.others || 0)}}\n    </div>\n  </div>\n</div>\n\n<div class=\"dash-summary\" style=\"margin-top:6px;\">\n  <div class=\"summary-card task-total\">\n    <div class=\"label\">TASKS</div>\n    <div class=\"value\">{{msg.taskSummary.total || 0}}</div>\n  </div>\n  <div class=\"summary-card task-pending\">\n    <div class=\"label\">PENDING</div>\n    <div class=\"value\">{{msg.taskSummary.pending || 0}}</div>\n  </div>\n  <div class=\"summary-card task-running\">\n    <div class=\"label\">RUNNING</div>\n    <div class=\"value\">{{msg.taskSummary.running || 0}}</div>\n  </div>\n  <div class=\"summary-card task-done\">\n    <div class=\"label\">DONE</div>\n    <div class=\"value\">{{msg.taskSummary.done || 0}}</div>\n  </div>\n  <div class=\"summary-card task-failed\">\n    <div class=\"label\">FAILED</div>\n    <div class=\"value\">{{msg.taskSummary.failed || 0}}</div>\n  </div>\n</div>\n\n<style>\n  .dash-summary {\n    display:flex;\n    flex-wrap:wrap;\n    gap:16px;\n    padding:4px 0 4px 0;\n  }\n  .summary-card {\n    flex:0 0 150px;\n    background:#020617;\n    border-radius:14px;\n    padding:10px 14px;\n    box-shadow:0 0 18px rgba(0,0,0,0.45);\n    border:1px solid rgba(148,163,184,0.25);\n  }\n  .summary-card .label {\n    font-size:11px;\n    letter-spacing:1px;\n    color:#9CA3AF;\n  }\n  .summary-card .value {\n    margin-top:4px;\n    font-size:22px;\n    font-weight:700;\n    color:#F9FAFB;\n  }\n\n  .summary-card.total      { border-left:3px solid #38BDF8; }\n  .summary-card.idle       { border-left:3px solid #9CA3AF; }\n  .summary-card.running    { border-left:3px solid #22C55E; }\n  .summary-card.charging   { border-left:3px solid #EAB308; }\n  .summary-card.error      { border-left:3px solid #EF4444; }\n\n  .summary-card.task-total   { border-left:3px solid #6366F1; }\n  .summary-card.task-pending { border-left:3px solid #9CA3AF; }\n  .summary-card.task-running { border-left:3px solid #22C55E; }\n  .summary-card.task-done    { border-left:3px solid #0EA5E9; }\n  .summary-card.task-failed  { border-left:3px solid #F97316; }\n</style>\n",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1040,
        "y": 2080,
        "wires": [
            []
        ]
    },
    {
        "id": "c915a198b0c6cae3",
        "type": "ui_template",
        "z": "49f8711fc297a8c1",
        "group": "920df32220cd089d",
        "name": "",
        "order": 0,
        "width": 0,
        "height": 0,
        "format": "<div class=\"tasks-wrapper\">\n  <table class=\"tasks-table\" ng-if=\"msg.tasks && msg.tasks.length\">\n    <thead>\n      <tr>\n        <th>Task ID</th>\n        <th>Type</th>\n        <th>Target</th>\n        <th>Status</th>\n        <th>Robot</th>\n        <th>Created</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr ng-repeat=\"t in msg.tasks\">\n        <td>{{t.task_id}}</td>\n        <td>{{t.type}}</td>\n        <td>{{t.target_area}}</td>\n        <td>\n          <span class=\"task-status\" ng-class=\"(t.status || 'unknown').toLowerCase()\">\n            {{(t.status || 'unknown') | uppercase}}\n          </span>\n        </td>\n        <td>{{t.assigned_robot || '-'}}</td>\n        <td>{{t.created_at | date:'MM-dd HH:mm:ss'}}</td>\n      </tr>\n    </tbody>\n  </table>\n\n  <div ng-if=\"!msg.tasks || !msg.tasks.length\" class=\"tasks-empty\">\n    No tasks yet.\n  </div>\n</div>\n\n<style>\n  .tasks-wrapper {\n    padding-top:4px;\n  }\n  .tasks-table {\n    width:100%;\n    border-collapse:collapse;\n    font-size:12px;\n    background:#020617;\n    border-radius:10px;\n    overflow:hidden;\n    box-shadow:0 0 18px rgba(15,23,42,0.7);\n  }\n  .tasks-table thead {\n    background:linear-gradient(to right,#0f172a,#020617);\n  }\n  .tasks-table th,\n  .tasks-table td {\n    padding:6px 8px;\n    text-align:left;\n    border-bottom:1px solid rgba(30,41,59,0.9);\n    color:#E5E7EB;\n  }\n  .tasks-table th {\n    font-weight:600;\n    font-size:11px;\n    color:#9CA3AF;\n  }\n  .tasks-table tbody tr:hover {\n    background:rgba(15,23,42,0.8);\n  }\n\n  .task-status {\n    padding:2px 6px;\n    border-radius:999px;\n    font-size:10px;\n    border:1px solid rgba(148,163,184,0.4);\n  }\n  .task-status.pending {\n    background:rgba(148,163,184,0.1);\n    border-color:#9CA3AF;\n  }\n  .task-status.running {\n    background:rgba(34,197,94,0.15);\n    border-color:#22C55E;\n    color:#BBF7D0;\n  }\n  .task-status.done {\n    background:rgba(59,130,246,0.18);\n    border-color:#3B82F6;\n    color:#DBEAFE;\n  }\n  .task-status.failed {\n    background:rgba(239,68,68,0.18);\n    border-color:#EF4444;\n    color:#FECACA;\n  }\n  .task-status.unknown {\n    background:rgba(107,114,128,0.18);\n    border-color:#6B7280;\n    color:#E5E7EB;\n  }\n\n  .tasks-empty {\n    font-size:12px;\n    color:#9CA3AF;\n    padding:8px;\n  }\n</style>\n",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1040,
        "y": 2200,
        "wires": [
            []
        ]
    },
    {
        "id": "5b2975efe1ee8e3a",
        "type": "ui_template",
        "z": "49f8711fc297a8c1",
        "group": "ab2f507577ca5dbe",
        "name": "",
        "order": 0,
        "width": 0,
        "height": 0,
        "format": "<div class=\"events-wrapper\">\n  <table class=\"events-table\" ng-if=\"msg.events && msg.events.length\">\n    <thead>\n      <tr>\n        <th>Time</th>\n        <th>Type</th>\n        <th>Robot</th>\n        <th>Task</th>\n        <th>State</th>\n        <th>Area</th>\n        <th>Error</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr ng-repeat=\"e in msg.events | limitTo:50\">\n        <td>{{e.ts | date:'HH:mm:ss'}}</td>\n        <td>{{e.type}}</td>\n        <td>{{e.robot_id}}</td>\n        <td>{{e.task_id}}</td>\n        <td>{{e.state}}</td>\n        <td>{{e.area || '-'}}</td>\n        <td>{{e.error_code || '-'}}</td>\n      </tr>\n    </tbody>\n  </table>\n\n  <div ng-if=\"!msg.events || !msg.events.length\" class=\"events-empty\">\n    No events yet.\n  </div>\n</div>\n\n<style>\n  .events-wrapper {\n    padding-top:4px;\n  }\n  .events-table {\n    width:100%;\n    border-collapse:collapse;\n    font-size:11px;\n    background:#020617;\n    border-radius:10px;\n    overflow:hidden;\n    box-shadow:0 0 18px rgba(15,23,42,0.7);\n  }\n  .events-table thead {\n    background:linear-gradient(to right,#0f172a,#020617);\n  }\n  .events-table th,\n  .events-table td {\n    padding:4px 6px;\n    text-align:left;\n    border-bottom:1px solid rgba(30,41,59,0.9);\n    color:#E5E7EB;\n  }\n  .events-table th {\n    font-weight:600;\n    font-size:10px;\n    color:#9CA3AF;\n  }\n  .events-table tbody tr:hover {\n    background:rgba(15,23,42,0.8);\n  }\n  .events-empty {\n    font-size:12px;\n    color:#9CA3AF;\n    padding:8px;\n  }\n</style>\n",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1040,
        "y": 2260,
        "wires": [
            []
        ]
    },
    {
        "id": "f4058cf1557c02ec",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "Init global state",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 360,
        "y": 180,
        "wires": [
            [
                "dd5be1ad5697a1f2"
            ]
        ]
    },
    {
        "id": "dd5be1ad5697a1f2",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "initGlobalState",
        "func": "// Ï†ÑÏó≠ ÏÉÅÌÉú Í∏∞Î≥∏Í∞í ÏÑ∏ÌåÖ\n// area -> grid Ï¢åÌëú (VueÏùò mapConfig.jsÎûë ÎèôÏùºÌïòÍ≤å ÎßûÏ∂îÎ©¥ ÏµúÍ≥†)\nconst AREA_POS = {\n  BASE:  { x: 2,  y: 7 },\n  DOCK:  { x: 2,  y: 2 },\n  USER1: { x: 9,  y: 3 },\n  USER2: { x: 10, y: 6 },\n};\n\nglobal.set(\"AREA_POS\", AREA_POS);\nnode.warn(\"AREA_POS loaded\");\nreturn msg;\n\n// Ïù¥ÎØ∏ ÏûàÏúºÎ©¥ Ïú†ÏßÄ, ÏóÜÏúºÎ©¥ ÏÉàÎ°ú ÎßåÎì†Îã§\nlet robots = global.get('robots') || {};\nlet taskQueue = global.get('taskQueue') || [];\nlet events = global.get('events') || [];\n\n// agv1 Í∏∞Î≥∏ ÏóîÌä∏Î¶¨Í∞Ä ÏóÜÏúºÎ©¥ ÏÉùÏÑ±\nif (!robots['agv1']) {\n    robots['agv1'] = {\n        robot_id: 'agv1',\n        state: 'idle',          // idle | running | error | charging | offline\n        task_id: null,\n        battery: 100,\n        area: 'HOME',\n        error_code: null,\n        updated_at: Date.now()\n    };\n}\n\n// Ï†ÑÏó≠Ïóê Ï†ÄÏû•\nglobal.set('robots', robots);\nglobal.set('taskQueue', taskQueue);\nglobal.set('events', events);\n\nnode.status({ fill: \"green\", shape: \"dot\", text: \"global initialized\" });\nreturn null;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 600,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "5683f1a5e869fec8",
        "type": "mqtt in",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "robot/agv1/task",
        "qos": "2",
        "datatype": "utf8",
        "broker": "3c16a07776b27396",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 360,
        "y": 1480,
        "wires": [
            [
                "4319d8f20df90726",
                "a50e6fc76e6e8f77"
            ]
        ]
    },
    {
        "id": "4319d8f20df90726",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "simulateAGV",
        "func": "// robot/agv1/task Î°ú Îì§Ïñ¥Ïò® TaskÎ•º Î∞õÏïÑÏÑú\n// 1) running status (poseÎ•º 200msÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎ©∞ Ïó¨Îü¨ Î≤à Î∞úÌñâ)\n// 2) 5Ï¥à ÌõÑ done/idle status (ÎßàÏßÄÎßâ pose Ìè¨Ìï®)\n// output1: running Ïä§Ìä∏Î¶º(Ïó¨Îü¨ Î©îÏãúÏßÄ), output2: done(ÎîúÎ†àÏù¥ ÌÉÄÍ≥† ÎÇòÍ∞à ÏòàÏ†ï)\n\nlet task;\ntry {\n    task = JSON.parse(msg.payload || '{}');\n} catch (e) {\n    node.error('Invalid task JSON in simulateAGV', msg);\n    return null;\n}\n\nconst robotId = 'agv1';\n\n// Î∞∞ÌÑ∞Î¶¨/area/poseÎ•º contextÏóêÏÑú Í¥ÄÎ¶¨\nlet battery = context.get('battery') ?? 80;\nlet area = context.get('area') || 'BASE';\n\n// poseÎäî \"Í∞ÄÏÉÅ Ï¢åÌëú\" (grid Ï¢åÌëúÍ≥Ñ float)\nlet pose = context.get('pose') || { x: 2, y: 7, theta: 0 }; // BASE Í∑ºÏ≤ò Í∏∞Î≥∏Í∞í\n\n// Î∞∞ÌÑ∞Î¶¨ ÏÇ¥Ïßù ÍπéÍ∏∞\nbattery = Math.max(0, battery - 1);\ncontext.set('battery', battery);\n\n// ---- area Ï¢åÌëú Îß§Ìïë Î°úÎìú ----\nconst AREA_POS = global.get(\"AREA_POS\") || {\n  BASE:  { x: 2,  y: 7 },\n  DOCK:  { x: 2,  y: 2 },\n  USER1: { x: 9,  y: 3 },\n  USER2: { x: 10, y: 6 },\n};\n\n// Î™©Ìëú ÏßÄÏ†ê Í≤∞Ï†ï: task.target_area Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ ÌòÑÏû¨ area Ïú†ÏßÄ\nconst targetArea = task.target_area || area;\nconst startArea = area;\nconst startPos = { x: pose.x, y: pose.y };\nconst endPos = AREA_POS[targetArea] || startPos;\n\n// heading Í≥ÑÏÇ∞\nfunction heading(from, to) {\n  const dx = to.x - from.x;\n  const dy = to.y - from.y;\n  return Math.atan2(dy, dx);\n}\nfunction lerp(a, b, t) { return a + (b - a) * t; }\n\n// ---- running Ïä§Ìä∏Î¶º ÏÉùÏÑ± ----\nconst DURATION_MS = Number(task.expected_duration_ms) || 5000;\nconst STEP_MS = 200;\nconst steps = Math.max(1, Math.floor(DURATION_MS / STEP_MS));\n\nconst msgsRunning = [];\n\nfor (let i = 0; i <= steps; i++) {\n  const t = i / steps;\n  const x = lerp(startPos.x, endPos.x, t);\n  const y = lerp(startPos.y, endPos.y, t);\n  const theta = heading({x, y}, endPos);\n\n  const runningStatus = {\n    robot_id: robotId,\n    state: 'running',\n    task_id: task.task_id || null,\n    battery: battery,\n    area: startArea,          // \"ÌòÑÏû¨ Íµ¨Ïó≠\"ÏùÄ ÌÅ∞ ÏùòÎØ∏Î°ú ÏãúÏûë area Ïú†ÏßÄ (ÏõêÌïòÎ©¥ Ï§ëÍ∞ÑÏóê Î∞îÍøîÎèÑ Îê®)\n    target_area: targetArea,  // Î™©Ìëú Íµ¨Ïó≠ ÌëúÏãú(Overview ÎØ∏ÎãàÎßµ ÎßàÏª§Ïö©)\n    error_code: null,\n    pose: { x, y, theta },\n    updated_at: Date.now()\n  };\n\n  msgsRunning.push({\n    topic: `robot/${robotId}/status`,\n    payload: JSON.stringify(runningStatus),\n    // Delay ÎÖ∏ÎìúÍ∞Ä \"msg.delay\"Î•º ÏùΩÎèÑÎ°ù ÏÑ∏ÌåÖ (Delay ÎÖ∏Îìú ÏÑ§Ï†ïÏóê Îî∞Îùº Îã§Î•º Ïàò ÏûàÏùå)\n    delay: i * STEP_MS\n  });\n}\n\n// ÎßàÏßÄÎßâ poseÎ•º contextÏóê Ï†ÄÏû• (ÏûëÏóÖ ÎÅùÎÇú ÏúÑÏπò)\npose = { x: endPos.x, y: endPos.y, theta: heading(endPos, endPos) };\ncontext.set('pose', pose);\n\n// ÏûëÏóÖÏù¥ ÎÅùÎÇòÎ©¥ areaÎ•º targetAreaÎ°ú Í∞±Ïã†\narea = targetArea;\ncontext.set('area', area);\n\n// ---- done/idle Î©îÏãúÏßÄ Ï§ÄÎπÑ ----\nconst doneStatus = {\n    robot_id: robotId,\n    state: 'done',\n    task_id: task.task_id || null,\n    battery: battery,\n    area: area,\n    target_area: null,\n    error_code: null,\n    pose: { x: endPos.x, y: endPos.y, theta: heading(startPos, endPos) },\n    updated_at: Date.now()\n};\n\nconst msgDone = {\n  topic: `robot/${robotId}/status`,\n  payload: JSON.stringify(doneStatus),\n  delay: DURATION_MS             // ‚úÖ ÎîúÎ†àÏù¥ ÎÖ∏ÎìúÍ∞Ä msg.delay ÏùΩÍ≤å Ìï† Í±∞ÎùºÏÑú\n};\n\n// ---- idle Î≥µÍ∑Ä Î©îÏãúÏßÄ ----\nconst idleStatus = {\n  robot_id: robotId,\n  state: 'idle',\n  task_id: null,                 // ‚úÖ ÏûëÏóÖ ÎÅùÎÇ¨ÏúºÎãà ÎπÑÏõÄ\n  battery,\n  area,\n  target_area: null,\n  error_code: null,\n  pose: { x: endPos.x, y: endPos.y, theta: heading(startPos, endPos) },\n  updated_at: Date.now()\n};\n\nconst msgIdle = {\n  topic: `robot/${robotId}/status`,\n  payload: JSON.stringify(idleStatus),\n  delay: DURATION_MS + 300        // done ÏßÅÌõÑ 0.3Ï¥à Îí§ idle (Ï∑®Ìñ•)\n};\n\n// output1: running Ïä§Ìä∏Î¶º, output2: done + idle (2Í∞ú Î©îÏãúÏßÄ)\nreturn [msgsRunning, [msgDone, msgIdle]];\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 850,
        "y": 1480,
        "wires": [
            [
                "241f54b35e15895f"
            ],
            [
                "c892835546595db4"
            ]
        ]
    },
    {
        "id": "e5f2fa78b4c8f5b4",
        "type": "mqtt out",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3c16a07776b27396",
        "x": 1470,
        "y": 1420,
        "wires": []
    },
    {
        "id": "5462d48ba72465a3",
        "type": "mqtt out",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3c16a07776b27396",
        "x": 1470,
        "y": 1560,
        "wires": []
    },
    {
        "id": "c892835546595db4",
        "type": "delay",
        "z": "49f8711fc297a8c1",
        "name": "",
        "pauseType": "delayv",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1060,
        "y": 1560,
        "wires": [
            [
                "5462d48ba72465a3",
                "d79424313dccb2f0"
            ]
        ]
    },
    {
        "id": "a50e6fc76e6e8f77",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 3",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 540,
        "y": 1500,
        "wires": []
    },
    {
        "id": "d79424313dccb2f0",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 4",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1220,
        "y": 1580,
        "wires": []
    },
    {
        "id": "0e18ed358d9967fb",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 5",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1220,
        "y": 1440,
        "wires": []
    },
    {
        "id": "9a5002eb64eee3d0",
        "type": "http in",
        "z": "49f8711fc297a8c1",
        "name": "GET /api/robots",
        "url": "/api/robots",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 400,
        "y": 1740,
        "wires": [
            [
                "1099aa542425c508"
            ]
        ]
    },
    {
        "id": "1099aa542425c508",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "buildRobotsResponse",
        "func": "// // global.robotsÎ•º ÏùΩÏñ¥ÏÑú API ÏùëÎãµ ÌòïÌÉúÎ°ú ÎßåÎì§Ïñ¥Ï£ºÎäî Ìï®Ïàò\n\n// const robotsObj = global.get('robots') || {};\n// const robotsArr = [];\n\n// // Í∞ùÏ≤¥ ‚Üí Î∞∞Ïó¥Î°ú Î≥ÄÌôò\n// for (const id in robotsObj) {\n//     const r = robotsObj[id] || {};\n//     robotsArr.push(r);\n// }\n\n// // JSON ÏùëÎãµ ÌòïÌÉú ÏÑ∏ÌåÖ\n// msg.payload = {\n//     robots: robotsArr\n// };\n\n// // Ìó§ÎçîÏóê JSONÏù¥ÎùºÍ≥† Î™ÖÏãú\n// msg.headers = {\n//     'Content-Type': 'application/json'\n// };\n\n// return msg;\n\nconst db = global.get(\"db\");\nif (!db) {\n  msg.statusCode = 503;\n  msg.headers = { \"Content-Type\": \"application/json\" };\n  msg.payload = { error: \"firestore not ready\" };\n  return msg;\n}\n\nconst limit = Math.min(parseInt((msg.req?.query?.limit ?? \"100\"), 10) || 100, 500);\n\nreturn new Promise(async (resolve) => {\n  try {\n    // updated_at Í∏∞Ï§Ä ÏµúÏã†Ïàú (ÌïÑÎìú ÏóÜÏúºÎ©¥ Ïù∏Îç±Ïä§/Ï†ïÎ†¨ Ïù¥Ïäà Í∞ÄÎä•)\n    let q = db.collection(\"robots\");\n\n    // orderByÎäî ÌïÑÎìúÍ∞Ä ÏïàÏ†ïÏ†ÅÏúºÎ°ú Îì§Ïñ¥Í∞ÄÏïº Ìï®. Ïïà Îì§Ïñ¥Í∞Ñ Î¨∏ÏÑúÍ∞Ä ÏûàÏúºÎ©¥ Ï†ïÎ†¨ÏóêÏÑú Îπ†Ïßà Ïàò ÏûàÏùå.\n    // ÎÑà updateStatusÏóêÏÑú updated_atÏùÑ Ìï≠ÏÉÅ ÎÑ£Í≥† ÏûàÏñ¥ÏÑú OK. :contentReference[oaicite:2]{index=2}\n    q = q.orderBy(\"updated_at\", \"desc\").limit(limit);\n\n    const snap = await q.get();\n    const robots = snap.docs.map(d => d.data());\n\n    msg.statusCode = 200;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { robots };\n    resolve(msg);\n  } catch (err) {\n    node.error(err);\n    msg.statusCode = 500;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { error: \"failed to fetch robots\", detail: String(err?.message || err) };\n    resolve(msg);\n  }\n});",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 1740,
        "wires": [
            [
                "04c572829db161a8"
            ]
        ]
    },
    {
        "id": "04c572829db161a8",
        "type": "http response",
        "z": "49f8711fc297a8c1",
        "name": "res /api/robots",
        "statusCode": "",
        "headers": {},
        "x": 900,
        "y": 1740,
        "wires": []
    },
    {
        "id": "cf9e4d5c0ec26f3f",
        "type": "http in",
        "z": "49f8711fc297a8c1",
        "name": "GET /api/tasks",
        "url": "/api/tasks",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 400,
        "y": 1820,
        "wires": [
            [
                "4db69741e35d7aaa"
            ]
        ]
    },
    {
        "id": "4db69741e35d7aaa",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "buildTasksResponse",
        "func": "// let tasks = global.get('taskQueue') || [];\n\n// // ÏµúÏã†Ïàú Ï†ïÎ†¨ (VueÏóêÏÑú Î≥¥Í∏∞ Ï¢ãÍ≤å)\n// tasks = tasks.slice().sort((a, b) => (b.created_at || 0) - (a.created_at || 0));\n\n// msg.payload = { tasks };\n// msg.headers = { \"Content-Type\": \"application/json\" };\n// return msg;\n\nconst db = global.get(\"db\");\nif (!db) {\n  msg.statusCode = 503;\n  msg.headers = { \"Content-Type\": \"application/json\" };\n  msg.payload = { error: \"firestore not ready\" };\n  return msg;\n}\n\nconst q = msg.req?.query || {};\nconst status = (q.status || \"\").toString().trim(); // pending|running|done|failed Îì±\nconst limit = Math.min(parseInt((q.limit ?? \"50\"), 10) || 50, 500);\n\nreturn new Promise(async (resolve) => {\n  try {\n    let ref = db.collection(\"tasks\");\n\n    // status ÌïÑÌÑ∞ (ÏòµÏÖò)\n    if (status) {\n      ref = ref.where(\"status\", \"==\", status);\n      // where + orderBy Ï°∞Ìï© Ïãú Ïù∏Îç±Ïä§ ÌïÑÏöîÌï† Ïàò ÏûàÏùå (ÏóêÎü¨ Î©îÏãúÏßÄÏóê ÏÉùÏÑ± ÎßÅÌÅ¨ ÎÇòÏò¥)\n    }\n\n    // created_at ÏµúÏã†Ïàú\n    ref = ref.orderBy(\"created_at\", \"desc\").limit(limit);\n\n    const snap = await ref.get();\n    const tasks = snap.docs.map(d => d.data());\n\n    msg.statusCode = 200;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { tasks };\n    resolve(msg);\n  } catch (err) {\n    node.error(err);\n    msg.statusCode = 500;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { error: \"failed to fetch tasks\", detail: String(err?.message || err) };\n    resolve(msg);\n  }\n});\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 1820,
        "wires": [
            [
                "bd552ae11c61fc7b"
            ]
        ]
    },
    {
        "id": "bd552ae11c61fc7b",
        "type": "http response",
        "z": "49f8711fc297a8c1",
        "name": "res /api/tasks",
        "statusCode": "",
        "headers": {},
        "x": 910,
        "y": 1820,
        "wires": []
    },
    {
        "id": "3dc12e5ce8d5567e",
        "type": "http in",
        "z": "49f8711fc297a8c1",
        "name": "GET /api/events",
        "url": "/api/events",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 400,
        "y": 1900,
        "wires": [
            [
                "47eeabd70b7c449b"
            ]
        ]
    },
    {
        "id": "47eeabd70b7c449b",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "buildEventsResponse",
        "func": "// let events = global.get('events') || [];\n\n// // ÏµúÏã†Ïàú Ï†ïÎ†¨\n// events = events.slice().sort((a, b) => (b.ts || 0) - (a.ts || 0));\n\n// msg.payload = { events };\n// msg.headers = { \"Content-Type\": \"application/json\" };\n// return msg;\n\nconst db = global.get(\"db\");\nif (!db) {\n  msg.statusCode = 503;\n  msg.headers = { \"Content-Type\": \"application/json\" };\n  msg.payload = { error: \"firestore not ready\" };\n  return msg;\n}\n\nconst limit = Math.min(parseInt((msg.req?.query?.limit ?? \"50\"), 10) || 50, 500);\n\nreturn new Promise(async (resolve) => {\n  try {\n    const snap = await db\n      .collection(\"events\")\n      .orderBy(\"ts\", \"desc\")\n      .limit(limit)\n      .get();\n\n    const events = snap.docs.map(d => d.data());\n\n    msg.statusCode = 200;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { events };\n    resolve(msg);\n  } catch (err) {\n    node.error(err);\n    msg.statusCode = 500;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { error: \"failed to fetch events\", detail: String(err?.message || err) };\n    resolve(msg);\n  }\n});\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 1900,
        "wires": [
            [
                "14173b48771091af"
            ]
        ]
    },
    {
        "id": "14173b48771091af",
        "type": "http response",
        "z": "49f8711fc297a8c1",
        "name": "res /api/events",
        "statusCode": "",
        "headers": {},
        "x": 920,
        "y": 1900,
        "wires": []
    },
    {
        "id": "aae26e35525d4347",
        "type": "http in",
        "z": "49f8711fc297a8c1",
        "name": "GET /api/summary",
        "url": "/api/summary",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 410,
        "y": 1980,
        "wires": [
            [
                "3252b669c8d4ee2a"
            ]
        ]
    },
    {
        "id": "3252b669c8d4ee2a",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "buildSummaryResponse",
        "func": "// const robots = global.get('robots') || {};\n// const tasks = global.get('taskQueue') || [];\n\n// let total = 0, idle = 0, running = 0, charging = 0, error = 0, others = 0;\n// for (const id in robots) {\n//     total++;\n//     const s = (robots[id].state || '').toLowerCase();\n//     if (s === 'idle') idle++;\n//     else if (s === 'running') running++;\n//     else if (s === 'charging') charging++;\n//     else if (s === 'error' || s === 'failed' || s === 'fault') error++;\n//     else others++;\n// }\n\n// let tTotal = tasks.length;\n// let tPending = 0, tRunning = 0, tDone = 0, tFailed = 0;\n// for (const t of tasks) {\n//     const s = (t.status || '').toLowerCase();\n//     if (s === 'pending') tPending++;\n//     else if (s === 'running') tRunning++;\n//     else if (s === 'done') tDone++;\n//     else if (s === 'failed') tFailed++;\n// }\n\n// msg.payload = {\n//     robots: { total, idle, running, charging, error, others },\n//     tasks:  { total: tTotal, pending: tPending, running: tRunning, done: tDone, failed: tFailed }\n// };\n// msg.headers = { \"Content-Type\": \"application/json\" };\n// return msg;\n\nconst db = global.get(\"db\");\nif (!db) {\n  msg.statusCode = 503;\n  msg.headers = { \"Content-Type\": \"application/json\" };\n  msg.payload = { error: \"firestore not ready\" };\n  return msg;\n}\n\nconst q = msg.req?.query || {};\nconst taskLimit = Math.min(parseInt((q.taskLimit ?? \"200\"), 10) || 200, 1000);\n\nfunction countBy(list, keyFn) {\n  const m = {};\n  for (const x of list) {\n    const k = (keyFn(x) || \"unknown\").toLowerCase();\n    m[k] = (m[k] || 0) + 1;\n  }\n  return m;\n}\n\nreturn new Promise(async (resolve) => {\n  try {\n    // 1) robots Ï†ÑÎ∂Ä ÏùΩÏñ¥ÏÑú ÏÉÅÌÉú Ïπ¥Ïö¥Ìä∏\n    const robotsSnap = await db.collection(\"robots\").get();\n    const robots = robotsSnap.docs.map(d => d.data());\n    const robotCounts = countBy(robots, r => r.state);\n\n    const robotSummary = {\n      total: robots.length,\n      idle: robotCounts.idle || 0,\n      running: robotCounts.running || 0,\n      charging: robotCounts.charging || 0,\n      error: (robotCounts.error || 0) + (robotCounts.failed || 0) + (robotCounts.fault || 0),\n      others:\n        (robotCounts.offline || 0) +\n        (robotCounts.unknown || 0)\n    };\n\n    // 2) tasksÎäî ÏµúÍ∑º NÍ∞úÎßå ÏùΩÏñ¥ÏÑú ÏÉÅÌÉú Ïπ¥Ïö¥Ìä∏ (Phase 0 Í∞ÄÎ≤ºÏö¥ ÏßëÍ≥Ñ)\n    const tasksSnap = await db\n      .collection(\"tasks\")\n      .orderBy(\"created_at\", \"desc\")\n      .limit(taskLimit)\n      .get();\n\n    const tasks = tasksSnap.docs.map(d => d.data());\n    const taskCounts = countBy(tasks, t => t.status);\n\n    const taskSummary = {\n      total: tasks.length,\n      pending: taskCounts.pending || 0,\n      running: taskCounts.running || 0,\n      done: taskCounts.done || 0,\n      failed: taskCounts.failed || 0\n    };\n\n    msg.statusCode = 200;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { robots: robotSummary, tasks: taskSummary, meta: { taskLimit } };\n    resolve(msg);\n  } catch (err) {\n    node.error(err);\n    msg.statusCode = 500;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { error: \"failed to fetch summary\", detail: String(err?.message || err) };\n    resolve(msg);\n  }\n});\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 1980,
        "wires": [
            [
                "bb5bd9f96e8e8313"
            ]
        ]
    },
    {
        "id": "bb5bd9f96e8e8313",
        "type": "http response",
        "z": "49f8711fc297a8c1",
        "name": "res /api/summary",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 1980,
        "wires": []
    },
    {
        "id": "a90b7ad07ef61884",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "FIrestore Client Init",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 370,
        "y": 80,
        "wires": [
            [
                "f1509788aad45a75"
            ]
        ]
    },
    {
        "id": "f1509788aad45a75",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "Init Firestore",
        "func": "// admin, fs Îäî Function ÎÖ∏Îìú Setup(Modules)ÏóêÏÑú Ï£ºÏûÖÎ∞õÎäîÎã§Í≥† Í∞ÄÏ†ï\n\n// const keyPath = \"C:/Users/wp3wk/AppData/Roaming/SPB_Data/.node-red/agv-pjt2-firebase-adminsdk-fbsvc-18055a3bd9.json\"; // ÎÇ¥ ÌååÏù¥Ïñ¥Ïä§ÌÜ†Ïñ¥\nconst keyPath = \"C:/Users/wp3wk/AppData/Roaming/SPB_Data/.node-red/agv-pjt2-9d394-firebase-adminsdk-fbsvc-9079c95fe9.json\" // Ïú†ÏßÑÏù¥ ÌååÏù¥Ïñ¥Ïä§ÌÜ†Ïñ¥\n// 0) ÏÑúÎπÑÏä§ Í≥ÑÏ†ï ÌååÏùº Ï°¥Ïû¨ ÌôïÏù∏\nif (!fs.existsSync(keyPath)) {\n  node.error(\"‚ùå Service account json not found: \" + keyPath);\n  return null;\n}\n\nconst serviceAccount = JSON.parse(fs.readFileSync(keyPath, \"utf8\"));\n\n// 1) Í∏∞Ï°¥ firebase-admin Ïï±Ïù¥ ÏûàÏúºÎ©¥ Ï†úÍ±∞ (ÌîÑÎ°úÏ†ùÌä∏ Î≥ÄÍ≤Ω Ïãú ÌïÑÏàò)\nif (admin.apps && admin.apps.length > 0) {\n  return admin.app().delete().then(() => {\n    node.warn(\"‚ôªÔ∏è Old firebase app deleted. Re-initializing...\");\n    return init();\n  }).catch(err => {\n    node.error(\"‚ùå Failed to delete old firebase app: \" + err.message);\n    return null;\n  });\n}\n\n// 2) Ïã§Ï†ú Ï¥àÍ∏∞Ìôî Ìï®Ïàò\nfunction init() {\n  admin.initializeApp({\n    credential: admin.credential.cert(serviceAccount),\n  });\n\n  const db = admin.firestore();\n\n  global.set(\"admin\", admin);\n  global.set(\"db\", db);\n  global.set(\"firestoreReady\", true);\n\n  // 3) healthcheck write (ÏÑ±Í≥µ Ïó¨Î∂Ä Î™ÖÌôïÌûà ÌôïÏù∏)\n  return db.collection(\"_healthcheck\").doc(\"init\").set({\n    ts: Date.now(),\n    project_id: serviceAccount.project_id,\n  }).then(() => {\n    node.warn(\"‚úÖ Firestore initialized!\");\n    node.warn(\"üëâ project_id = \" + serviceAccount.project_id);\n    return null;\n  }).catch(err => {\n    node.error(\"‚ùå Firestore healthcheck write failed: \" + err.message);\n    return null;\n  });\n}\n\nreturn init();\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "admin",
                "module": "firebase-admin"
            },
            {
                "var": "fs",
                "module": "fs"
            }
        ],
        "x": 610,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "2ccacb1608c5ba74",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "FS : write task (create)",
        "func": "const db = global.get(\"db\");\nif (!db) {\n    node.warn(\"Firestore not ready - skip write\");\n    return msg;\n}\n\nconst task = msg.task;\nif (!task || !task.task_id) return msg;\n\ndb.collection(\"tasks\").doc(task.task_id).set(task, { merge: true })\n    .then(() => node.warn(`FS task created: ${task.task_id}`))\n    .catch(err => node.error(err));\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1080,
        "y": 1120,
        "wires": [
            [
                "8fa070ba704430fc"
            ]
        ]
    },
    {
        "id": "58d8d616da6872e1",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "FS: update task (assigned)",
        "func": "const db = global.get(\"db\");\nif (!db) return msg;\n\nconst task = msg.task;\nif (!task || !task.task_id) return msg;\n\ndb.collection(\"tasks\").doc(task.task_id).set(task, { merge: true })\n    .then(() => node.warn(`FS task assigned: ${task.task_id}`))\n    .catch(err => node.error(err));\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1780,
        "y": 1120,
        "wires": [
            [
                "c02ac5399c925f84"
            ]
        ]
    },
    {
        "id": "241f54b35e15895f",
        "type": "delay",
        "z": "49f8711fc297a8c1",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "2",
        "nbRateUnits": "",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": true,
        "outputs": 1,
        "x": 1040,
        "y": 1420,
        "wires": [
            [
                "e5f2fa78b4c8f5b4",
                "0e18ed358d9967fb"
            ]
        ]
    },
    {
        "id": "54431a46252d1602",
        "type": "http request",
        "z": "49f8711fc297a8c1",
        "name": "",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://gms.ssafy.io/gmsapi/api.openai.com/v1/chat/completions",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 910,
        "y": 480,
        "wires": [
            [
                "7dea3543f230c5e1",
                "fd22aea86440924f"
            ]
        ]
    },
    {
        "id": "c301115701d2a789",
        "type": "mqtt out",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3c16a07776b27396",
        "x": 1930,
        "y": 520,
        "wires": []
    },
    {
        "id": "1f3be0f0cf23a955",
        "type": "telegram sender",
        "z": "49f8711fc297a8c1",
        "name": "",
        "bot": "d10c4415b361b866",
        "haserroroutput": false,
        "outputs": 1,
        "x": 1950,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "7dea3543f230c5e1",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "LLMValidate",
        "func": "const chatId = msg._tg?.chatId;\nconst raw = msg._tg?.raw || \"\";\nconst interactionId = msg._interactionId;\n\nif (!interactionId) {\n  node.error(\"LLMValidate: missing msg._interactionId\", msg);\n  return null;\n}\n\n\nfunction makeReply(content) {\n  return { payload: { chatId, type: \"message\", content } };\n}\n\nfunction fsUpdate(patch) {\n  return {\n    payload: {\n      interaction_id: interactionId,\n      updated_at: Date.now(),\n      ...patch\n    }\n  };\n}\n\n// content Í∫ºÎÇ¥Í∏∞\nlet content = msg.payload?.choices?.[0]?.message?.content || \"\";\n\n// JSONÎßå Ï∂îÏ∂ú\nfunction extractJson(text) {\n  if (!text) return null;\n  text = text.replace(/```json\\s*/g, \"\").replace(/```\\s*/g, \"\").trim();\n  const s = text.indexOf(\"{\");\n  const e = text.lastIndexOf(\"}\");\n  if (s === -1 || e === -1 || e <= s) return null;\n  return text.slice(s, e + 1);\n}\n\nconst jsonStr = extractJson(content);\nif (!jsonStr) {\n  const fsMsg = fsUpdate({\n    result: \"rejected\",\n    error: { stage: \"llm/validate\", message: \"no json extracted\" }\n  });\n  return [makeReply(\"Ï£ÑÏÜ°Ìï¥Ïöî üò• ÏöîÏ≤≠ÏùÑ Ïù¥Ìï¥ÌïòÏßÄ Î™ªÌñàÏñ¥Ïöî. Î≤ÑÌäºÏúºÎ°ú Îã§Ïãú Ìï¥Ï£ºÏÑ∏Ïöî.\"), null, fsMsg];\n}\n\nlet parsed;\ntry { parsed = JSON.parse(jsonStr); }\ncatch {\n  const fsMsg = fsUpdate({\n    result: \"rejected\",\n    error: { stage: \"llm/validate\", message: \"json parse failed\" }\n  });\n  return [makeReply(\"Ï£ÑÏÜ°Ìï¥Ïöî üò• ÏöîÏ≤≠ Ìï¥ÏÑù Í≤∞Í≥ºÍ∞Ä Íπ®Ï°åÏñ¥Ïöî. Î≤ÑÌäºÏúºÎ°ú Îã§Ïãú Ìï¥Ï£ºÏÑ∏Ïöî.\"), null, fsMsg];\n}\n\n// allow-list\nconst ALLOW_TYPE = new Set([\"deliver_water\", \"collect_cup\", \"collect_laundry\"]);\nconst ALLOW_AREA = new Set([\"USER1\", \"USER2\", \"DOCK\", \"BASE\"]);\n\nconst type = parsed.type;\nlet area = parsed.target_area;\n\n// typeÏùÄ Î∞òÎìúÏãú ÏûàÏñ¥Ïïº Ìï®\nif (!ALLOW_TYPE.has(type)) {\n  const fsMsg = fsUpdate({\n    result: \"rejected\",\n    error: { stage: \"llm/validate\", message: `type not allowed: ${String(type)}` },\n    parsed: { type: String(type || \"\"), target_area: String(parsed?.target_area || \"\"), confidence: parsed?.confidence ?? null }\n  });\n  return [makeReply(\"Î¨¥Ïä® ÏöîÏ≤≠Ïù∏ÏßÄ ÌåêÎã®ÌïòÏßÄ Î™ªÌñàÏñ¥Ïöî üò•\\nÎ≤ÑÌäºÏúºÎ°ú Îã§Ïãú ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.\"), null, fsMsg];\n}\n\n// ‚úÖ default area fallback (ÏûÑÏãú: flowÏóê Ï†ÄÏû•, ÏóÜÏúºÎ©¥ USER1)\nlet defaultArea = flow.get(\"default_area_\" + chatId);\nif (!defaultArea) defaultArea = \"USER1\";\n\n// ‚úÖ areaÍ∞Ä ÏóÜÍ±∞ÎÇò Ïù¥ÏÉÅÌïòÎ©¥ defaultÎ°ú Ï±ÑÏõÄ\nif (!ALLOW_AREA.has(area)) {\n  area = defaultArea;\n}\n\n// topic Í≤∞Ï†ï\nconst topic =\n  type === \"deliver_water\" ? \"cmd/water/request\" :\n  type === \"collect_cup\" ? \"cmd/cup/request\" :\n  \"cmd/laundry/request\";\n\n// mqtt\nconst mqttMsg = {\n  topic,\n  payload: JSON.stringify({\n    type,\n    target_area: area,\n    user_id: `tg_${chatId}`,\n    meta: {\n      source: \"telegram\",\n      input: \"text\",\n      raw,\n      default_area_used: !parsed.target_area,\n      interaction_id: interactionId\n    }\n  })\n};\n\nconst pretty =\n  type === \"deliver_water\" ? \"Î¨º Î∞∞Îã¨\" :\n  type === \"collect_cup\" ? \"Ïªµ ÏàòÍ±∞\" : \"ÏÑ∏ÌÉÅÎ¨º ÏàòÍ±∞\";\n\nconst usedMsg = (!parsed.target_area) ? ` (Í∏∞Î≥∏ ÏúÑÏπò: ${area})` : \"\";\n\nconst fsMsg = fsUpdate({\n  result: \"accepted\",\n  parsed: { type, target_area: area, confidence: parsed?.confidence ?? null }\n});\n\nreturn [makeReply(`‚úÖ ${pretty} ÏöîÏ≤≠ÏùÑ Ï†ëÏàòÌñàÏñ¥Ïöî!${usedMsg}`), mqttMsg, fsMsg];\n",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1450,
        "y": 480,
        "wires": [
            [
                "1f3be0f0cf23a955"
            ],
            [
                "c301115701d2a789"
            ],
            [
                "350dfce793e04058"
            ]
        ]
    },
    {
        "id": "fd22aea86440924f",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 6",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1160,
        "y": 500,
        "wires": []
    },
    {
        "id": "350dfce793e04058",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "write interaction(upsert)",
        "func": "const db = global.get(\"db\");\nif (!db) {\n  node.warn(\"Firestore not ready - skip interaction write\");\n  return msg;\n}\n\nconst interaction = msg.payload; // ‚úÖ Ïó¨Í∏∞!\nif (!interaction || !interaction.interaction_id) return msg;\n\ndb.collection(\"interactions\")\n  .doc(interaction.interaction_id)\n  .set(interaction, { merge: true })\n  .then(() => node.warn(`FS interaction upsert: ${interaction.interaction_id}`))\n  .catch(err => node.error(err));\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1810,
        "y": 740,
        "wires": [
            []
        ]
    },
    {
        "id": "1c0f552d8a376fcc",
        "type": "http request",
        "z": "49f8711fc297a8c1",
        "name": "",
        "method": "use",
        "ret": "bin",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1030,
        "y": 860,
        "wires": [
            [
                "04db854fab84c358"
            ]
        ]
    },
    {
        "id": "04db854fab84c358",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "Voice: build whisper request",
        "func": "const fs = global.get(\"fs\");\nconst path = global.get(\"path\");\nconst tempDir = global.get(\"tempDir\");\n\nif (!fs.existsSync(tempDir)) {\n  fs.mkdirSync(tempDir, { recursive: true });\n}\n\nconst filePath = path.join(\n  tempDir,\n  `tg_voice_${Date.now()}.oga`\n);\n\nfs.writeFileSync(filePath, msg.payload);\n\nmsg.voicePath = filePath;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1320,
        "y": 860,
        "wires": [
            [
                "37ab14c5f1fb76e5"
            ]
        ]
    },
    {
        "id": "8f2038d41f373286",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "Voice: build LLMReq for chat/completions",
        "func": "const chatId = msg._tg?.chatId;\nconst interactionId = msg._interactionId;\nconst text = (msg.payload?.text || \"\").trim();\n\nif (!text) {\n  // Ïã§Ìå®: ÌÖîÎ†àÍ∑∏Îû® ÏùëÎãµ + FS updateÎ°ú Î≥¥ÎÇ¥Í≥† ÎÅùÎÇ¥ÎèÑ Îê®\n  msg.payload = { chatId, type:\"message\", content:\"üéôÔ∏è ÏùåÏÑ±ÏùÑ Ïù∏ÏãùÌïòÏßÄ Î™ªÌñàÏñ¥Ïöî. Îã§Ïãú ÎßêÌï¥ Ï£ºÏÑ∏Ïöî.\", options:{} };\n  return [msg, null];\n}\n\n// ‚úÖ Ïó¨Í∏∞ÏÑúÎ∂ÄÌÑ∞Îäî Function1Ïù¥ ÎßåÎì§Îçò llmReqÏôÄ ÏôÑÏ†ÑÌûà ÎèôÏùºÌïú ÌòïÌÉúÎ°ú ÎßåÎì§Í∏∞\nmsg.headers = {\n  \"Content-Type\": \"application/json\",\n  \"Authorization\": `Bearer ${global.get(\"GMS_KEY\")}`\n};\n\nmsg.payload = {\n  model: \"gpt-4.1-nano\",\n  temperature: 0.2,\n  max_tokens: 200,\n  messages: [\n    {\n      role: \"system\",\n      content:\n        \"ÎÑàÎäî AGV ÏÇ¨Ïö©Ïûê Ïï±Ïùò Î™ÖÎ†π ÌååÏÑúÎã§. Î∞òÎìúÏãú JSONÎßå Ï∂úÎ†•Ìï¥.\\n\" +\n        \"ÌóàÏö© type: deliver_water, collect_cup, collect_laundry\\n\" +\n        \"ÌóàÏö© target_area: USER1, USER2, DOCK, BASE\\n\" +\n        'ÌòïÏãù: {\"type\":\"...\",\"target_area\":\"...\",\"confidence\":0.0}\\n' +\n        \"Ï∂îÎ°† ÏÑ§Î™Ö Í∏àÏßÄ. JSON Ïô∏ ÌÖçÏä§Ìä∏ Í∏àÏßÄ.\"\n    },\n    { role: \"user\", content: text }\n  ]\n};\n\n// validateÏóêÏÑú Ïì∞Îäî Î©îÌÉÄ Ïú†ÏßÄ\nmsg._tg = { chatId, raw: text };\nmsg._interactionId = interactionId;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2520,
        "y": 860,
        "wires": [
            [
                "54431a46252d1602"
            ]
        ]
    },
    {
        "id": "f65016bb2f2505ba",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "Set Url",
        "func": "// Voice: set url\nmsg.method = \"GET\";\nmsg.url = msg.weblink;              // ‚úÖ Ïã§Ï†ú Í∞í(https://api.telegram.org/...)Ïù¥ Îì§Ïñ¥Í∞ê\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 810,
        "y": 860,
        "wires": [
            [
                "1c0f552d8a376fcc"
            ]
        ]
    },
    {
        "id": "37ab14c5f1fb76e5",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "build exec cmd",
        "func": "const fs = global.get(\"fs\");\nconst key = global.get(\"GMS_KEY\");\n\nif (!msg.voicePath) { node.error(\"voicePath missing\", msg); return null; }\nif (!fs.existsSync(msg.voicePath)) { node.error(\"voice file not found: \" + msg.voicePath, msg); return null; }\n\nconst boundary = \"----NodeRedFormBoundary\" + Date.now();\nconst CRLF = \"\\r\\n\";\n\n// ÌååÏùº ÏùΩÍ∏∞ (Buffer)\nconst fileBuf = fs.readFileSync(msg.voicePath);\n\n// multipart ÌååÌä∏Îì§ ÎßåÎì§Í∏∞\nfunction partText(name, value) {\n  return Buffer.from(\n    `--${boundary}${CRLF}` +\n    `Content-Disposition: form-data; name=\"${name}\"${CRLF}${CRLF}` +\n    `${value}${CRLF}`\n  );\n}\n\nfunction partFile(name, filename, contentType, dataBuf) {\n  const head = Buffer.from(\n    `--${boundary}${CRLF}` +\n    `Content-Disposition: form-data; name=\"${name}\"; filename=\"${filename}\"${CRLF}` +\n    `Content-Type: ${contentType}${CRLF}${CRLF}`\n  );\n  const tail = Buffer.from(CRLF);\n  return Buffer.concat([head, dataBuf, tail]);\n}\n\nconst end = Buffer.from(`--${boundary}--${CRLF}`);\n\nconst body = Buffer.concat([\n  partText(\"model\", \"whisper-1\"),\n  partFile(\"file\", \"voice.oga\", \"audio/ogg\", fileBuf),\n  end\n]);\n\nmsg.method = \"POST\";\nmsg.url = \"https://gms.ssafy.io/gmsapi/api.openai.com/v1/audio/transcriptions\";\nmsg.headers = {\n  \"Authorization\": `Bearer ${key}`,\n  \"Content-Type\": `multipart/form-data; boundary=${boundary}`,\n  \"Content-Length\": body.length\n};\nmsg.payload = body;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1620,
        "y": 860,
        "wires": [
            [
                "44fe72582d9db9b2"
            ]
        ]
    },
    {
        "id": "996820a5df9eae6f",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "parse whisper result",
        "func": "let obj = null;\ntry {\n  obj = JSON.parse(msg.payload);\n} catch (e) {\n  node.error(\"Whisper response not JSON\", msg);\n  return null;\n}\n\nconst text = (obj.text || \"\").trim();\nif (!text) {\n  msg.payload = { text: \"\" };\n  return msg;\n}\n\n// ------------------------------\n// ‚úÖ Ïó¨Í∏∞Î∂ÄÌÑ∞ Ï∂îÍ∞Ä: Firestore interaction Ï†ïÎ¶¨(clean-up)\n// - raw_input = STT ÌÖçÏä§Ìä∏Î°ú ÎçÆÏñ¥Ïì∞Í∏∞\n// - meta(weblink Îì±) ÏÇ≠Ï†ú\n// ------------------------------\nconst db = global.get(\"db\");\nconst admin = global.get(\"admin\");        // globalÏóê admin Ïò¨Î†§Îëî Í≤ΩÏö∞\nconst interactionId = msg._interactionId; // voice ÌååÏù¥ÌîÑÏóêÏÑú Ïú†ÏßÄ Ï§ëÏù∏ Í∞í\n\nif (db && admin && interactionId) {\n  const FieldValue = admin.firestore.FieldValue;\n\n  db.collection(\"interactions\").doc(interactionId).set({\n    raw_input: text,                 // ‚úÖ Ï†ïÏ†úÎêú ÌÖçÏä§Ìä∏Î°ú ÍµêÏ≤¥\n    meta: FieldValue.delete(),       // ‚úÖ meta ÌÜµÏß∏Î°ú Ï†úÍ±∞\n    updated_at: Date.now()\n  }, { merge: true })\n    .then(() => node.warn(`FS voice cleaned: ${interactionId}`))\n    .catch(err => node.error(err));\n} else {\n  node.warn(\"FS cleanup skipped (missing db/admin/interactionId)\");\n}\n\n// Îã§Ïùå ÎÖ∏ÎìúÎ°ú text ÎÑòÍ∏∞Í∏∞\nmsg.payload = { text };\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2140,
        "y": 860,
        "wires": [
            [
                "8f2038d41f373286"
            ]
        ]
    },
    {
        "id": "44fe72582d9db9b2",
        "type": "http request",
        "z": "49f8711fc297a8c1",
        "name": "",
        "method": "use",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1870,
        "y": 860,
        "wires": [
            [
                "996820a5df9eae6f"
            ]
        ]
    },
    {
        "id": "a48e6f6a29608a99",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-telegrambot": "17.0.3",
            "node-red-dashboard": "3.6.6"
        }
    }
]