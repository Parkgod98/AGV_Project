[
    {
        "id": "49f8711fc297a8c1",
        "type": "tab",
        "label": "ÌîåÎ°úÏö∞ 1",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "048a808c4f50c1eb",
        "type": "telegram receiver",
        "z": "49f8711fc297a8c1",
        "name": "",
        "bot": "d10c4415b361b866",
        "saveDataDir": "",
        "filterCommands": false,
        "hasinput": false,
        "inputs": 0,
        "handleallupdates": false,
        "x": 350,
        "y": 480,
        "wires": [
            [
                "7476d3bed8965c26"
            ],
            []
        ]
    },
    {
        "id": "d1e13ead5e796c2d",
        "type": "telegram sender",
        "z": "49f8711fc297a8c1",
        "name": "",
        "bot": "d10c4415b361b866",
        "haserroroutput": false,
        "outputs": 1,
        "x": 1170,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "7476d3bed8965c26",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "function 1",
        "func": "function pad(n, w = 2) { return String(n).padStart(w, '0'); }\n\n// KST Í∏∞Ï§Ä: YYYYMMDD_HHMMSS_mmm\nfunction tsKST() {\n  const k = new Date(Date.now() + 9 * 60 * 60 * 1000); // UTC+9\n  const y = k.getUTCFullYear();\n  const mo = pad(k.getUTCMonth() + 1);\n  const d = pad(k.getUTCDate());\n  const hh = pad(k.getUTCHours());\n  const mm = pad(k.getUTCMinutes());\n  const ss = pad(k.getUTCSeconds());\n  const ms = pad(k.getUTCMilliseconds(), 3);\n  return `${y}${mo}${d}_${hh}${mm}${ss}_${ms}`;\n}\n\nfunction makeInteractionId(chatId, mode) {\n  const ts = tsKST();\n  const safeMode = (mode || \"text\").toLowerCase();\n  return `it_${ts}_tg_${chatId}_${safeMode}`;\n}\n\nfunction makeMqtt(chatId, text, interactionId, topic, type, target_area, inputKind) {\n  return {\n    topic,\n    payload: JSON.stringify({\n      type,\n      target_area,\n      user_id: `tg_${chatId}`,\n      meta: { source: \"telegram\", input: inputKind, raw: text, interaction_id: interactionId }\n    })\n  };\n}\n\nfunction makeFsMsg(interactionObj) {\n  // task_idÎäî null ÎçÆÏñ¥Ïì∞Í∏∞ Î∞©ÏßÄ(ÏïÑÏòà Ï†úÍ±∞)\n  const copy = { ...interactionObj };\n  if (\"task_id\" in copy) delete copy.task_id;\n  return { payload: copy };\n}\n\nfunction makeInteractionBase(chatId, interactionId, inputMode, rawInput) {\n  return {\n    ts: Date.now(),\n    interaction_id: interactionId,\n    source: \"telegram\",\n    user_id: `tg_${chatId}`,\n    input_mode: inputMode,\n    raw_input: rawInput,\n    parsed: null,\n    result: \"pending\",\n    error: null\n  };\n}\n\n// -------------------- ÏûÖÎ†• Ï∂îÏ∂ú --------------------\nconst chatId = msg.payload?.chatId;\nconst text = (msg.payload?.content || \"\").trim();\n\n// WebApp URL\nconst WEBAPP_URL = global.get(\"WEBAPP_URL\") || \"https://subaru-pod-visit-woods.trycloudflare.com/user\";\n\n// Î≤ÑÌäº Î™©Î°ù(Ï†ïÌôïÌûà Îß§Ïπ≠)\nconst BUTTONS = new Set([\n  \"‚òï Î¨º Í∞ÄÏ†∏ÏôÄÏ§ò\",\n  \"ü•§ Ïªµ Í∞ÄÏ†∏Í∞ÄÏ§ò\",\n  \"üßπ ÌôòÍ≤Ω Ï†ïÎ¶¨Ìï¥Ï§ò\",\n  \"üìç ÏßÄÍ∏à ÏÉÅÌÉú ÏïåÎ†§Ï§ò\",\n  \"üìä Î¶¨Ìè¨Ìä∏ & ÎåÄÏãúÎ≥¥Îìú Ïó¥Í∏∞\"\n]);\n\n// -------------------- 0) voice (Í∞ÄÏû• Î®ºÏ†Ä return) --------------------\nif (msg.payload?.type === \"voice\" && msg.payload?.weblink) {\n  const interactionId = makeInteractionId(chatId, \"voice\");\n  msg._interactionId = interactionId;\n\n  const weblink = msg.payload.weblink;\n  const fileId = msg.payload.content;\n\n  const interaction = makeInteractionBase(chatId, interactionId, \"voice\", fileId);\n  interaction.meta = { weblink };\n\n  const tgMsg = {\n    ...msg,\n    payload: { chatId, type: \"message\", content: \"üéôÔ∏è ÏùåÏÑ± Ïù∏Ïãù Ï§ëÏù¥ÏóêÏöî‚Ä¶\", options: {} }\n  };\n\n  const sttMsg = {\n    _tg: { chatId },\n    _interactionId: interactionId,\n    weblink\n  };\n\n  // out1: tg, out4: fs, out5: stt\n  return [tgMsg, null, null, makeFsMsg(interaction), sttMsg];\n}\n\n// -------------------- 1) Îπà ÏûÖÎ†• --------------------\nif (!text) {\n  const interactionId = makeInteractionId(chatId, \"text\");\n  msg._interactionId = interactionId;\n\n  const interaction = makeInteractionBase(chatId, interactionId, \"text\", text);\n  interaction.result = \"rejected\";\n  interaction.error = { stage: \"input\", message: \"empty text\" };\n\n  msg.payload = {\n    chatId, type: \"message\",\n    content: \"ÎÇ¥Ïö©Ïù¥ ÎπÑÏñ¥ ÏûàÏñ¥Ïöî üôÇ\\nÏïÑÎûò Î≤ÑÌäºÏùÑ ÎàåÎü¨ÏÑú ÏöîÏ≤≠Ìï¥ Ï£ºÏÑ∏Ïöî.\",\n    options: {}\n  };\n  return [msg, null, null, makeFsMsg(interaction)];\n}\n\n// -------------------- 2) /start --------------------\nif (text === \"/start\") {\n  const interactionId = makeInteractionId(chatId, \"command\");\n  msg._interactionId = interactionId;\n\n  if (!flow.get(\"default_area_\" + chatId)) flow.set(\"default_area_\" + chatId, \"USER1\");\n\n  const interaction = makeInteractionBase(chatId, interactionId, \"command\", text);\n  interaction.result = \"accepted\";\n\n  msg.payload = {\n    chatId,\n    type: \"message\",\n    content: \"ÏïàÎÖïÌïòÏÑ∏Ïöî! AGV ÏÑúÎπÑÏä§ Î¥á ÌòÑÏÑ±Ïù¥ÏûÖÎãàÎã§.\\nÎ¨¥ÏóáÏùÑ ÎèÑÏôÄÎìúÎ¶¥ÍπåÏöî?\",\n    options: {\n      reply_markup: {\n        keyboard: [\n          [\"‚òï Î¨º Í∞ÄÏ†∏ÏôÄÏ§ò\", \"ü•§ Ïªµ Í∞ÄÏ†∏Í∞ÄÏ§ò\"],\n          [\"üßπ ÌôòÍ≤Ω Ï†ïÎ¶¨Ìï¥Ï§ò\"],\n          [\"üìç ÏßÄÍ∏à ÏÉÅÌÉú ÏïåÎ†§Ï§ò\", \"üìä Î¶¨Ìè¨Ìä∏ & ÎåÄÏãúÎ≥¥Îìú Ïó¥Í∏∞\"]\n        ],\n        resize_keyboard: true,\n        one_time_keyboard: false\n      }\n    }\n  };\n\n  return [msg, null, null, makeFsMsg(interaction)];\n}\n\n// -------------------- 3) button --------------------\nif (BUTTONS.has(text)) {\n  const interactionId = makeInteractionId(chatId, \"button\");\n  msg._interactionId = interactionId;\n\n  const interaction = makeInteractionBase(chatId, interactionId, \"button\", text);\n\n  // Í∏∞Î≥∏ ÌÉÄÍ≤ü(ÏßÄÍ∏àÏùÄ USER1 Í≥†Ï†ï, ÎÇòÏ§ëÏóê default_areaÎ°ú Î∞îÍøîÎèÑ Îê®)\n  const area = \"USER1\";\n\n  // Î≤ÑÌäºÎ≥Ñ Ï≤òÎ¶¨\n  if (text === \"‚òï Î¨º Í∞ÄÏ†∏ÏôÄÏ§ò\") {\n    interaction.parsed = { type: \"deliver_water\", target_area: area, confidence: 1.0 };\n    interaction.result = \"accepted\";\n\n    const mqttMsg = makeMqtt(chatId, text, interactionId, \"cmd/water/request\", \"deliver_water\", area, \"button\");\n\n    msg.payload = {\n      chatId, type: \"message\",\n      content: \"Î¨º Î∞∞Îã¨ ÏöîÏ≤≠ÏùÑ Ï†ëÏàòÌñàÏñ¥Ïöî üíß\\nÍ∏àÎ∞© Í∞ñÎã§ÎìúÎ¶¥Í≤åÏöî!\",\n      options: {}\n    };\n\n    return [msg, mqttMsg, null, makeFsMsg(interaction)];\n  }\n\n  if (text === \"ü•§ Ïªµ Í∞ÄÏ†∏Í∞ÄÏ§ò\") {\n    interaction.parsed = { type: \"collect_cup\", target_area: area, confidence: 1.0 };\n    interaction.result = \"accepted\";\n\n    const mqttMsg = makeMqtt(chatId, text, interactionId, \"cmd/cup/request\", \"collect_cup\", area, \"button\");\n\n    msg.payload = {\n      chatId, type: \"message\",\n      content: \"Ïªµ ÌöåÏàò ÏöîÏ≤≠ÏùÑ Ï†ëÏàòÌñàÏñ¥Ïöî ü•§\\nÎ∞îÎ°ú Ï≤òÎ¶¨Ìï†Í≤åÏöî!\",\n      options: {}\n    };\n\n    return [msg, mqttMsg, null, makeFsMsg(interaction)];\n  }\n\n  if (text === \"üßπ ÌôòÍ≤Ω Ï†ïÎ¶¨Ìï¥Ï§ò\") {\n    // ÎÇ¥Î∂Ä typeÏùÄ Í∏∞Ï°¥ Ïú†ÏßÄ(collect_laundry)\n    interaction.parsed = { type: \"collect_laundry\", target_area: area, confidence: 1.0 };\n    interaction.result = \"accepted\";\n\n    const mqttMsg = makeMqtt(chatId, text, interactionId, \"cmd/laundry/request\", \"collect_laundry\", area, \"button\");\n\n    msg.payload = {\n      chatId, type: \"message\",\n      content: \"ÌôòÍ≤Ω Ï†ïÎ¶¨ ÏöîÏ≤≠ÏùÑ Ï†ëÏàòÌñàÏñ¥Ïöî üßπ\\nÏ£ºÎ≥ÄÏùÑ ÍπîÎÅîÌïòÍ≤å Ï†ïÎ¶¨Ìï†Í≤åÏöî!\",\n      options: {}\n    };\n\n    return [msg, mqttMsg, null, makeFsMsg(interaction)];\n  }\n\n  if (text === \"üìç ÏßÄÍ∏à ÏÉÅÌÉú ÏïåÎ†§Ï§ò\") {\n    interaction.parsed = { type: \"show_status\", target_area: null, confidence: 1.0 };\n    interaction.result = \"accepted\";\n\n    const robots = global.get(\"robots\") || {};\n    const taskQueue = global.get(\"taskQueue\") || [];\n    const r = robots[\"agv1\"];\n\n    if (!r) {\n      msg.payload = {\n        chatId,\n        type: \"message\",\n        content: \"üìç ÏïÑÏßÅ AGV ÏÉÅÌÉúÎ•º Î™ª Î∞õÏïòÏñ¥Ïöî.\\n(Î°úÎ¥á status ÏàòÏã† ÌôïÏù∏ ÌïÑÏöî)\",\n        options: {}\n      };\n      return [msg, null, null, makeFsMsg(interaction)];\n    }\n\n    const AREA_LABEL = { BASE: \"Î≤†Ïù¥Ïä§\", DOCK: \"ÎèÑÌÇπ\", USER1: \"ÏÇ¨Ïö©Ïûê Íµ¨Ïó≠ 1\", USER2: \"ÏÇ¨Ïö©Ïûê Íµ¨Ïó≠ 2\" };\n    const TASK_LABEL = { deliver_water: \"‚òï Î¨º Î∞∞Îã¨\", collect_cup: \"ü•§ Ïªµ ÌöåÏàò\", collect_laundry: \"üßπ ÌôòÍ≤Ω Ï†ïÎ¶¨\" };\n\n    function areaName(a) { return AREA_LABEL[a] || a || \"‚Äî\"; }\n\n    const state = (r.state || \"unknown\").toLowerCase();\n    const prettyState =\n      (r.error_code) ? \"Ïò§Î•ò ‚ùó\" :\n        (state === \"running\") ? \"Ïù¥Îèô Ï§ë üöö\" :\n          (state === \"idle\") ? \"ÎåÄÍ∏∞ Ï§ë ‚úÖ\" :\n            (state === \"charging\") ? \"Ï∂©Ï†Ñ Ï§ë üîå\" : state;\n\n    // ÌòÑÏû¨ task Ï∞æÍ∏∞: robot.task_id Ïö∞ÏÑ†\n    let t = null;\n    if (r.task_id) t = taskQueue.find(x => x.task_id === r.task_id) || null;\n    if (!t) t = taskQueue.find(x => x.assigned_robot === \"agv1\" && x.status === \"running\") || null;\n\n    const lines = [];\n    lines.push(`üìç AGV ÏÉÅÌÉú: ${prettyState}`);\n    if (r.battery != null) lines.push(`üîã Î∞∞ÌÑ∞Î¶¨: ${r.battery}%`);\n    if (r.area) lines.push(`üìå ÏúÑÏπò: ${areaName(r.area)}`);\n    if (r.error_code) lines.push(`‚ö†Ô∏è ÏõêÏù∏: ${r.error_code}`);\n\n    if (!t) {\n      lines.push(\"\");\n      lines.push(\"üßæ ÏßÑÌñâ Ï§ë ÏûëÏóÖ: ÏóÜÏùå\");\n    } else {\n      const label = TASK_LABEL[t.type] || t.type || \"ÏûëÏóÖ\";\n      const target = areaName(t.target_area);\n\n      // ÎÇ®ÏùÄÏãúÍ∞Ñ Í≥ÑÏÇ∞ (Î≤ÑÌäº ÎàÑÎ•º ÎïåÎßàÎã§ 20‚Üí15Ï≤òÎüº Í∞êÏÜå)\n      const expectedMs = Number(t.expected_duration_ms || 0);\n      const startedAt = Number(t.started_at || t.created_at || 0);\n      let remainSec = null;\n\n      if (expectedMs > 0 && startedAt > 0 && (state === \"running\" || t.status === \"running\")) {\n        const elapsedMs = Date.now() - startedAt;\n        const remainMs = Math.max(0, expectedMs - elapsedMs);\n        remainSec = Math.ceil(remainMs / 1000);\n      } else if (expectedMs > 0) {\n        remainSec = Math.ceil(expectedMs / 1000); // ÏïÑÏßÅ running Ï†ÑÏù¥Î©¥ \"ÏòàÏÉÅ\"Îßå ÌëúÏãú\n      }\n\n      lines.push(\"\");\n      lines.push(`üßæ ÏßÑÌñâ Ï§ë ÏûëÏóÖ: ${label} ‚Üí ${target}`);\n      if (remainSec != null) lines.push(`‚è≥ ÏòàÏÉÅ ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ÏïΩ ${remainSec}Ï¥à`);\n    }\n\n    msg.payload = {\n      chatId,\n      type: \"message\",\n      content: lines.join(\"\\n\"),\n      options: {}\n    };\n\n    return [msg, null, null, makeFsMsg(interaction)];\n  }\n\n\n  if (text === \"üìä Î¶¨Ìè¨Ìä∏ & ÎåÄÏãúÎ≥¥Îìú Ïó¥Í∏∞\") {\n    interaction.parsed = { type: \"open_dashboard\", target_area: null, confidence: 1.0 };\n    interaction.result = \"accepted\";\n\n    msg.payload = {\n      chatId,\n      type: \"message\",\n      content: \"üìä Î¶¨Ìè¨Ìä∏ & ÎåÄÏãúÎ≥¥ÎìúÎ•º Ïó¥Ïñ¥ÎìúÎ¶¥Í≤åÏöî üôÇ\",\n      options: {\n        reply_markup: {\n          inline_keyboard: [[\n            { text: \"Ïó¥Í∏∞\", web_app: { url: WEBAPP_URL } }\n          ]]\n        }\n      }\n    };\n\n    return [msg, null, null, makeFsMsg(interaction)];\n  }\n}\n\n// -------------------- 4) Í∑∏ Ïô∏ = text ‚Üí LLM --------------------\n{\n  const interactionId = makeInteractionId(chatId, \"text\");\n  msg._interactionId = interactionId;\n\n  const interaction = makeInteractionBase(chatId, interactionId, \"text\", text);\n  interaction.result = \"pending\";\n\n  msg.payload = {\n    chatId,\n    type: \"message\",\n    content: \"ÏöîÏ≤≠ÏùÑ ÌôïÏù∏ÌïòÍ≥† ÏûàÏñ¥Ïöî ü§ñ\\nÏû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.\",\n    options: {}\n  };\n\n  const llmReq = {\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"Authorization\": `Bearer ${global.get(\"GMS_KEY\")}`\n    },\n    payload: {\n      model: \"gpt-4.1-nano\",\n      temperature: 0.2,\n      max_tokens: 200,\n      messages: [\n        {\n          role: \"system\",\n          content:\n            \"ÎÑàÎäî AGV ÏÇ¨Ïö©Ïûê Ïï±Ïùò Î™ÖÎ†π ÌååÏÑúÎã§. Î∞òÎìúÏãú JSONÎßå Ï∂úÎ†•Ìï¥.\\n\" +\n            \"ÌóàÏö© type: deliver_water, collect_cup, collect_laundry\\n\" +\n            \"ÌóàÏö© target_area: USER1, USER2, DOCK, BASE\\n\" +\n            \"ÏÇ¨Ïö©Ïûê ÌëúÌòÑ 'ÌôòÍ≤Ω Ï†ïÎ¶¨/Î∞îÎã• Ï†ïÎ¶¨/Ï†ïÎ¶¨Ìï¥Ï§ò' Îäî collect_laundryÎ°ú Îß§ÌïëÌï¥.\\n\" +\n            'ÌòïÏãù: {\"type\":\"...\",\"target_area\":\"...\",\"confidence\":0.0}\\n' +\n            \"Ï∂îÎ°† ÏÑ§Î™Ö Í∏àÏßÄ. JSON Ïô∏ ÌÖçÏä§Ìä∏ Í∏àÏßÄ.\"\n        },\n        { role: \"user\", content: text }\n      ]\n    },\n    _tg: { chatId, raw: text },\n    _interactionId: interactionId\n  };\n\n  // out1: tg reply, out3: llm, out4: fs\n  return [msg, null, llmReq, makeFsMsg(interaction)];\n}\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 480,
        "wires": [
            [
                "d1e13ead5e796c2d"
            ],
            [
                "6b5f1a99de2569f0"
            ],
            [
                "54431a46252d1602"
            ],
            [
                "350dfce793e04058"
            ],
            [
                "f65016bb2f2505ba"
            ]
        ]
    },
    {
        "id": "6b5f1a99de2569f0",
        "type": "mqtt out",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3c16a07776b27396",
        "x": 1130,
        "y": 320,
        "wires": []
    },
    {
        "id": "bea82cdd7f9e1fa3",
        "type": "mqtt in",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "cmd/+/request",
        "qos": "2",
        "datatype": "utf8",
        "broker": "3c16a07776b27396",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 350,
        "y": 1120,
        "wires": [
            [
                "e0253ffdf7c81394",
                "084632d493b02014"
            ]
        ]
    },
    {
        "id": "e0253ffdf7c81394",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "function 2",
        "func": "function pad(n, w=2){ return String(n).padStart(w,'0'); }\n\n// KST Í∏∞Ï§Ä ÌÖçÏä§Ìä∏ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏÉùÏÑ±\nfunction tsKST() {\n  const k = new Date(Date.now() + 9*60*60*1000); // UTC+9\n  const y = k.getUTCFullYear();\n  const mo = pad(k.getUTCMonth()+1);\n  const d = pad(k.getUTCDate());\n  const hh = pad(k.getUTCHours());\n  const mm = pad(k.getUTCMinutes());\n  const ss = pad(k.getUTCSeconds());\n  const ms = pad(k.getUTCMilliseconds(), 3);\n  return `${y}${mo}${d}_${hh}${mm}${ss}_${ms}`; // 20251216_000305_123\n}\n\nlet data = {};\ntry {\n    data = JSON.parse(msg.payload || '{}');\n} catch (e) {\n    node.error('Invalid JSON payload in cmd request', msg);\n    return null;\n}\n\n// ‚úÖ interaction_id Ï∂îÏ∂ú (telegram/llmÏóêÏÑú metaÎ°ú ÎÑ£Ïñ¥Ï§Ä Í∞í)\nconst interactionId = data?.meta?.interaction_id || null;\n\n// Í∏ÄÎ°úÎ≤å taskQueue Í∞ÄÏ†∏Ïò§Í∏∞ (ÏóÜÏúºÎ©¥ Îπà Î∞∞Ïó¥)\nlet queue = global.get('taskQueue') || [];\n\n// task_id ÏÉùÏÑ±\nconst ts = tsKST();\nconst area = (data.target_area || 'USER1').toUpperCase();\nconst typeForId = (data.type || 'unknown').toLowerCase(); // ÌòπÏùÄ taskType Í≥ÑÏÇ∞ Ïù¥ÌõÑ ÏÇ¨Ïö©Ìï¥ÎèÑ Îê®\n\nconst taskId = interactionId;   // ‚úÖ task_id = interaction_id\n\n// type Í≤∞Ï†ï\nconst taskType = data.type || (() => {\n    if (msg.topic.startsWith('cmd/water/')) \n        return 'deliver_water';\n    if (msg.topic.startsWith('cmd/cup/')) \n        return 'collect_cup';\n    if (msg.topic.startsWith('cmd/laundry/')) \n        return 'collect_laundry';\n    return 'unknown';\n})();\n\nfunction normTargetArea(raw) {\n  const s = String(raw || \"\").toUpperCase();\n\n  const map = {\n    // Ïòõ Ïù¥Î¶Ñ Ìò∏Ìôò\n    USER1: \"RES_A\",\n    USER2: \"RES_B\",\n    USER3: \"RES_C\",\n    BASE:  \"CHARGE\",\n    HOME:  \"CHARGE\",\n    DOCK:  \"CHARGE\",\n  };\n\n  if (map[s]) return map[s];\n\n  // Ïù¥ÎØ∏ ÏÉà Ïù¥Î¶ÑÏù¥Î©¥ Í∑∏ÎåÄÎ°ú\n  if ([\"CHARGE\",\"WATER\",\"DROP\",\"RES_A\",\"RES_B\",\"RES_C\"].includes(s)) return s;\n\n  // ÎîîÌè¥Ìä∏: Í∞ÄÏö¥Îç∞ Ïú†Ï†ÄÍ≥µÍ∞Ñ\n  return \"RES_B\";\n}\n\n// Task Í∞ùÏ≤¥ (v0.1)\nconst task = {\n    task_id: taskId,\n    type: taskType,\n    target_area: normTargetArea(data.target_area || \"RES_B\"),\n    user_id: data.user_id || null,\n\n    // ‚úÖ Ïó∞Í≤∞ ÌÇ§\n    interaction_id: interactionId,\n\n    status: 'pending',\n    created_at: Date.now(),\n};\n\n// ---- ÏòàÏÉÅ ÏÜåÏöîÏãúÍ∞Ñ(ms) : EMAÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏Í±∏ Ïì∞Í≥†, ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í ----\nconst taskStats = global.get(\"taskStats\") || {};        // { deliver_water: { ema_ms, n }, ... }\nconst baseMsMap = { deliver_water: 20000, collect_cup: 15000, collect_laundry: 25000, unknown: 20000 };\n\nconst stat = taskStats[taskType];\nconst expectedMs = (stat && stat.ema_ms) ? Math.round(stat.ema_ms) : (baseMsMap[taskType] || 20000);\n\ntask.expected_duration_ms = expectedMs;\ntask.expected_duration_s = Math.ceil(expectedMs / 1000);\ntask.eta_basis = (stat && stat.ema_ms) ? \"ema\" : \"default\";\n\n// ÌÅêÏóê push\nqueue.push(task);\nglobal.set('taskQueue', queue);\n\n// ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏\nnode.warn({ action: 'TASK_CREATED', task });\n\n// ‚úÖ interaction Î¨∏ÏÑúÏóê task_id backfill (ÏóÖÏÑúÌä∏)\nconst db = global.get(\"db\");\n\n// ‚úÖ (Ï∂îÍ∞Ä) Firestore tasks Î¨∏ÏÑúÎèÑ ÏÉùÏÑ±/ÏóÖÏÑúÌä∏\nif (db && taskId) {\n  db.collection(\"tasks\").doc(taskId).set({\n    ...task,\n    // ÌòπÏãú payloadÎäî JSON stringify ÌñàÏùÑ ÏàòÎèÑ ÏûàÏúºÎãà ÏïàÏ†ÑÌïòÍ≤å Ïà´Ïûê Î≥¥Ïû•\n    expected_duration_ms: Number(task.expected_duration_ms || expectedMs),\n    created_at: task.created_at || Date.now(),\n  }, { merge: true })\n  .catch(err => node.error(\"[tasks create] \" + err));\n}\n\nif (db && interactionId) {\n    db.collection(\"interactions\").doc(interactionId).set({\n        task_id: taskId,\n        linked_at: Date.now()\n    }, { merge: true })\n    .then(() => node.warn(`FS interaction linked: ${interactionId} -> ${taskId}`))\n    .catch(err => node.error(err));\n}\n\n// ÏïÑÎûòÎ°ú ÎÑòÍ≤®Ï§Ñ Î©îÏãúÏßÄ ÏÑ∏ÌåÖ\nmsg.task = task;\nmsg.payload = JSON.stringify(task);\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 1120,
        "wires": [
            [
                "2ccacb1608c5ba74"
            ]
        ]
    },
    {
        "id": "8fa070ba704430fc",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "function 3",
        "func": "// // // v0.1: Îì§Ïñ¥Ïò® taskÎ•º Î¨¥Ï°∞Í±¥ agv1Ïóê Î∞îÎ°ú Ìï†ÎãπÌï¥ÏÑú Î≥¥ÎÉÑ\n\n// // let task = msg.task;\n// // if (!task) {\n// //     node.warn('No task found in msg');\n// //     return null;\n// // }\n\n// // // ÏÉÅÌÉú Î≥ÄÍ≤Ω\n// // task.status = 'running';\n// // task.assigned_robot = 'agv1';\n// // task.started_at = Date.now();\n\n// // // Í∏ÄÎ°úÎ≤å ÌÅêÏóêÎèÑ Î∞òÏòÅ\n// // let queue = global.get('taskQueue') || [];\n// // for (let i = 0; i < queue.length; i++) {\n// //     if (queue[i].task_id === task.task_id) {\n// //         queue[i] = task;\n// //         break;\n// //     }\n// // }\n// // global.set('taskQueue', queue);\n\n// // // ÎîîÎ≤ÑÍ∑∏Ïö©\n// // node.warn({ action: 'TASK_ASSIGNED', task: task });\n\n// // // Ïù¥ msgÎ•º mqtt outÏúºÎ°ú Î≥¥ÎÇº Ï§ÄÎπÑ\n// // msg.topic = 'robot/agv1/task';\n// // msg.payload = JSON.stringify(task);\n\n// // return msg;\n\n\n// // function3: Dispatcher/Scheduler v1\n// // Ìò∏Ï∂ú ÌÉÄÏù¥Î∞ç:\n// //  1) ÏÉà task ÏÉùÏÑ± ÏßÅÌõÑ(function2 -> function3)\n// //  2) Î°úÎ¥á ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ(updateStatus -> function3)\n// // ÎèôÏûë:\n// //  - Î°úÎ¥áÏù¥ runningÏù¥Î©¥ ÏïÑÎ¨¥ Í≤ÉÎèÑ Ïïà Ìï®\n// //  - idleÏù¥Î©¥ queueÏóêÏÑú Îã§Ïùå pending 1Í∞ú Í∫ºÎÇ¥ÏÑú runningÏúºÎ°ú Ï†ÑÌôò ÌõÑ publish\n\n// const robotId = \"agv1\";\n\n// // 0) Í∏ÄÎ°úÎ≤å ÏÉÅÌÉú ÏùΩÍ∏∞\n// let robots = global.get(\"robots\") || {};\n// let queue = global.get(\"taskQueue\") || [];\n\n// // robots Í∏∞Î≥∏Í∞í Î≥¥Ï†ï\n// if (!robots[robotId]) {\n//     robots[robotId] = {\n//         robot_id: robotId,\n//         state: \"idle\",\n//         task_id: null,\n//         updated_at: Date.now()\n//     };\n// }\n\n// // 1) Î°úÎ¥áÏù¥ Î∞îÏÅòÎ©¥ Ìå®Ïä§ (Ïù¥Í≤å ‚ÄúÎ∞îÏÅ† ÎïåÎäî Ìï†Îãπ Ïïà Îê®‚ÄùÏùò Ï†ïÏ≤¥)\n// if (robots[robotId].state === \"running\") {\n//     return null;\n// }\n\n// // 2) queueÏóê Ïù¥ÎØ∏ runningÏù¥ ÏûàÏúºÎ©¥(ÏÉÅÌÉú Íº¨ÏûÑ Î∞©ÏßÄ) Ìå®Ïä§\n// const hasRunning = queue.some(t => t.assigned_robot === robotId && t.status === \"running\");\n// if (hasRunning) return null;\n\n// // 3) Îã§Ïùå task ÏÑ†ÌÉù (FIFO + ÌïÑÏöîÌïòÎ©¥ type Ïö∞ÏÑ†ÏàúÏúÑ)\n// // ‚ÄúÎ¨º Î®ºÏ†Ä‚Äù Î≥¥Ïû•ÏùÑ ÏõêÌïòÎ©¥ PRIORITYÎ•º ÏÇ¨Ïö©\n// const PRIORITY = { deliver_water: 10, collect_cup: 20, collect_laundry: 30, unknown: 99 };\n\n// let candidates = queue\n//     .map((t, idx) => ({ t, idx }))\n//     .filter(x => (x.t.status === \"pending\" || x.t.status === \"queued\") && !x.t.assigned_robot);\n\n// if (candidates.length === 0) return null;\n\n// candidates.sort((a, b) => {\n//     const pa = PRIORITY[a.t.type] ?? 99;\n//     const pb = PRIORITY[b.t.type] ?? 99;\n//     if (pa !== pb) return pa - pb;\n//     return (a.t.created_at || 0) - (b.t.created_at || 0); // FIFO\n// });\n\n// let { t: task, idx } = candidates[0];\n\n// // 4) running Ï†ÑÌôò + queue Î∞òÏòÅ\n// task.status = \"running\";\n// task.assigned_robot = robotId;\n// task.started_at = Date.now();\n\n// queue[idx] = task;\n// global.set(\"taskQueue\", queue);\n\n// // 5) robots ÏÉÅÌÉúÎèÑ runningÏúºÎ°ú ÏÑ†Î∞òÏòÅ(Î†àÏù¥Ïä§ Î∞©ÏßÄ)\n// robots[robotId] = {\n//     ...robots[robotId],\n//     state: \"running\",\n//     task_id: task.task_id,\n//     updated_at: Date.now()\n// };\n// global.set(\"robots\", robots);\n\n// // 6) Îã§Ïùå ÎÖ∏ÎìúÎì§(FS update task, mqtt out)Î°ú ÎÑòÍ∏∏ msg Íµ¨ÏÑ±\n// msg.task = task;\n// msg.topic = `robot/${robotId}/task`;\n// msg.payload = JSON.stringify(task);\n\n// node.warn({ action: \"TASK_DISPATCHED\", task_id: task.task_id, type: task.type });\n\n// return msg;\n\n\nconst robotId = \"agv1\";\nconst now = Date.now();\n\n// 0) Í∏ÄÎ°úÎ≤å ÏÉÅÌÉú ÏùΩÍ∏∞\nlet robots = global.get(\"robots\") || {};\nlet queue = global.get(\"taskQueue\") || [];\n\n// ‚úÖ NEW) (Ï§ëÏöî) msg.task / msg.payloadÎ°ú Îì§Ïñ¥Ïò® taskÎ•º global.taskQueueÏóê ÏûêÎèôÏúºÎ°ú ÎÑ£Ïñ¥Ï§å\nlet incomingTask = msg.task || null;\nif (!incomingTask && typeof msg.payload === \"string\") {\n  try { incomingTask = JSON.parse(msg.payload); } catch {}\n}\nif (incomingTask && incomingTask.task_id) {\n  const exists = queue.some(t => t.task_id === incomingTask.task_id);\n  if (!exists) {\n    queue.push(incomingTask);\n    global.set(\"taskQueue\", queue);\n    node.warn({ action: \"ENQUEUE_TASK\", task_id: incomingTask.task_id, status: incomingTask.status, qlen: queue.length });\n  }\n}\n\n// robots Í∏∞Î≥∏Í∞í Î≥¥Ï†ï\nif (!robots[robotId]) {\n  robots[robotId] = {\n    robot_id: robotId,\n    state: \"idle\",\n    task_id: null,\n    updated_at: now\n  };\n}\n\n// ‚úÖ NEW) Î°úÎ¥á running stuck Î∞©ÏßÄ: ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏Í∞Ä ÎÑàÎ¨¥ Ïò§ÎûòÎêêÏúºÎ©¥ idleÎ°ú Î¶¨ÏÖã(Ïïà Í∑∏Îü¨Î©¥ ÏòÅÏõêÌûà dispatch Ïïà Îê®)\nconst STALE_MS = 15000;\nif (robots[robotId].state === \"running\") {\n  const upd = Number(robots[robotId].updated_at || 0);\n  if (upd && (now - upd > STALE_MS)) {\n    node.warn({ action: \"ROBOT_STALE_RESET\", robot_state: robots[robotId].state, task_id: robots[robotId].task_id, updated_at: upd });\n    robots[robotId].state = \"idle\";\n    robots[robotId].task_id = null;\n    robots[robotId].updated_at = now;\n    global.set(\"robots\", robots);\n  }\n}\n\n// 1) Î°úÎ¥áÏù¥ Î∞îÏÅòÎ©¥ Ìå®Ïä§\nif (robots[robotId].state === \"running\") {\n  node.warn({ action: \"DISPATCH_SKIP\", reason: \"robot_running\", robot: robots[robotId] });\n  return null;\n}\n\n// 2) queueÏóê Ïù¥ÎØ∏ runningÏù¥ ÏûàÏúºÎ©¥ Ìå®Ïä§\nconst hasRunning = queue.some(t => t.assigned_robot === robotId && t.status === \"running\");\nif (hasRunning) {\n  const rt = queue.find(t => t.assigned_robot === robotId && t.status === \"running\");\n  node.warn({ action: \"DISPATCH_SKIP\", reason: \"queue_has_running\", running_task: rt?.task_id, qlen: queue.length });\n  return null;\n}\n\n// 3) ÌõÑÎ≥¥ ÏÑ†ÌÉù\nconst PRIORITY = { deliver_water: 10, collect_cup: 20, collect_laundry: 30, unknown: 99 };\n\nlet candidates = queue\n  .map((t, idx) => ({ t, idx }))\n  .filter(x => (x.t.status === \"pending\" || x.t.status === \"queued\") && !x.t.assigned_robot);\n\nif (candidates.length === 0) {\n  node.warn({ action: \"DISPATCH_SKIP\", reason: \"no_candidates\", qlen: queue.length, sample: queue.slice(-3) });\n  return null;\n}\n\ncandidates.sort((a, b) => {\n  const pa = PRIORITY[a.t.type] ?? 99;\n  const pb = PRIORITY[b.t.type] ?? 99;\n  if (pa !== pb) return pa - pb;\n  return (a.t.created_at || 0) - (b.t.created_at || 0);\n});\n\nlet { t: task, idx } = candidates[0];\n\n// 4) running Ï†ÑÌôò + queue Î∞òÏòÅ\ntask.status = \"running\";\ntask.assigned_robot = robotId;\ntask.started_at = now;\n\nqueue[idx] = task;\nglobal.set(\"taskQueue\", queue);\n\n// 5) robots ÏÉÅÌÉúÎèÑ runningÏúºÎ°ú ÏÑ†Î∞òÏòÅ\nrobots[robotId] = {\n  ...robots[robotId],\n  state: \"running\",\n  task_id: task.task_id,\n  updated_at: now\n};\nglobal.set(\"robots\", robots);\n\n// 6) mqttÎ°ú Î≥¥ÎÇº msg Íµ¨ÏÑ±\nmsg.task = task;\nmsg.topic = `robot/${robotId}/task`;\nmsg.payload = JSON.stringify(task);\n\nnode.warn({ action: \"TASK_DISPATCHED\", task_id: task.task_id, type: task.type, target_area: task.target_area });\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1400,
        "y": 1120,
        "wires": [
            [
                "58d8d616da6872e1",
                "fc7132a95c44fe84"
            ]
        ]
    },
    {
        "id": "c02ac5399c925f84",
        "type": "mqtt out",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3c16a07776b27396",
        "x": 2090,
        "y": 1120,
        "wires": []
    },
    {
        "id": "084632d493b02014",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 520,
        "y": 1140,
        "wires": []
    },
    {
        "id": "a8cdfef7f11748d6",
        "type": "mqtt in",
        "z": "49f8711fc297a8c1",
        "name": "robot status",
        "topic": "robot/+/status",
        "qos": "2",
        "datatype": "utf8",
        "broker": "3c16a07776b27396",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 350,
        "y": 1300,
        "wires": [
            [
                "95ebc22a961575da"
            ]
        ]
    },
    {
        "id": "95ebc22a961575da",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "function(updateStatus)",
        "func": "// robot/+/status Î°úÎ∂ÄÌÑ∞ Îì§Ïñ¥Ïò§Îäî msgÎ•º Ï≤òÎ¶¨ÌïòÎäî Ìï®Ïàò\n\n// 1) payload JSON ÌååÏã±\nlet status;\ntry {\n    status = JSON.parse(msg.payload || '{}');\n} catch (e) {\n    node.error('Invalid JSON in robot status', msg);\n    return null;\n}\n\n// 2) ÌÜ†ÌîΩÏóêÏÑú robot_id Ï∂îÏ∂ú: robot/agv1/status\nconst parts = msg.topic.split('/');\nconst robotIdFromTopic = parts[1] || null;\nconst robotId = status.robot_id || robotIdFromTopic || 'unknown';\n\n// 3) robots ÏÉÅÌÉú Í∞±Ïã† (global.robots)\nlet robots = global.get('robots') || {};\nconst now = Date.now();\nrobots[robotId] = {\n    // Í∏∞Ï°¥ Í∞í Ïú†ÏßÄ(Ï∂îÍ∞Ä ÌïÑÎìú Ïïà ÎÇ†Î¶¨Í∏∞)\n    ...(robots[robotId] || {}),\n\n    // ÌëúÏ§Ä ÌïÑÎìú\n    robot_id: robotId,\n    state: status.state || 'unknown',\n    task_id: status.task_id || null,\n    battery: status.battery ?? null,\n    area: status.area || null,\n    error_code: status.error_code || null,\n\n    // ÎîîÏßÄÌÑ∏ Ìä∏Ïúà ÌïµÏã¨ ÌïÑÎìú (Ï∂îÍ∞Ä)\n    pose: status.pose || (robots[robotId]?.pose ?? null),\n    target_area: status.target_area || (robots[robotId]?.target_area ?? null),\n\n    updated_at: status.updated_at || now\n};\nglobal.set('robots', robots);\n\n// ----------------------\n// EMA stats helpers\n// ----------------------\nlet taskStats = global.get(\"taskStats\") || {};  // { deliver_water: { ema_ms, n, updated_at }, ... }\nconst EMA_ALPHA = 0.3;\n\nfunction emaUpdate(key, sampleMs) {\n    const prev = taskStats[key]?.ema_ms;\n    const next = (prev == null) ? sampleMs : (EMA_ALPHA * sampleMs + (1 - EMA_ALPHA) * prev);\n    taskStats[key] = {\n        ema_ms: next,\n        n: (taskStats[key]?.n || 0) + 1,\n        updated_at: Date.now()\n    };\n}\n\n// 4) taskQueue/events Î∞òÏòÅ (task_id ÏûàÏùÑ ÎïåÎßå)\nlet taskQueue = global.get('taskQueue') || [];\nlet events = global.get('events') || [];\n\nif (status.task_id) {\n    const taskId = status.task_id;\n\n    for (let i = 0; i < taskQueue.length; i++) {\n        if (taskQueue[i].task_id === taskId) {\n\n            if (status.state === 'done' || status.state === 'idle') {\n                taskQueue[i].status = 'done';\n                taskQueue[i].finished_at = Date.now();\n\n                // ‚úÖ Ï∂îÍ∞Ä: Ïã§Ï†ú Í±∏Î¶∞ ÏãúÍ∞Ñ Í≥ÑÏÇ∞ + EMA ÏóÖÎç∞Ïù¥Ìä∏\n                const started = taskQueue[i].started_at || taskQueue[i].created_at || taskQueue[i].finished_at;\n                const actualMs = Math.max(0, taskQueue[i].finished_at - started);\n                taskQueue[i].actual_duration_ms = actualMs;\n\n                const key = taskQueue[i].type || \"unknown\"; // Îçî ÏÑ∏Î∂ÑÌôî ÏõêÌïòÎ©¥ `${type}|${target_area}`\n                emaUpdate(key, actualMs);\n                global.set(\"taskStats\", taskStats);\n            } else if (status.state === 'running') {\n                taskQueue[i].status = 'running';\n                if (!taskQueue[i].started_at) taskQueue[i].started_at = Date.now();\n            } else if (status.state === 'error') {\n                taskQueue[i].status = 'failed';\n                taskQueue[i].finished_at = Date.now();\n                taskQueue[i].error_code = status.error_code || null;\n\n                // ‚úÖ Ï∂îÍ∞Ä: Ïã§Ï†ú Í±∏Î¶∞ ÏãúÍ∞Ñ Í≥ÑÏÇ∞ + EMA ÏóÖÎç∞Ïù¥Ìä∏\n                const started = taskQueue[i].started_at || taskQueue[i].created_at || taskQueue[i].finished_at;\n                const actualMs = Math.max(0, taskQueue[i].finished_at - started);\n                taskQueue[i].actual_duration_ms = actualMs;\n\n                const key = taskQueue[i].type || \"unknown\";\n                emaUpdate(key, actualMs);\n                global.set(\"taskStats\", taskStats);\n            }\n\n            taskQueue[i].assigned_robot = robotId;\n            break;\n        }\n    }\n    global.set('taskQueue', taskQueue);\n\n    events.push({\n        ts: Date.now(),\n        type: 'task_status_update',\n        robot_id: robotId,\n        task_id: taskId,\n        state: status.state,\n        area: status.area || null,\n        target_area: status.target_area || null,\n        pose: status.pose || null,\n        error_code: status.error_code || null\n    });\n\n    if (events.length > 200) events = events.slice(events.length - 200);\n    global.set('events', events);\n}\n\n// 5) ÎîîÎ≤ÑÍ∑∏ payload ÏÑ∏ÌåÖ\nmsg.payload = {\n    last_status: status,\n    robots: robots\n};\n\n// ----------------------\n// Firestore write (Ï∂îÍ∞Ä)\n// ----------------------\nconst db = global.get(\"db\");\nif (db) {\n    // robots/{robotId}\n    db.collection(\"robots\").doc(robotId).set(robots[robotId], { merge: true })\n        .catch(err => node.error(\"[robots write] \" + err));\n\n    // tasks/{task_id} (ÏûàÏùÑ ÎïåÎßå)\n    if (status.task_id) {\n        const mappedStatus =\n            (status.state === \"error\") ? \"failed\" :\n            (status.state === \"done\" || status.state === \"idle\") ? \"done\" :\n            (status.state === \"running\") ? \"running\" : \"unknown\";\n\n        const taskPatch = {\n            status: mappedStatus,\n            assigned_robot: robotId,\n            error_code: status.error_code || null,\n        };\n\n        const tq = global.get(\"taskQueue\") || [];\n        const tt = tq.find(x => x.task_id === status.task_id);\n        if (tt?.actual_duration_ms != null) taskPatch.actual_duration_ms = tt.actual_duration_ms;\n        if (tt?.expected_duration_ms != null) taskPatch.expected_duration_ms = tt.expected_duration_ms;\n\n        if (status.state === \"done\" || status.state === \"idle\" || status.state === \"error\") {\n            taskPatch.finished_at = Date.now();\n        }\n\n        db.collection(\"tasks\").doc(status.task_id).set(taskPatch, { merge: true })\n            .catch(err => node.error(\"[tasks write] \" + err));\n    }\n\n    // events add\n    db.collection(\"events\").add({\n        ts: Date.now(),\n        type: \"task_status_update\",\n        robot_id: robotId,\n        task_id: status.task_id || null,\n        state: status.state || null,\n        area: status.area || null,\n        target_area: status.target_area || null,\n        pose: status.pose || null,\n        error_code: status.error_code || null\n    }).catch(err => node.error(\"[events add] \" + err));\n}\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 1300,
        "wires": [
            [
                "0ea75d0a1dd47579",
                "8fa070ba704430fc"
            ]
        ]
    },
    {
        "id": "0ea75d0a1dd47579",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 920,
        "y": 1300,
        "wires": []
    },
    {
        "id": "b9b40ef75eda6086",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "refresh robots",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "1",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 400,
        "y": 2880,
        "wires": [
            [
                "62da11a590d356e1"
            ]
        ]
    },
    {
        "id": "62da11a590d356e1",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "getRobots",
        "func": "const robots = global.get('robots') || {};\nconst arr = [];\n\nfor (const id in robots) {\n    const r = robots[id];\n    // updated_at ÎàÑÎùΩ Î∞©Ïñ¥\n    if (!r.updated_at) r.updated_at = Date.now();\n    arr.push(r);\n}\n\nmsg.robots = arr;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 2880,
        "wires": [
            [
                "b1495853d26db37c"
            ]
        ]
    },
    {
        "id": "c8bbc855845ed80c",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "refresh tasks",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "1",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 400,
        "y": 2940,
        "wires": [
            [
                "49c2e81ae9744bc4"
            ]
        ]
    },
    {
        "id": "49c2e81ae9744bc4",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "getTasks",
        "func": "let tasks = global.get('taskQueue') || [];\n\n// ÏµúÍ∑º ÏÉùÏÑ±Îêú ÏàúÏÑúÎåÄÎ°ú Î≥¥Í≥† Ïã∂ÏúºÎ©¥ Ï†ïÎ†¨\ntasks = tasks.slice().sort((a, b) => (b.created_at || 0) - (a.created_at || 0));\n\nmsg.tasks = tasks;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 2940,
        "wires": [
            [
                "c915a198b0c6cae3"
            ]
        ]
    },
    {
        "id": "6867664da4b8f9fd",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "refresh events",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "1",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 400,
        "y": 3000,
        "wires": [
            [
                "b6c7d07a0458179a"
            ]
        ]
    },
    {
        "id": "b6c7d07a0458179a",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "getEvents",
        "func": "let events = global.get('events') || [];\n\n// ÏµúÏã† Ïù¥Î≤§Ìä∏Í∞Ä ÏúÑÏóê Î≥¥Ïù¥ÎèÑÎ°ù Ïó≠Ïàú Ï†ïÎ†¨\nevents = events.slice().sort((a, b) => (b.ts || 0) - (a.ts || 0));\n\nmsg.events = events;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 3000,
        "wires": [
            [
                "5b2975efe1ee8e3a"
            ]
        ]
    },
    {
        "id": "b1495853d26db37c",
        "type": "ui_template",
        "z": "49f8711fc297a8c1",
        "group": "e6e1b7942a2b8330",
        "name": "Robots cards",
        "order": 0,
        "width": 0,
        "height": 0,
        "format": "<div class=\"robots-wrapper\">\n  <div ng-repeat=\"r in msg.robots\" \n       class=\"robot-card\" \n       ng-class=\"(r.state || 'unknown').toLowerCase()\">\n       \n    <div class=\"robot-header\">\n      <span class=\"robot-id\">{{r.robot_id}}</span>\n      <span class=\"state-pill\" \n            ng-class=\"(r.state || 'unknown').toLowerCase()\">\n        {{(r.state || 'unknown') | uppercase}}\n      </span>\n    </div>\n\n    <div class=\"robot-main\">\n      <div class=\"battery\">\n        üîã {{r.battery !== null && r.battery !== undefined ? (r.battery + '%') : '-'}}\n      </div>\n      <div class=\"area\">\n        üìç {{r.area || '-'}}\n      </div>\n      <div class=\"task\">\n        üßæ {{r.task_id || '-'}}\n      </div>\n      <div class=\"error\" ng-if=\"r.error_code\">\n        ‚ö† ERROR: {{r.error_code}}\n      </div>\n    </div>\n\n    <div class=\"robot-footer\">\n      <span class=\"updated-label\">UPDATED</span>\n      <span class=\"updated-at\">\n        {{ r.updated_at | date:'HH:mm:ss' }}\n      </span>\n    </div>\n  </div>\n\n  <div ng-if=\"!msg.robots || msg.robots.length === 0\" class=\"robot-empty\">\n    No robot data yet.\n  </div>\n</div>\n\n<style>\n  .robots-wrapper {\n    display:flex;\n    flex-wrap:wrap;\n    gap:16px;\n    padding-top:4px;\n  }\n  .robot-card {\n    width: 220px;\n    background: radial-gradient(circle at top left, #0f172a, #020617);\n    border-radius:16px;\n    padding:12px 14px;\n    box-shadow:0 0 18px rgba(15,23,42,0.9);\n    border:1px solid rgba(148,163,184,0.35);\n    color:#E5E7EB;\n    display:flex;\n    flex-direction:column;\n    justify-content:space-between;\n  }\n  .robot-header {\n    display:flex;\n    justify-content:space-between;\n    align-items:center;\n    margin-bottom:8px;\n  }\n  .robot-id {\n    font-weight:700;\n    font-size:16px;\n    color:#F9FAFB;\n  }\n  .state-pill {\n    padding:2px 8px;\n    border-radius:999px;\n    font-size:10px;\n    font-weight:600;\n    letter-spacing:0.5px;\n    border:1px solid rgba(148,163,184,0.5);\n  }\n  .state-pill.idle {\n    background:rgba(148,163,184,0.15);\n    border-color:#9CA3AF;\n    color:#E5E7EB;\n  }\n  .state-pill.running {\n    background:rgba(34,197,94,0.15);\n    border-color:#22C55E;\n    color:#BBF7D0;\n  }\n  .state-pill.charging {\n    background:rgba(234,179,8,0.12);\n    border-color:#EAB308;\n    color:#FEF9C3;\n  }\n  .state-pill.error, .state-pill.failed, .state-pill.fault {\n    background:rgba(239,68,68,0.16);\n    border-color:#EF4444;\n    color:#FECACA;\n  }\n  .state-pill.unknown {\n    background:rgba(59,130,246,0.12);\n    border-color:#3B82F6;\n    color:#BFDBFE;\n  }\n\n  .robot-main {\n    font-size:13px;\n    line-height:1.4;\n    margin-top:4px;\n    margin-bottom:8px;\n  }\n  .robot-main > div {\n    margin:2px 0;\n  }\n  .robot-main .error {\n    color:#FCA5A5;\n    font-size:12px;\n  }\n\n  .robot-footer {\n    display:flex;\n    justify-content:space-between;\n    font-size:10px;\n    color:#9CA3AF;\n    border-top:1px dashed rgba(55,65,81,0.8);\n    padding-top:4px;\n    margin-top:4px;\n  }\n  .robot-empty {\n    font-size:12px;\n    color:#9CA3AF;\n    padding:10px;\n  }\n</style>\n",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1030,
        "y": 2880,
        "wires": [
            []
        ]
    },
    {
        "id": "4cc056840f379311",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "Summary",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "1",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 390,
        "y": 2820,
        "wires": [
            [
                "cc62e9eae576026f"
            ]
        ]
    },
    {
        "id": "cc62e9eae576026f",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "Summary",
        "func": "// robots ÏöîÏïΩ\nconst robots = global.get('robots') || {};\nconst taskQueue = global.get('taskQueue') || [];\n\nlet total = 0, idle = 0, running = 0, charging = 0, error = 0, others = 0;\n\nfor (const id in robots) {\n    total++;\n    const s = (robots[id].state || '').toLowerCase();\n    if (s === 'idle') idle++;\n    else if (s === 'running') running++;\n    else if (s === 'charging') charging++;\n    else if (s === 'error' || s === 'failed' || s === 'fault') error++;\n    else others++;\n}\n\nmsg.summary = { total, idle, running, charging, error, others };\n\n// tasks ÏöîÏïΩ\nlet tTotal = taskQueue.length;\nlet tPending = 0, tRunning = 0, tDone = 0, tFailed = 0;\n\nfor (const t of taskQueue) {\n    const s = (t.status || '').toLowerCase();\n    if (s === 'pending') tPending++;\n    else if (s === 'running') tRunning++;\n    else if (s === 'done') tDone++;\n    else if (s === 'failed') tFailed++;\n}\n\nmsg.taskSummary = {\n    total: tTotal,\n    pending: tPending,\n    running: tRunning,\n    done: tDone,\n    failed: tFailed\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 2820,
        "wires": [
            [
                "74d6b228f443bd37"
            ]
        ]
    },
    {
        "id": "74d6b228f443bd37",
        "type": "ui_template",
        "z": "49f8711fc297a8c1",
        "group": "7e8e44e7110066b9",
        "name": "",
        "order": 0,
        "width": 0,
        "height": 0,
        "format": "<div class=\"dash-summary\">\n  <div class=\"summary-card total\">\n    <div class=\"label\">ROBOTS</div>\n    <div class=\"value\">{{msg.summary.total || 0}}</div>\n  </div>\n  <div class=\"summary-card idle\">\n    <div class=\"label\">IDLE</div>\n    <div class=\"value\">{{msg.summary.idle || 0}}</div>\n  </div>\n  <div class=\"summary-card running\">\n    <div class=\"label\">RUNNING</div>\n    <div class=\"value\">{{msg.summary.running || 0}}</div>\n  </div>\n  <div class=\"summary-card charging\">\n    <div class=\"label\">CHARGING</div>\n    <div class=\"value\">{{msg.summary.charging || 0}}</div>\n  </div>\n  <div class=\"summary-card error\">\n    <div class=\"label\">ERROR/OTHER</div>\n    <div class=\"value\">\n      {{(msg.summary.error || 0) + (msg.summary.others || 0)}}\n    </div>\n  </div>\n</div>\n\n<div class=\"dash-summary\" style=\"margin-top:6px;\">\n  <div class=\"summary-card task-total\">\n    <div class=\"label\">TASKS</div>\n    <div class=\"value\">{{msg.taskSummary.total || 0}}</div>\n  </div>\n  <div class=\"summary-card task-pending\">\n    <div class=\"label\">PENDING</div>\n    <div class=\"value\">{{msg.taskSummary.pending || 0}}</div>\n  </div>\n  <div class=\"summary-card task-running\">\n    <div class=\"label\">RUNNING</div>\n    <div class=\"value\">{{msg.taskSummary.running || 0}}</div>\n  </div>\n  <div class=\"summary-card task-done\">\n    <div class=\"label\">DONE</div>\n    <div class=\"value\">{{msg.taskSummary.done || 0}}</div>\n  </div>\n  <div class=\"summary-card task-failed\">\n    <div class=\"label\">FAILED</div>\n    <div class=\"value\">{{msg.taskSummary.failed || 0}}</div>\n  </div>\n</div>\n\n<style>\n  .dash-summary {\n    display:flex;\n    flex-wrap:wrap;\n    gap:16px;\n    padding:4px 0 4px 0;\n  }\n  .summary-card {\n    flex:0 0 150px;\n    background:#020617;\n    border-radius:14px;\n    padding:10px 14px;\n    box-shadow:0 0 18px rgba(0,0,0,0.45);\n    border:1px solid rgba(148,163,184,0.25);\n  }\n  .summary-card .label {\n    font-size:11px;\n    letter-spacing:1px;\n    color:#9CA3AF;\n  }\n  .summary-card .value {\n    margin-top:4px;\n    font-size:22px;\n    font-weight:700;\n    color:#F9FAFB;\n  }\n\n  .summary-card.total      { border-left:3px solid #38BDF8; }\n  .summary-card.idle       { border-left:3px solid #9CA3AF; }\n  .summary-card.running    { border-left:3px solid #22C55E; }\n  .summary-card.charging   { border-left:3px solid #EAB308; }\n  .summary-card.error      { border-left:3px solid #EF4444; }\n\n  .summary-card.task-total   { border-left:3px solid #6366F1; }\n  .summary-card.task-pending { border-left:3px solid #9CA3AF; }\n  .summary-card.task-running { border-left:3px solid #22C55E; }\n  .summary-card.task-done    { border-left:3px solid #0EA5E9; }\n  .summary-card.task-failed  { border-left:3px solid #F97316; }\n</style>\n",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1020,
        "y": 2820,
        "wires": [
            []
        ]
    },
    {
        "id": "c915a198b0c6cae3",
        "type": "ui_template",
        "z": "49f8711fc297a8c1",
        "group": "920df32220cd089d",
        "name": "",
        "order": 0,
        "width": 0,
        "height": 0,
        "format": "<div class=\"tasks-wrapper\">\n  <table class=\"tasks-table\" ng-if=\"msg.tasks && msg.tasks.length\">\n    <thead>\n      <tr>\n        <th>Task ID</th>\n        <th>Type</th>\n        <th>Target</th>\n        <th>Status</th>\n        <th>Robot</th>\n        <th>Created</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr ng-repeat=\"t in msg.tasks\">\n        <td>{{t.task_id}}</td>\n        <td>{{t.type}}</td>\n        <td>{{t.target_area}}</td>\n        <td>\n          <span class=\"task-status\" ng-class=\"(t.status || 'unknown').toLowerCase()\">\n            {{(t.status || 'unknown') | uppercase}}\n          </span>\n        </td>\n        <td>{{t.assigned_robot || '-'}}</td>\n        <td>{{t.created_at | date:'MM-dd HH:mm:ss'}}</td>\n      </tr>\n    </tbody>\n  </table>\n\n  <div ng-if=\"!msg.tasks || !msg.tasks.length\" class=\"tasks-empty\">\n    No tasks yet.\n  </div>\n</div>\n\n<style>\n  .tasks-wrapper {\n    padding-top:4px;\n  }\n  .tasks-table {\n    width:100%;\n    border-collapse:collapse;\n    font-size:12px;\n    background:#020617;\n    border-radius:10px;\n    overflow:hidden;\n    box-shadow:0 0 18px rgba(15,23,42,0.7);\n  }\n  .tasks-table thead {\n    background:linear-gradient(to right,#0f172a,#020617);\n  }\n  .tasks-table th,\n  .tasks-table td {\n    padding:6px 8px;\n    text-align:left;\n    border-bottom:1px solid rgba(30,41,59,0.9);\n    color:#E5E7EB;\n  }\n  .tasks-table th {\n    font-weight:600;\n    font-size:11px;\n    color:#9CA3AF;\n  }\n  .tasks-table tbody tr:hover {\n    background:rgba(15,23,42,0.8);\n  }\n\n  .task-status {\n    padding:2px 6px;\n    border-radius:999px;\n    font-size:10px;\n    border:1px solid rgba(148,163,184,0.4);\n  }\n  .task-status.pending {\n    background:rgba(148,163,184,0.1);\n    border-color:#9CA3AF;\n  }\n  .task-status.running {\n    background:rgba(34,197,94,0.15);\n    border-color:#22C55E;\n    color:#BBF7D0;\n  }\n  .task-status.done {\n    background:rgba(59,130,246,0.18);\n    border-color:#3B82F6;\n    color:#DBEAFE;\n  }\n  .task-status.failed {\n    background:rgba(239,68,68,0.18);\n    border-color:#EF4444;\n    color:#FECACA;\n  }\n  .task-status.unknown {\n    background:rgba(107,114,128,0.18);\n    border-color:#6B7280;\n    color:#E5E7EB;\n  }\n\n  .tasks-empty {\n    font-size:12px;\n    color:#9CA3AF;\n    padding:8px;\n  }\n</style>\n",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1020,
        "y": 2940,
        "wires": [
            []
        ]
    },
    {
        "id": "5b2975efe1ee8e3a",
        "type": "ui_template",
        "z": "49f8711fc297a8c1",
        "group": "ab2f507577ca5dbe",
        "name": "",
        "order": 0,
        "width": 0,
        "height": 0,
        "format": "<div class=\"events-wrapper\">\n  <table class=\"events-table\" ng-if=\"msg.events && msg.events.length\">\n    <thead>\n      <tr>\n        <th>Time</th>\n        <th>Type</th>\n        <th>Robot</th>\n        <th>Task</th>\n        <th>State</th>\n        <th>Area</th>\n        <th>Error</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr ng-repeat=\"e in msg.events | limitTo:50\">\n        <td>{{e.ts | date:'HH:mm:ss'}}</td>\n        <td>{{e.type}}</td>\n        <td>{{e.robot_id}}</td>\n        <td>{{e.task_id}}</td>\n        <td>{{e.state}}</td>\n        <td>{{e.area || '-'}}</td>\n        <td>{{e.error_code || '-'}}</td>\n      </tr>\n    </tbody>\n  </table>\n\n  <div ng-if=\"!msg.events || !msg.events.length\" class=\"events-empty\">\n    No events yet.\n  </div>\n</div>\n\n<style>\n  .events-wrapper {\n    padding-top:4px;\n  }\n  .events-table {\n    width:100%;\n    border-collapse:collapse;\n    font-size:11px;\n    background:#020617;\n    border-radius:10px;\n    overflow:hidden;\n    box-shadow:0 0 18px rgba(15,23,42,0.7);\n  }\n  .events-table thead {\n    background:linear-gradient(to right,#0f172a,#020617);\n  }\n  .events-table th,\n  .events-table td {\n    padding:4px 6px;\n    text-align:left;\n    border-bottom:1px solid rgba(30,41,59,0.9);\n    color:#E5E7EB;\n  }\n  .events-table th {\n    font-weight:600;\n    font-size:10px;\n    color:#9CA3AF;\n  }\n  .events-table tbody tr:hover {\n    background:rgba(15,23,42,0.8);\n  }\n  .events-empty {\n    font-size:12px;\n    color:#9CA3AF;\n    padding:8px;\n  }\n</style>\n",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1020,
        "y": 3000,
        "wires": [
            []
        ]
    },
    {
        "id": "f4058cf1557c02ec",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "Init global state",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 360,
        "y": 180,
        "wires": [
            [
                "dd5be1ad5697a1f2"
            ]
        ]
    },
    {
        "id": "dd5be1ad5697a1f2",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "initGlobalState",
        "func": "// // InitGlobalState (TRACK_POINTS + AREA_POS snap-to-track + agv1 init)\n\n// // -------------------------\n// // 0) Track generator (percent coords 0~100)\n// // -------------------------\n// function addLine(pts, a, b, steps) {\n//   for (let i = 1; i <= steps; i++) {\n//     const t = i / steps;\n//     pts.push({ x: a.x + (b.x - a.x) * t, y: a.y + (b.y - a.y) * t });\n//   }\n// }\n\n// function addArc(pts, cx, cy, r, a0, a1, steps) {\n//   for (let i = 1; i <= steps; i++) {\n//     const t = i / steps;\n//     const a = a0 + (a1 - a0) * t;\n//     pts.push({ x: cx + r * Math.cos(a), y: cy + r * Math.sin(a) });\n//   }\n// }\n\n// // \"Îë•Í∑º ÏÇ¨Í∞Å Î£®ÌîÑ\"Î•º ÎßåÎì† Îí§, Ï¢å/Ïö∞Ïóê ÏÇ¥Ïßù Íµ¥Í≥°ÏùÑ Ï§òÏÑú Ïã§Ï†ú Ìä∏Îûô ÎäêÎÇåÏùÑ Ï°∞Í∏à ÎÉÑ\n// function makeTrackV1() {\n//   const l = 16, t = 14, r = 86, b = 86;  // Ìä∏Îûô Î∞îÏö¥Îî© Î∞ïÏä§ (ÌçºÏÑºÌä∏)\n//   const rad = 16;                        // ÏΩîÎÑà ÎùºÏö¥Îìú\n//   const pts = [];\n\n//   // ÏãúÏûëÏ†ê: top edgeÏùò left ÎùºÏö¥Îìú ÎÅù\n//   pts.push({ x: l + rad, y: t });\n\n//   // top (left->right)\n//   addLine(pts, pts[pts.length - 1], { x: r - rad, y: t }, 40);\n//   // top-right corner (-90 -> 0)\n//   addArc(pts, r - rad, t + rad, rad, -Math.PI / 2, 0, 22);\n\n//   // right (top->bottom)\n//   addLine(pts, pts[pts.length - 1], { x: r, y: b - rad }, 52);\n//   // bottom-right corner (0 -> +90)\n//   addArc(pts, r - rad, b - rad, rad, 0, Math.PI / 2, 22);\n\n//   // bottom (right->left)\n//   addLine(pts, pts[pts.length - 1], { x: l + rad, y: b }, 40);\n//   // bottom-left corner (+90 -> 180)\n//   addArc(pts, l + rad, b - rad, rad, Math.PI / 2, Math.PI, 22);\n\n//   // left (bottom->top)\n//   addLine(pts, pts[pts.length - 1], { x: l, y: t + rad }, 52);\n//   // top-left corner (180 -> 270)\n//   addArc(pts, l + rad, t + rad, rad, Math.PI, 3 * Math.PI / 2, 22);\n\n//   // ---- warp(Íµ¥Í≥°) ----\n//   // ÏôºÏ™Ω Íµ¨Í∞Ñ: y 30~72 ÏÇ¨Ïù¥ÏóêÏÑú ÏïàÏ™ΩÏúºÎ°ú Îì§Ïñ¥Ïò§Îäî Íµ¥Í≥°(ÏÇ¨ÏßÑ Ìä∏Îûô ÏôºÏ™Ω ÎäêÎÇå)\n//   // Ïò§Î•∏Ï™Ω Íµ¨Í∞Ñ: y 22~74 ÏÇ¨Ïù¥ÏóêÏÑú Î∞îÍπ•ÏúºÎ°ú ÏÇ¥Ïßù Î∂ÄÌíÄÎ¶¨Îäî Íµ¥Í≥°\n//   function bump(y, y0, y1) {\n//     if (y <= y0 || y >= y1) return 0;\n//     const u = (y - y0) / (y1 - y0); // 0~1\n//     // Í∞ÄÏö¥Îç∞Í∞Ä Í∞ÄÏû• ÌÅ∞ ÏôÑÎßåÌïú Î¥âÏö∞Î¶¨\n//     return Math.sin(Math.PI * u) ** 2;\n//   }\n\n//   const warped = pts.map(p => {\n//     let { x, y } = p;\n\n//     // left edge Í∑ºÏ≤òÎ©¥ ÏïàÏ™ΩÏúºÎ°ú\n//     if (x <= l + 1.0) {\n//       const k = bump(y, 30, 72);\n//       x = x + 10 * k; // ÏïàÏ™Ω(Ïò§Î•∏Ï™Ω)ÏúºÎ°ú ÏµúÎåÄ 10%\n//     }\n\n//     // right edge Í∑ºÏ≤òÎ©¥ Î∞îÍπ•ÏúºÎ°ú ÏÇ¥Ïßù\n//     if (x >= r - 1.0) {\n//       const k = bump(y, 22, 74);\n//       x = x + 6 * k; // Î∞îÍπ•(Ïò§Î•∏Ï™Ω)ÏúºÎ°ú ÏµúÎåÄ 6%\n//     }\n\n//     // ÌÅ¥Îû®ÌîÑ\n//     x = Math.max(3, Math.min(97, x));\n//     y = Math.max(3, Math.min(97, y));\n//     return { x, y };\n//   });\n\n//   return warped;\n// }\n\n// const TRACK_POINTS = makeTrackV1();\n// global.set(\"TRACK_POINTS\", TRACK_POINTS);\n\n// // -------------------------\n// // 1) Helper: snap point to nearest track point\n// // -------------------------\n// function dist2(a, b) {\n//   const dx = a.x - b.x, dy = a.y - b.y;\n//   return dx * dx + dy * dy;\n// }\n// function snapToTrack(p) {\n//   let best = TRACK_POINTS[0];\n//   let bestD = 1e18;\n//   for (let i = 0; i < TRACK_POINTS.length; i++) {\n//     const d = dist2(p, TRACK_POINTS[i]);\n//     if (d < bestD) { bestD = d; best = TRACK_POINTS[i]; }\n//   }\n//   return { x: best.x, y: best.y };\n// }\n\n// // -------------------------\n// // 2) AREA_POS (percent coords) + snap\n// // -------------------------\n// let AREA_POS = {\n//   CHARGE: { x: 50, y: 10 }, // Ï∂©Ï†ÑÏÜå(Îß® ÏúÑ)\n//   WATER:  { x: 20, y: 38 }, // Ï†ïÏàòÍ∏∞(ÏôºÏ™Ω)\n//   DROP:   { x: 80, y: 38 }, // ÌôòÍ≤ΩÏ†ïÎ¶¨/Î∞òÎÇ©(Ïò§Î•∏Ï™Ω)\n//   RES_A:  { x: 28, y: 78 }, // Ïú†Ï†ÄÍ≥µÍ∞Ñ1\n//   RES_B:  { x: 50, y: 86 }, // Ïú†Ï†ÄÍ≥µÍ∞Ñ2\n//   RES_C:  { x: 72, y: 78 }, // Ïú†Ï†ÄÍ≥µÍ∞Ñ3\n// };\n\n// // Ï†ïÎ•òÏû•ÏùÄ Ìä∏Îûô ÏúÑÏóê Îî± Î∂ôÍ≤å Ïä§ÎÉÖ\n// for (const k of Object.keys(AREA_POS)) {\n//   AREA_POS[k] = snapToTrack(AREA_POS[k]);\n// }\n// global.set(\"AREA_POS\", AREA_POS);\n\n// // -------------------------\n// // 3) Global state init\n// // -------------------------\n// let robots = global.get(\"robots\") || {};\n// let taskQueue = global.get(\"taskQueue\") || [];\n// let events = global.get(\"events\") || [];\n\n// if (!robots[\"agv1\"]) robots[\"agv1\"] = {};\n\n// robots[\"agv1\"] = {\n//   ...(robots[\"agv1\"] || {}),\n//   robot_id: \"agv1\",\n//   state: \"idle\",\n//   task_id: null,\n//   battery: robots[\"agv1\"].battery ?? 100,\n\n//   // ‚úÖ ÏãúÏûë ÏúÑÏπò: Ï∂©Ï†ÑÏÜå (Ìä∏Îûô ÏúÑ)\n//   area: \"CHARGE\",\n//   pose: { x: AREA_POS.CHARGE.x, y: AREA_POS.CHARGE.y, theta: 0 },\n\n//   error_code: null,\n//   updated_at: Date.now(),\n// };\n\n// global.set(\"robots\", robots);\n// global.set(\"taskQueue\", taskQueue);\n// global.set(\"events\", events);\n\n// node.status({ fill: \"green\", shape: \"dot\", text: \"init ok: TRACK + AREA_POS snapped\" });\n\n// // FirestoreÏóêÎèÑ Î∞òÏòÅ(ÎÑàÌù¨ /api/robotsÍ∞Ä Firestore Î≥¥Îäî Íµ¨Ï°∞ÎùºÏÑú)\n// const db = global.get(\"db\");\n// if (db) {\n//   db.collection(\"robots\").doc(\"agv1\").set(robots[\"agv1\"], { merge: true })\n//     .catch(err => node.error(\"[init robots write] \" + err));\n// }\n\n// return null;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n// InitGlobalState (CALIB TRACK_POINTS + AREA_POS by zone-box + agv1 init)\n\n// ======================================================\n// 0) (fallback) Track generator (percent coords 0~100)\n// ======================================================\nfunction addLine(pts, a, b, steps) {\n  for (let i = 1; i <= steps; i++) {\n    const t = i / steps;\n    pts.push({ x: a.x + (b.x - a.x) * t, y: a.y + (b.y - a.y) * t });\n  }\n}\n\nfunction addArc(pts, cx, cy, r, a0, a1, steps) {\n  for (let i = 1; i <= steps; i++) {\n    const t = i / steps;\n    const a = a0 + (a1 - a0) * t;\n    pts.push({ x: cx + r * Math.cos(a), y: cy + r * Math.sin(a) });\n  }\n}\n\n// \"Îë•Í∑º ÏÇ¨Í∞Å Î£®ÌîÑ\" + ÏïΩÍ∞Ñ Íµ¥Í≥°\nfunction makeTrackV1() {\n  const l = 16, t = 14, r = 86, b = 86;\n  const rad = 16;\n  const pts = [];\n\n  pts.push({ x: l + rad, y: t });\n\n  addLine(pts, pts[pts.length - 1], { x: r - rad, y: t }, 40);\n  addArc(pts, r - rad, t + rad, rad, -Math.PI / 2, 0, 22);\n\n  addLine(pts, pts[pts.length - 1], { x: r, y: b - rad }, 52);\n  addArc(pts, r - rad, b - rad, rad, 0, Math.PI / 2, 22);\n\n  addLine(pts, pts[pts.length - 1], { x: l + rad, y: b }, 40);\n  addArc(pts, l + rad, b - rad, rad, Math.PI / 2, Math.PI, 22);\n\n  addLine(pts, pts[pts.length - 1], { x: l, y: t + rad }, 52);\n  addArc(pts, l + rad, t + rad, rad, Math.PI, 3 * Math.PI / 2, 22);\n\n  function bump(y, y0, y1) {\n    if (y <= y0 || y >= y1) return 0;\n    const u = (y - y0) / (y1 - y0);\n    return Math.sin(Math.PI * u) ** 2;\n  }\n\n  const warped = pts.map(p => {\n    let { x, y } = p;\n\n    if (x <= l + 1.0) {\n      const k = bump(y, 30, 72);\n      x = x + 10 * k;\n    }\n    if (x >= r - 1.0) {\n      const k = bump(y, 22, 74);\n      x = x + 6 * k;\n    }\n\n    x = Math.max(3, Math.min(97, x));\n    y = Math.max(3, Math.min(97, y));\n    return { x, y };\n  });\n\n  return warped;\n}\n\n// ======================================================\n// 1) Track load: calibration json(dense) Ïö∞ÏÑ†, Ïã§Ìå® Ïãú fallback\n// ======================================================\nfunction clamp100(v) {\n  if (!Number.isFinite(v)) return 0;\n  return Math.max(0, Math.min(100, v));\n}\nfunction dist2(a, b) {\n  const dx = a.x - b.x, dy = a.y - b.y;\n  return dx * dx + dy * dy;\n}\nfunction normalizeTrack(points) {\n  let arr = Array.isArray(points) ? points : [];\n  arr = arr\n    .filter(p => p && Number.isFinite(p.x) && Number.isFinite(p.y))\n    .map(p => ({ x: clamp100(p.x), y: clamp100(p.y) }));\n\n  if (arr.length < 2) return arr;\n\n  // Ï∫òÎ¶¨ denseÎäî Î≥¥ÌÜµ ÎßàÏßÄÎßâ Ï†êÏù¥ Ï≤´ Ï†êÍ≥º Í∞ôÏùå(Îã´Ìûò) -> Ï§ëÎ≥µ 1Í∞ú Ï†úÍ±∞\n  const first = arr[0];\n  const last = arr[arr.length - 1];\n  if (dist2(first, last) < 0.0001) arr = arr.slice(0, -1);\n\n  return arr;\n}\n\n// NOTE) Ïó¨Í∏∞ Í≤ΩÎ°úÎßå ÎÑ§ ÌôòÍ≤ΩÏóê ÎßûÍ≤å ÏàòÏ†ï\n// - Í∂åÏû•: track_agv1.jsonÏùÑ .node-red Ìè¥ÎçîÏóê ÎëêÍ≥† Í∑∏ ÌååÏùº Í≤ΩÎ°úÎ•º ÏÇ¨Ïö©\nconst TRACK_JSON_PATH = \"C:/Users/wp3wk/AppData/Roaming/SPB_Data/.node-red/track_agv1.json\";\n\n// fsÎäî Function ÎÖ∏Îìú \"Setup(Modules)\"Ïóê fs Ï∂îÍ∞ÄÌï¥ÎëêÎ©¥ global.get(\"fs\")Î°ú Ïû°Ìûò.\n// (ÏóÜÏúºÎ©¥ require ÏãúÎèÑ -> Í∑∏ÎßàÏ†Ä ÎßâÌòÄÏûàÏúºÎ©¥ fallback Ìä∏Îûô ÏÇ¨Ïö©)\nlet fs = global.get(\"fs\");\nif (!fs) {\n  try { fs = require(\"fs\"); } catch (e) {}\n}\n\nlet TRACK_POINTS = null;\nlet trackSource = \"fallback(makeTrackV1)\";\n\nif (fs) {\n  try {\n    const raw = fs.readFileSync(TRACK_JSON_PATH, \"utf8\");\n    const obj = JSON.parse(raw);\n\n    // UserApp.vue Ï†ÄÏû• Ìè¨Îß∑: { anchors:[], dense:[], saved_at:... }\n    if (Array.isArray(obj?.dense)) {\n      TRACK_POINTS = obj.dense;\n      trackSource = \"calib(json.dense)\";\n    } else if (Array.isArray(obj?.TRACK_POINTS)) {\n      TRACK_POINTS = obj.TRACK_POINTS;\n      trackSource = \"calib(json.TRACK_POINTS)\";\n    } else if (Array.isArray(obj)) {\n      TRACK_POINTS = obj;\n      trackSource = \"calib(json=array)\";\n    }\n  } catch (e) {\n    node.warn(\"[initGlobalState] Failed to load track json. path=\" + TRACK_JSON_PATH + \" err=\" + e);\n  }\n} else {\n  node.warn(\"[initGlobalState] fs not available. Add 'fs' in Function node Setup(Modules) or enable require(). Using fallback track.\");\n}\n\nTRACK_POINTS = normalizeTrack(TRACK_POINTS);\nif (!TRACK_POINTS || TRACK_POINTS.length < 2) {\n  TRACK_POINTS = makeTrackV1();\n  TRACK_POINTS = normalizeTrack(TRACK_POINTS);\n  trackSource = \"fallback(makeTrackV1)\";\n}\n\nglobal.set(\"TRACK_POINTS\", TRACK_POINTS);\n\n// ======================================================\n// 2) Helper: snap point to nearest track point\n// ======================================================\nfunction snapToTrack(p) {\n  let best = TRACK_POINTS[0];\n  let bestD = 1e18;\n  for (let i = 0; i < TRACK_POINTS.length; i++) {\n    const d = dist2(p, TRACK_POINTS[i]);\n    if (d < bestD) { bestD = d; best = TRACK_POINTS[i]; }\n  }\n  return { x: best.x, y: best.y };\n}\n\n// ======================================================\n// 3) AREA_POS: UserApp.vueÏùò zone Î∞ïÏä§ Í∏∞Ï§ÄÏúºÎ°ú \"Î∞ïÏä§ Ïïà Ìä∏Îûô Ï†ê\" ÏÑ†ÌÉù\n// ======================================================\n// UserApp.vue CSS Í∏∞Ï§Ä(ÌçºÏÑºÌä∏):\n// .z-charge{ left:40 top:6 width:20 height:12 }\n// .z-water { left:8  top:22 width:22 height:16 }\n// .z-drop  { left:70 top:30 width:22 height:16 }\n// .z-a     { left:10 top:66 width:24 height:18 }\n// .z-b     { left:38 top:74 width:24 height:18 }\n// .z-c     { left:66 top:66 width:24 height:18 }\nconst ZONES = {\n  CHARGE: { left: 40, top:  6, width: 20, height: 12 },\n  WATER:  { left:  8, top: 22, width: 22, height: 16 },\n  DROP:   { left: 70, top: 30, width: 22, height: 16 },\n  RES_A:  { left: 10, top: 66, width: 24, height: 18 },\n  RES_B:  { left: 38, top: 74, width: 24, height: 18 },\n  RES_C:  { left: 66, top: 66, width: 24, height: 18 },\n};\n\nfunction zoneCenter(z) {\n  return { x: z.left + z.width / 2, y: z.top + z.height / 2 };\n}\n\nfunction pickStationOnTrackByZone(zone) {\n  const x0 = zone.left, x1 = zone.left + zone.width;\n  const y0 = zone.top,  y1 = zone.top + zone.height;\n  const c = zoneCenter(zone);\n\n  // 1) Î∞ïÏä§ ÏïàÏóê Îì§Ïñ¥Ïò§Îäî Ìä∏Îûô Ï†ê ÌõÑÎ≥¥\n  let best = null;\n  let bestD = 1e18;\n  for (const p of TRACK_POINTS) {\n    if (p.x < x0 || p.x > x1 || p.y < y0 || p.y > y1) continue;\n    const d = dist2(c, p);\n    if (d < bestD) { bestD = d; best = p; }\n  }\n\n  // 2) Î∞ïÏä§ Ïïà ÌõÑÎ≥¥Í∞Ä ÏóÜÏúºÎ©¥: centerÎ•º Ìä∏ÎûôÏóê snap\n  if (!best) return snapToTrack(c);\n  return { x: best.x, y: best.y };\n}\n\nlet AREA_POS = {\n  CHARGE: pickStationOnTrackByZone(ZONES.CHARGE),\n  WATER:  pickStationOnTrackByZone(ZONES.WATER),\n  DROP:   pickStationOnTrackByZone(ZONES.DROP),\n  RES_A:  pickStationOnTrackByZone(ZONES.RES_A),\n  RES_B:  pickStationOnTrackByZone(ZONES.RES_B),\n  RES_C:  pickStationOnTrackByZone(ZONES.RES_C),\n};\n\nglobal.set(\"AREA_POS\", AREA_POS);\n\n// ======================================================\n// 4) Global state init\n// ======================================================\nlet robots = global.get(\"robots\") || {};\nlet taskQueue = global.get(\"taskQueue\") || [];\nlet events = global.get(\"events\") || [];\n\nif (!robots[\"agv1\"]) robots[\"agv1\"] = {};\n\nrobots[\"agv1\"] = {\n  ...(robots[\"agv1\"] || {}),\n  robot_id: \"agv1\",\n  state: \"idle\",\n  task_id: null,\n  battery: robots[\"agv1\"].battery ?? 100,\n\n  // ‚úÖ ÏãúÏûë ÏúÑÏπò: Ï∂©Ï†ÑÏÜå (Ìä∏Îûô ÏúÑ)\n  area: \"CHARGE\",\n  pose: { x: AREA_POS.CHARGE.x, y: AREA_POS.CHARGE.y, theta: 0 },\n\n  error_code: null,\n  updated_at: Date.now(),\n};\n\nglobal.set(\"robots\", robots);\nglobal.set(\"taskQueue\", taskQueue);\nglobal.set(\"events\", events);\n\nnode.status({ fill: \"green\", shape: \"dot\", text: `init ok: ${trackSource} + AREA_POS by zones` });\n\n// FirestoreÏóêÎèÑ Î∞òÏòÅ\nconst db = global.get(\"db\");\nif (db) {\n  db.collection(\"robots\").doc(\"agv1\").set(robots[\"agv1\"], { merge: true })\n    .catch(err => node.error(\"[init robots write] \" + err));\n}\n\nreturn null;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 600,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "5683f1a5e869fec8",
        "type": "mqtt in",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "robot/agv1/task",
        "qos": "2",
        "datatype": "utf8",
        "broker": "3c16a07776b27396",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 360,
        "y": 1480,
        "wires": [
            [
                "4319d8f20df90726",
                "a50e6fc76e6e8f77"
            ]
        ]
    },
    {
        "id": "4319d8f20df90726",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "simulateAGV",
        "func": "// // simulateAGV (UI %Ï¢åÌëú ÌÜµÏùº + waypoint ÎèôÏÑ† Î≤ÑÏ†Ñ)\n// // input: robot/agv1/task (msg.payload = task JSON)\n// // output1: running stream (array of msgs w/ msg.delay)\n// // output2: done + idle (2 msgs w/ msg.delay)\n\n// let task;\n// try {\n//   task = JSON.parse(msg.payload || \"{}\");\n// } catch (e) {\n//   node.error(\"Invalid task JSON in simulateAGV\", msg);\n//   return null;\n// }\n\n// const robotId = \"agv1\";\n\n// // -------------------------\n// // 0) AREA_POS: UI percent coords (0~100)\n// // -------------------------\n// const AREA_POS = global.get(\"AREA_POS\") || {\n//   CHARGE: { x: 50, y: 10 },\n//   WATER:  { x: 18, y: 28 },\n//   DROP:   { x: 82, y: 42 },\n//   RES_A:  { x: 20, y: 70 },\n//   RES_B:  { x: 42, y: 82 },\n//   RES_C:  { x: 70, y: 82 },\n// };\n\n// // -------------------------\n// // 1) context state (battery/area/pose)\n// // -------------------------\n// let battery = context.get(\"battery\") ?? 80;\n// let area = String(context.get(\"area\") || \"CHARGE\").toUpperCase();\n// let pose = context.get(\"pose\") || null;\n\n// // Î∞∞ÌÑ∞Î¶¨ ÏÇ¥Ïßù ÍπéÍ∏∞\n// battery = Math.max(0, battery - 1);\n// context.set(\"battery\", battery);\n\n// // ‚úÖ Íµ¨Î≤ÑÏ†Ñ Í∑∏Î¶¨Îìú Ï¢åÌëúÍ∞Ä ÎÇ®ÏïÑÏûàÎäî Í≤ΩÏö∞ ÏûêÎèô Î¶¨ÏÖã\n// function looksLikeOldGridPose(p) {\n//   // ÏòàÏ†Ñ Ï¢åÌëúÎäî ÎåÄÍ∞ú 0~12 Í∞ôÏùÄ ÏûëÏùÄ Í∞í\n//   return p && typeof p.x === \"number\" && typeof p.y === \"number\" && p.x <= 15 && p.y <= 15;\n// }\n// if (!pose || looksLikeOldGridPose(pose)) {\n//   const p0 = AREA_POS[area] || AREA_POS.CHARGE;\n//   pose = { x: p0.x, y: p0.y, theta: 0 };\n//   context.set(\"pose\", pose);\n// }\n\n// // areaÎèÑ Íµ¨Î≤ÑÏ†Ñ Í∞íÏùº Ïàò ÏûàÏñ¥ Î∞©Ïñ¥ (BASE/DOCK/USER1/USER2 Îì±)\n// const legacyAreaMap = { BASE: \"CHARGE\", DOCK: \"CHARGE\", USER1: \"RES_A\", USER2: \"RES_B\" };\n// if (legacyAreaMap[area]) {\n//   area = legacyAreaMap[area];\n//   context.set(\"area\", area);\n// }\n\n// // -------------------------\n// // 2) waypoint plan (ÏãúÏó∞ ÎèôÏÑ†Ïö©)\n// // -------------------------\n// function normTargetArea(raw) {\n//   const s = String(raw || \"\").toUpperCase();\n//   const map = { USER1: \"RES_A\", USER2: \"RES_B\", USER3: \"RES_C\", BASE: \"CHARGE\", HOME: \"CHARGE\", DOCK: \"CHARGE\" };\n//   if (map[s]) return map[s];\n//   if ([\"CHARGE\", \"WATER\", \"DROP\", \"RES_A\", \"RES_B\", \"RES_C\"].includes(s)) return s;\n//   return \"RES_B\";\n// }\n// const userArea = normTargetArea(task.target_area);\n\n// // typeÎ≥Ñ ÎèôÏÑ†\n// // - deliver_water: (ÌòÑÏû¨) -> WATER -> user -> CHARGE\n// // - collect_cup / collect_laundry: (ÌòÑÏû¨) -> user -> DROP -> CHARGE\n// let waypoints = [];\n// if (task.type === \"deliver_water\") {\n//   waypoints = [\"WATER\", userArea, \"CHARGE\"];\n// } else if (task.type === \"collect_cup\" || task.type === \"collect_laundry\") {\n//   waypoints = [userArea, \"DROP\", \"CHARGE\"];\n// } else {\n//   // unknown: Í∑∏ÎÉ• targetÎßå Í∞îÎã§Í∞Ä Ï∂©Ï†ÑÏÜå Î≥µÍ∑Ä\n//   waypoints = [userArea, \"CHARGE\"];\n// }\n\n// // ÌòÑÏû¨ areaÍ∞Ä waypoint Ï≤´Î≤àÏß∏ÏôÄ Í∞ôÏúºÎ©¥ Ï§ëÎ≥µ Ï†úÍ±∞\n// waypoints = waypoints.filter((w, i) => i === 0 || w !== waypoints[i - 1]);\n\n// // ÌòÑÏû¨ ÏúÑÏπòÏóêÏÑú Ï≤´ waypointÍπåÏßÄÎèÑ Ïù¥ÎèôÌï¥Ïïº ÌïòÎãà ÏãúÏûëÏ†ê Ìè¨Ìï®Ìïú point list ÎßåÎì§Í∏∞\n// function getPos(areaCode, fallbackPos) {\n//   return AREA_POS[areaCode] || fallbackPos;\n// }\n\n// // -------------------------\n// // 3) duration (expected Í∏∞Î∞ò + ÏßÄÌÑ∞) + Íµ¨Í∞ÑÎ≥Ñ Î∂ÑÎ∞∞\n// // -------------------------\n// const base = Number(task.expected_duration_ms) || 12000;\n// const jitter = 0.85 + Math.random() * 0.30; // 0.85~1.15\n// const TOTAL_MS = Math.round(base * jitter);\n\n// const STEP_MS = 200;\n\n// function dist(a, b) {\n//   const dx = (b.x - a.x);\n//   const dy = (b.y - a.y);\n//   return Math.sqrt(dx * dx + dy * dy);\n// }\n\n// let curPos = { x: pose.x, y: pose.y };\n// let segmentPos = [];\n// for (const wp of waypoints) {\n//   segmentPos.push(getPos(wp, curPos));\n// }\n// const segDists = [];\n// let totalDist = 0;\n// let prev = curPos;\n// for (const p of segmentPos) {\n//   const d = dist(prev, p);\n//   segDists.push(d);\n//   totalDist += d;\n//   prev = p;\n// }\n// if (totalDist <= 0) totalDist = segDists.length; // Î™®Îëê 0Ïù¥Î©¥ Í∑†Îì±Î∂ÑÎ∞∞\n\n// let segDur = segDists.map(d => Math.max(STEP_MS, Math.round(TOTAL_MS * (d / totalDist))));\n// let sumDur = segDur.reduce((a, b) => a + b, 0);\n// // Ìï©Ïù¥ TOTAL_MSÎûë ÏïàÎßûÏúºÎ©¥ ÎßàÏßÄÎßâÏóê Î≥¥Ï†ï\n// segDur[segDur.length - 1] = Math.max(STEP_MS, segDur[segDur.length - 1] - (sumDur - TOTAL_MS));\n\n// // -------------------------\n// // 4) running stream ÏÉùÏÑ±\n// // -------------------------\n// function heading(from, to) {\n//   return Math.atan2((to.y - from.y), (to.x - from.x));\n// }\n// function lerp(a, b, t) {\n//   return a + (b - a) * t;\n// }\n\n// const msgsRunning = [];\n// let delayAcc = 0;\n\n// let curArea = area;\n// let fromPos = curPos;\n\n// for (let s = 0; s < segmentPos.length; s++) {\n//   const toPos = segmentPos[s];\n//   const target = waypoints[s];\n//   const dur = segDur[s];\n\n//   const steps = Math.max(1, Math.floor(dur / STEP_MS));\n\n//   for (let i = 0; i <= steps; i++) {\n//     const t = i / steps;\n//     const x = lerp(fromPos.x, toPos.x, t);\n//     const y = lerp(fromPos.y, toPos.y, t);\n//     const theta = heading({ x, y }, toPos);\n\n//     const runningStatus = {\n//       robot_id: robotId,\n//       state: \"running\",\n//       task_id: task.task_id || null,\n//       battery,\n//       area: curArea,          // ÌòÑÏû¨ Íµ¨Ïó≠(ÌÅ∞ ÏùòÎØ∏) - Íµ¨Í∞Ñ ÏãúÏûë Íµ¨Ïó≠\n//       target_area: target,    // ÏßÄÍ∏à Ìñ•ÌïòÎäî Î™©Ï†ÅÏßÄ\n//       error_code: null,\n//       pose: { x, y, theta },  // ‚úÖ UI% Ï¢åÌëú\n//       updated_at: Date.now(),\n//     };\n\n//     msgsRunning.push({\n//       topic: `robot/${robotId}/status`,\n//       payload: JSON.stringify(runningStatus),\n//       delay: delayAcc + i * STEP_MS,\n//     });\n//   }\n\n//   // Íµ¨Í∞Ñ ÏôÑÎ£å ‚Üí ÌòÑÏû¨ Íµ¨Ïó≠ Í∞±Ïã†\n//   delayAcc += dur;\n//   fromPos = toPos;\n//   curArea = target;\n// }\n\n// // ÏôÑÎ£å ÏúÑÏπòÎ•º contextÏóê Ï†ÄÏû• (ÎåÄÎ∂ÄÎ∂Ñ CHARGEÎ°ú ÎÅùÎÇ®)\n// pose = { x: fromPos.x, y: fromPos.y, theta: 0 };\n// context.set(\"pose\", pose);\n// context.set(\"area\", curArea);\n\n// // -------------------------\n// // 5) done + idle\n// // -------------------------\n// const doneStatus = {\n//   robot_id: robotId,\n//   state: \"done\",\n//   task_id: task.task_id || null,\n//   battery,\n//   area: curArea,\n//   target_area: null,\n//   error_code: null,\n//   pose,\n//   updated_at: Date.now(),\n// };\n\n// const idleStatus = {\n//   robot_id: robotId,\n//   state: \"idle\",\n//   task_id: null,\n//   battery,\n//   area: curArea,\n//   target_area: null,\n//   error_code: null,\n//   pose,\n//   updated_at: Date.now(),\n// };\n\n// const msgDone = {\n//   topic: `robot/${robotId}/status`,\n//   payload: JSON.stringify(doneStatus),\n//   delay: delayAcc,\n// };\n\n// const msgIdle = {\n//   topic: `robot/${robotId}/status`,\n//   payload: JSON.stringify(idleStatus),\n//   delay: delayAcc + 300,\n// };\n\n// return [msgsRunning, [msgDone, msgIdle]];\n\n\n\n\n// simulateAGV (TRACK Í∏∞Î∞ò Ï£ºÌñâ Î≤ÑÏ†Ñ)\n// output1: running stream(msg.delay ÏÇ¨Ïö©), output2: done + idle\n\n// let task;\n// try {\n//   task = JSON.parse(msg.payload || \"{}\");\n// } catch (e) {\n//   node.error(\"Invalid task JSON in simulateAGV\", msg);\n//   return null;\n// }\n\n// const robotId = \"agv1\";\n// const STEP_MS = 200;\n\n// const AREA_POS = global.get(\"AREA_POS\") || {};\n// const TRACK = global.get(\"TRACK_POINTS\") || [];\n\n// if (!TRACK.length) {\n//   node.error(\"TRACK_POINTS not found. Run InitGlobalState first.\", msg);\n//   return null;\n// }\n\n// // -------------------------\n// // context state\n// // -------------------------\n// let battery = context.get(\"battery\") ?? 80;\n// let area = String(context.get(\"area\") || \"CHARGE\").toUpperCase();\n// let pose = context.get(\"pose\") || null;\n\n// // Î∞∞ÌÑ∞Î¶¨ ÏÇ¥Ïßù ÍπéÍ∏∞\n// battery = Math.max(0, battery - 1);\n// context.set(\"battery\", battery);\n\n// // Íµ¨Î≤ÑÏ†Ñ grid pose Î∞©Ïñ¥\n// function looksLikeOldGridPose(p) {\n//   return p && typeof p.x === \"number\" && typeof p.y === \"number\" && p.x <= 15 && p.y <= 15;\n// }\n// if (!pose || looksLikeOldGridPose(pose)) {\n//   const p0 = AREA_POS[area] || AREA_POS.CHARGE;\n//   pose = { x: p0.x, y: p0.y, theta: 0 };\n//   context.set(\"pose\", pose);\n// }\n\n// // area legacy Î∞©Ïñ¥\n// const legacyAreaMap = { BASE: \"CHARGE\", DOCK: \"CHARGE\", USER1: \"RES_A\", USER2: \"RES_B\", HOME: \"CHARGE\" };\n// if (legacyAreaMap[area]) {\n//   area = legacyAreaMap[area];\n//   context.set(\"area\", area);\n// }\n\n// // -------------------------\n// // helpers\n// // -------------------------\n// function dist(a, b) { return Math.hypot(a.x - b.x, a.y - b.y); }\n// function heading(from, to) { return Math.atan2(to.y - from.y, to.x - from.x); }\n\n// function nearestIdx(p) {\n//   let best = 0;\n//   let bestD = 1e18;\n//   for (let i = 0; i < TRACK.length; i++) {\n//     const d = (TRACK[i].x - p.x) ** 2 + (TRACK[i].y - p.y) ** 2;\n//     if (d < bestD) { bestD = d; best = i; }\n//   }\n//   return best;\n// }\n\n// function sliceLoop(i0, i1, dir) {\n//   const n = TRACK.length;\n//   const out = [TRACK[i0]];\n//   let i = i0;\n//   while (i !== i1) {\n//     i = (i + dir + n) % n;\n//     out.push(TRACK[i]);\n//     if (out.length > n + 5) break; // safety\n//   }\n//   return out;\n// }\n\n// function pathLen(path) {\n//   let s = 0;\n//   for (let i = 1; i < path.length; i++) s += dist(path[i - 1], path[i]);\n//   return s;\n// }\n\n// function bestPathOnLoop(p0, p1) {\n//   const i0 = nearestIdx(p0);\n//   const i1 = nearestIdx(p1);\n//   const fwd = sliceLoop(i0, i1, +1);\n//   const bwd = sliceLoop(i0, i1, -1);\n//   return (pathLen(fwd) <= pathLen(bwd)) ? fwd : bwd;\n// }\n\n// // Í±∞Î¶¨Í∏∞Î∞ò resample (steps+1Í∞ú)\n// function resample(path, count) {\n//   if (!path.length) return [];\n//   if (path.length === 1) return Array(count).fill({ ...path[0] });\n\n//   // ÎàÑÏ†ÅÍ±∞Î¶¨\n//   const seg = [];\n//   let total = 0;\n//   for (let i = 1; i < path.length; i++) {\n//     const d = dist(path[i - 1], path[i]);\n//     seg.push(d);\n//     total += d;\n//   }\n//   if (total <= 1e-9) return Array(count).fill({ ...path[0] });\n\n//   const out = [];\n//   let acc = 0;\n//   let si = 0;\n\n//   out.push({ ...path[0] });\n\n//   for (let k = 1; k < count; k++) {\n//     const target = (total * k) / (count - 1);\n//     while (si < seg.length && acc + seg[si] < target) {\n//       acc += seg[si];\n//       si++;\n//     }\n//     if (si >= seg.length) { out.push({ ...path[path.length - 1] }); continue; }\n\n//     const t = (target - acc) / (seg[si] || 1);\n//     const a = path[si];\n//     const b = path[si + 1] || path[si];\n//     out.push({ x: a.x + (b.x - a.x) * t, y: a.y + (b.y - a.y) * t });\n//   }\n//   return out;\n// }\n\n// // target_area Ï†ïÍ∑úÌôî\n// function normTargetArea(raw) {\n//   const s = String(raw || \"\").toUpperCase();\n//   const map = { USER1: \"RES_A\", USER2: \"RES_B\", USER3: \"RES_C\", BASE: \"CHARGE\", HOME: \"CHARGE\", DOCK: \"CHARGE\" };\n//   if (map[s]) return map[s];\n//   if ([\"CHARGE\", \"WATER\", \"DROP\", \"RES_A\", \"RES_B\", \"RES_C\"].includes(s)) return s;\n//   return \"RES_B\";\n// }\n// const userArea = normTargetArea(task.target_area);\n\n// // -------------------------\n// // waypoint plan\n// // -------------------------\n// let waypoints = [];\n// if (task.type === \"deliver_water\") {\n//   waypoints = [\"WATER\", userArea, \"CHARGE\"];\n// } else if (task.type === \"collect_cup\" || task.type === \"collect_laundry\") {\n//   waypoints = [userArea, \"DROP\", \"CHARGE\"];\n// } else {\n//   waypoints = [userArea, \"CHARGE\"];\n// }\n\n// // -------------------------\n// // duration (expected Í∏∞Î∞ò + ÏßÄÌÑ∞) + segment Î∂ÑÎ∞∞\n// // -------------------------\n// const base = Number(task.expected_duration_ms) || 20000;\n// const jitter = 0.90 + Math.random() * 0.20; // 0.9~1.1 (ÎÑàÎ¨¥ ÌùîÎì§Î¶¨Î©¥ ÏòÅÏÉÅÏóêÏÑú Ïñ¥ÏÉâÌï¥ÏÑú ÏÇ¥ÏßùÎßå)\n// const TOTAL_MS = Math.round(base * jitter);\n\n// // segmentÎ≥Ñ path/Í±∞Î¶¨ Í≥ÑÏÇ∞\n// let fromPos = { x: pose.x, y: pose.y };\n// let segPaths = [];\n// let segDists = [];\n// let totalDist = 0;\n\n// for (const wp of waypoints) {\n//   const toPos = AREA_POS[wp] || fromPos;\n//   const p = bestPathOnLoop(fromPos, toPos);\n//   const d = pathLen(p);\n//   segPaths.push({ target: wp, path: p, toPos });\n//   segDists.push(d);\n//   totalDist += d;\n//   fromPos = toPos;\n// }\n// if (totalDist <= 1e-9) totalDist = segDists.length;\n\n// // segment duration Î∞∞Î∂Ñ\n// let segDur = segDists.map(d => Math.max(STEP_MS, Math.round(TOTAL_MS * (d / totalDist))));\n// let sumDur = segDur.reduce((a, b) => a + b, 0);\n// segDur[segDur.length - 1] = Math.max(STEP_MS, segDur[segDur.length - 1] - (sumDur - TOTAL_MS));\n\n// // -------------------------\n// // running stream ÏÉùÏÑ± (Ìä∏Îûô ÏúÑ)\n// // -------------------------\n// const msgsRunning = [];\n// let delayAcc = 0;\n// let curArea = area; // ÎßàÏßÄÎßâ ÎèÑÏ∞© Ï†ïÎ•òÏû•(ÏãúÏûëÏùÄ CHARGE)\n// const t0 = Date.now();\n\n// let curPos2 = { x: pose.x, y: pose.y };\n\n// for (let s = 0; s < segPaths.length; s++) {\n//   const { target, path, toPos } = segPaths[s];\n//   const dur = segDur[s];\n\n//   const steps = Math.max(1, Math.floor(dur / STEP_MS));\n//   let samples = resample(path, steps + 1);\n\n//   // Îã§Ïùå ÏÑ∏Í∑∏Î®ºÌä∏ ÏãúÏûëÍ≥º Ï§ëÎ≥µ Î∞©ÏßÄ(Ï≤´ Ï†ê Ï†úÍ±∞)\n//   if (s > 0 && samples.length > 0) samples = samples.slice(1);\n\n//   for (let i = 0; i < samples.length; i++) {\n//     const p = samples[i];\n//     const next = samples[Math.min(i + 1, samples.length - 1)];\n//     const theta = heading(p, next);\n\n//     const dly = delayAcc + i * STEP_MS;\n\n//     msgsRunning.push({\n//       topic: `robot/${robotId}/status`,\n//       payload: JSON.stringify({\n//         robot_id: robotId,\n//         state: \"running\",\n//         task_id: task.task_id || null,\n//         battery,\n//         area: curArea,       // ‚≠ê ‚ÄúÎßàÏßÄÎßâ ÎèÑÏ∞© Ï†ïÎ•òÏû•‚Äù\n//         target_area: target, // ‚≠ê ‚ÄúÏßÄÍ∏à Í∞ÄÎäî Ï†ïÎ•òÏû•‚Äù\n//         error_code: null,\n//         pose: { x: p.x, y: p.y, theta },\n//         updated_at: t0 + dly,\n//       }),\n//       delay: dly,\n//     });\n//   }\n\n//   // ÏÑ∏Í∑∏Î®ºÌä∏ ÎÅù ‚Üí Ï†ïÎ•òÏû• ÎèÑÏ∞©\n//   delayAcc += dur;\n//   curArea = target;\n//   curPos2 = toPos;\n// }\n\n// // ÏôÑÎ£å ÏúÑÏπò Ï†ÄÏû•(ÎåÄÎ∂ÄÎ∂Ñ CHARGE)\n// context.set(\"pose\", { x: curPos2.x, y: curPos2.y, theta: 0 });\n// context.set(\"area\", curArea);\n\n// // -------------------------\n// // done + idle\n// // -------------------------\n// const doneStatus = {\n//   robot_id: robotId,\n//   state: \"done\",\n//   task_id: task.task_id || null,\n//   battery,\n//   area: curArea,\n//   target_area: null,\n//   error_code: null,\n//   pose: { x: curPos2.x, y: curPos2.y, theta: 0 },\n//   updated_at: t0 + delayAcc,\n// };\n\n// const idleStatus = {\n//   ...doneStatus,\n//   state: \"idle\",\n//   task_id: null,\n//   updated_at: t0 + delayAcc + 300,\n// };\n\n// return [\n//   msgsRunning,\n//   [\n//     { topic: `robot/${robotId}/status`, payload: JSON.stringify(doneStatus), delay: delayAcc },\n//     { topic: `robot/${robotId}/status`, payload: JSON.stringify(idleStatus), delay: delayAcc + 300 },\n//   ],\n// ];\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nlet task;\ntry {\n  task = JSON.parse(msg.payload || \"{}\");\n} catch (e) {\n  node.error(\"Invalid task JSON in simulateAGV\", msg);\n  return null;\n}\n\nconst robotId = \"agv1\";\nconst STEP_MS = 200;\n\nconst AREA_POS = global.get(\"AREA_POS\") || {};\nconst RAW_TRACK = global.get(\"TRACK_POINTS\") || [];\n\n// -------------------------\n// ‚úÖ NEW) Track normalize (calib dense often has last==first)\n// -------------------------\nfunction clamp100(v) {\n  if (!Number.isFinite(v)) return 0;\n  return Math.max(0, Math.min(100, v));\n}\nfunction dist2(a, b) {\n  const dx = a.x - b.x, dy = a.y - b.y;\n  return dx * dx + dy * dy;\n}\nfunction normalizeTrack(points) {\n  let arr = Array.isArray(points) ? points : [];\n  arr = arr\n    .filter(p => p && Number.isFinite(p.x) && Number.isFinite(p.y))\n    .map(p => ({ x: clamp100(p.x), y: clamp100(p.y) }));\n\n  if (arr.length < 2) return arr;\n\n  // (1) ÎßàÏßÄÎßâ Ï†êÏù¥ Ï≤´ Ï†êÍ≥º Í∞ôÏúºÎ©¥ Ï†úÍ±∞\n  if (dist2(arr[0], arr[arr.length - 1]) < 0.0001) {\n    arr = arr.slice(0, -1);\n  }\n\n  // (2) Ïó∞ÏÜç Ï§ëÎ≥µÎèÑ Ï†úÍ±∞ (ÌòπÏãú Î™®Î•º ÏïàÏ†ÑÏû•Ïπò)\n  const out = [arr[0]];\n  for (let i = 1; i < arr.length; i++) {\n    if (dist2(arr[i], out[out.length - 1]) < 0.0001) continue;\n    out.push(arr[i]);\n  }\n  return out;\n}\n\nconst TRACK = normalizeTrack(RAW_TRACK);\n\nif (!TRACK.length) {\n  node.error(\"TRACK_POINTS not found. Run InitGlobalState first.\", msg);\n  return null;\n}\n\n// -------------------------\n// context state\n// -------------------------\nlet battery = context.get(\"battery\") ?? 80;\nlet area = String(context.get(\"area\") || \"CHARGE\").toUpperCase();\nlet pose = context.get(\"pose\") || null;\n\n// Î∞∞ÌÑ∞Î¶¨ ÏÇ¥Ïßù ÍπéÍ∏∞\nbattery = Math.max(0, battery - 1);\ncontext.set(\"battery\", battery);\n\n// -------------------------\n// helpers\n// -------------------------\nfunction dist(a, b) { return Math.hypot(a.x - b.x, a.y - b.y); }\nfunction heading(from, to) { return Math.atan2(to.y - from.y, to.x - from.x); }\n\nfunction nearestIdx(p) {\n  let best = 0;\n  let bestD = 1e18;\n  for (let i = 0; i < TRACK.length; i++) {\n    const d = (TRACK[i].x - p.x) ** 2 + (TRACK[i].y - p.y) ** 2;\n    if (d < bestD) { bestD = d; best = i; }\n  }\n  return best;\n}\n\n// ‚úÖ NEW) snapToTrack: AREA_POS ÎàÑÎùΩ/pose Ïù¥ÏÉÅ Ïãú ÏïàÏ†ÑÌïòÍ≤å Ìä∏Îûô ÏúÑÎ°ú Ïò¨Î¶¨Í∏∞\nfunction snapToTrack(p) {\n  const i = nearestIdx(p);\n  const q = TRACK[i] || TRACK[0];\n  return { x: q.x, y: q.y };\n}\n\n// ‚úÖ NEW) pose/AREA_POS Î∞©Ïñ¥ Í∞ïÌôî\nfunction looksLikeOldGridPose(p) {\n  return p && typeof p.x === \"number\" && typeof p.y === \"number\" && p.x <= 15 && p.y <= 15;\n}\nif (!pose || looksLikeOldGridPose(pose)) {\n  const p0 = AREA_POS[area] || AREA_POS.CHARGE || TRACK[0];\n  pose = { x: p0.x, y: p0.y, theta: 0 };\n  // ÌòπÏãú AREA_POSÍ∞Ä Ìä∏Îûô Î∞ñÏù¥Î©¥ Ìä∏ÎûôÏúºÎ°ú Ïä§ÎÉÖ\n  const sp = snapToTrack(pose);\n  pose = { x: sp.x, y: sp.y, theta: 0 };\n  context.set(\"pose\", pose);\n}\n\n// area legacy Î∞©Ïñ¥\nconst legacyAreaMap = { BASE: \"CHARGE\", DOCK: \"CHARGE\", USER1: \"RES_A\", USER2: \"RES_B\", HOME: \"CHARGE\" };\nif (legacyAreaMap[area]) {\n  area = legacyAreaMap[area];\n  context.set(\"area\", area);\n}\n\nfunction sliceLoop(i0, i1, dir) {\n  const n = TRACK.length;\n  const out = [TRACK[i0]];\n  let i = i0;\n  while (i !== i1) {\n    i = (i + dir + n) % n;\n    out.push(TRACK[i]);\n    if (out.length > n + 5) break; // safety\n  }\n  return out;\n}\n\nfunction pathLen(path) {\n  let s = 0;\n  for (let i = 1; i < path.length; i++) s += dist(path[i - 1], path[i]);\n  return s;\n}\n\nfunction bestPathOnLoop(p0, p1) {\n  // ‚úÖ NEW) ÏãúÏûë/ÎèÑÏ∞©ÎèÑ Ìä∏ÎûôÏúºÎ°ú Ïä§ÎÉÖÌï¥ÏÑú Î£®ÌîÑ Ïù∏Îç±Ïä§ ÏïàÏ†ïÌôî\n  const sp0 = snapToTrack(p0);\n  const sp1 = snapToTrack(p1);\n\n  const i0 = nearestIdx(sp0);\n  const i1 = nearestIdx(sp1);\n\n  const fwd = sliceLoop(i0, i1, +1);\n  const bwd = sliceLoop(i0, i1, -1);\n  return (pathLen(fwd) <= pathLen(bwd)) ? fwd : bwd;\n}\n\n// Í±∞Î¶¨Í∏∞Î∞ò resample (steps+1Í∞ú)\nfunction resample(path, count) {\n  if (!path.length) return [];\n  if (path.length === 1) return Array(count).fill({ ...path[0] });\n\n  const seg = [];\n  let total = 0;\n  for (let i = 1; i < path.length; i++) {\n    const d = dist(path[i - 1], path[i]);\n    seg.push(d);\n    total += d;\n  }\n  if (total <= 1e-9) return Array(count).fill({ ...path[0] });\n\n  const out = [];\n  let acc = 0;\n  let si = 0;\n\n  out.push({ ...path[0] });\n\n  for (let k = 1; k < count; k++) {\n    const target = (total * k) / (count - 1);\n    while (si < seg.length && acc + seg[si] < target) {\n      acc += seg[si];\n      si++;\n    }\n    if (si >= seg.length) { out.push({ ...path[path.length - 1] }); continue; }\n\n    const t = (target - acc) / (seg[si] || 1);\n    const a = path[si];\n    const b = path[si + 1] || path[si];\n    out.push({ x: a.x + (b.x - a.x) * t, y: a.y + (b.y - a.y) * t });\n  }\n  return out;\n}\n\n// target_area Ï†ïÍ∑úÌôî\nfunction normTargetArea(raw) {\n  const s = String(raw || \"\").toUpperCase();\n  const map = { USER1: \"RES_A\", USER2: \"RES_B\", USER3: \"RES_C\", BASE: \"CHARGE\", HOME: \"CHARGE\", DOCK: \"CHARGE\" };\n  if (map[s]) return map[s];\n  if ([\"CHARGE\", \"WATER\", \"DROP\", \"RES_A\", \"RES_B\", \"RES_C\"].includes(s)) return s;\n  return \"RES_B\";\n}\nconst userArea = normTargetArea(task.target_area);\n\n// -------------------------\n// waypoint plan\n// -------------------------\nlet waypoints = [];\nif (task.type === \"deliver_water\") {\n  waypoints = [\"WATER\", userArea, \"CHARGE\"];\n} else if (task.type === \"collect_cup\" || task.type === \"collect_laundry\") {\n  waypoints = [userArea, \"DROP\", \"CHARGE\"];\n} else {\n  waypoints = [userArea, \"CHARGE\"];\n}\n\n// -------------------------\n// duration (expected Í∏∞Î∞ò + ÏßÄÌÑ∞) + segment Î∂ÑÎ∞∞\n// -------------------------\nconst base = Number(task.expected_duration_ms) || 20000;\nconst jitter = 0.90 + Math.random() * 0.20; // 0.9~1.1\nconst TOTAL_MS = Math.round(base * jitter);\n\n// segmentÎ≥Ñ path/Í±∞Î¶¨ Í≥ÑÏÇ∞\nlet fromPos = { x: pose.x, y: pose.y };\nlet segPaths = [];\nlet segDists = [];\nlet totalDist = 0;\n\nfor (const wp of waypoints) {\n  // ‚úÖ NEW) AREA_POSÍ∞Ä ÏóÜÏúºÎ©¥ fromPos Í∏∞Ï§Ä Ïä§ÎÉÖ(Ïïà Ï£ΩÍ≤å)\n  const toPosRaw = AREA_POS[wp] || fromPos;\n  const toPos = snapToTrack(toPosRaw);\n\n  const p = bestPathOnLoop(fromPos, toPos);\n  const d = pathLen(p);\n\n  segPaths.push({ target: wp, path: p, toPos });\n  segDists.push(d);\n  totalDist += d;\n  fromPos = toPos;\n}\nif (totalDist <= 1e-9) totalDist = segDists.length;\n\n// segment duration Î∞∞Î∂Ñ\nlet segDur = segDists.map(d => Math.max(STEP_MS, Math.round(TOTAL_MS * (d / totalDist))));\nlet sumDur = segDur.reduce((a, b) => a + b, 0);\nsegDur[segDur.length - 1] = Math.max(STEP_MS, segDur[segDur.length - 1] - (sumDur - TOTAL_MS));\n\n// -------------------------\n// running stream ÏÉùÏÑ± (Ìä∏Îûô ÏúÑ)\n// -------------------------\nconst msgsRunning = [];\nlet delayAcc = 0;\nlet curArea = area; // ÎßàÏßÄÎßâ ÎèÑÏ∞© Ï†ïÎ•òÏû•\nconst t0 = Date.now();\n\nlet curPos2 = { x: pose.x, y: pose.y };\n\nfor (let s = 0; s < segPaths.length; s++) {\n  const { target, path, toPos } = segPaths[s];\n  const dur = segDur[s];\n\n  const steps = Math.max(1, Math.floor(dur / STEP_MS));\n  let samples = resample(path, steps + 1);\n\n  // Îã§Ïùå ÏÑ∏Í∑∏Î®ºÌä∏ ÏãúÏûëÍ≥º Ï§ëÎ≥µ Î∞©ÏßÄ(Ï≤´ Ï†ê Ï†úÍ±∞)\n  if (s > 0 && samples.length > 0) samples = samples.slice(1);\n\n  for (let i = 0; i < samples.length; i++) {\n    const p = samples[i];\n    const next = samples[Math.min(i + 1, samples.length - 1)];\n    const theta = heading(p, next);\n\n    const dly = delayAcc + i * STEP_MS;\n\n    msgsRunning.push({\n      topic: `robot/${robotId}/status`,\n      payload: JSON.stringify({\n        robot_id: robotId,\n        state: \"running\",\n        task_id: task.task_id || null,\n        battery,\n        area: curArea,\n        target_area: target,\n        error_code: null,\n        pose: { x: p.x, y: p.y, theta },\n        updated_at: t0 + dly,\n      }),\n      delay: dly,\n    });\n  }\n\n  // ÏÑ∏Í∑∏Î®ºÌä∏ ÎÅù ‚Üí Ï†ïÎ•òÏû• ÎèÑÏ∞©\n  delayAcc += dur;\n  curArea = target;\n  curPos2 = toPos;\n}\n\n// ÏôÑÎ£å ÏúÑÏπò Ï†ÄÏû•\ncontext.set(\"pose\", { x: curPos2.x, y: curPos2.y, theta: 0 });\ncontext.set(\"area\", curArea);\n\n// -------------------------\n// done + idle\n// -------------------------\nconst doneStatus = {\n  robot_id: robotId,\n  state: \"done\",\n  task_id: task.task_id || null,\n  battery,\n  area: curArea,\n  target_area: null,\n  error_code: null,\n  pose: { x: curPos2.x, y: curPos2.y, theta: 0 },\n  updated_at: t0 + delayAcc,\n};\n\nconst idleStatus = {\n  ...doneStatus,\n  state: \"idle\",\n  task_id: null,\n  updated_at: t0 + delayAcc + 300,\n};\n\nreturn [\n  msgsRunning,\n  [\n    { topic: `robot/${robotId}/status`, payload: JSON.stringify(doneStatus), delay: delayAcc },\n    { topic: `robot/${robotId}/status`, payload: JSON.stringify(idleStatus), delay: delayAcc + 300 },\n  ],\n];\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 850,
        "y": 1480,
        "wires": [
            [
                "c892835546595db4"
            ],
            [
                "c892835546595db4"
            ]
        ]
    },
    {
        "id": "e5f2fa78b4c8f5b4",
        "type": "mqtt out",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3c16a07776b27396",
        "x": 1470,
        "y": 1420,
        "wires": []
    },
    {
        "id": "5462d48ba72465a3",
        "type": "mqtt out",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3c16a07776b27396",
        "x": 1470,
        "y": 1560,
        "wires": []
    },
    {
        "id": "c892835546595db4",
        "type": "delay",
        "z": "49f8711fc297a8c1",
        "name": "",
        "pauseType": "delayv",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1060,
        "y": 1560,
        "wires": [
            [
                "5462d48ba72465a3",
                "d79424313dccb2f0"
            ]
        ]
    },
    {
        "id": "a50e6fc76e6e8f77",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 3",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 540,
        "y": 1500,
        "wires": []
    },
    {
        "id": "d79424313dccb2f0",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 4",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1220,
        "y": 1580,
        "wires": []
    },
    {
        "id": "0e18ed358d9967fb",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 5",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1220,
        "y": 1440,
        "wires": []
    },
    {
        "id": "9a5002eb64eee3d0",
        "type": "http in",
        "z": "49f8711fc297a8c1",
        "name": "GET /api/robots",
        "url": "/api/robots",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 400,
        "y": 1740,
        "wires": [
            [
                "1099aa542425c508"
            ]
        ]
    },
    {
        "id": "1099aa542425c508",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "buildRobotsResponse",
        "func": "// // global.robotsÎ•º ÏùΩÏñ¥ÏÑú API ÏùëÎãµ ÌòïÌÉúÎ°ú ÎßåÎì§Ïñ¥Ï£ºÎäî Ìï®Ïàò\n\n// const robotsObj = global.get('robots') || {};\n// const robotsArr = [];\n\n// // Í∞ùÏ≤¥ ‚Üí Î∞∞Ïó¥Î°ú Î≥ÄÌôò\n// for (const id in robotsObj) {\n//     const r = robotsObj[id] || {};\n//     robotsArr.push(r);\n// }\n\n// // JSON ÏùëÎãµ ÌòïÌÉú ÏÑ∏ÌåÖ\n// msg.payload = {\n//     robots: robotsArr\n// };\n\n// // Ìó§ÎçîÏóê JSONÏù¥ÎùºÍ≥† Î™ÖÏãú\n// msg.headers = {\n//     'Content-Type': 'application/json'\n// };\n\n// return msg;\n\nconst db = global.get(\"db\");\nif (!db) {\n  msg.statusCode = 503;\n  msg.headers = { \"Content-Type\": \"application/json\" };\n  msg.payload = { error: \"firestore not ready\" };\n  return msg;\n}\n\nconst limit = Math.min(parseInt((msg.req?.query?.limit ?? \"100\"), 10) || 100, 500);\n\nreturn new Promise(async (resolve) => {\n  try {\n    // updated_at Í∏∞Ï§Ä ÏµúÏã†Ïàú (ÌïÑÎìú ÏóÜÏúºÎ©¥ Ïù∏Îç±Ïä§/Ï†ïÎ†¨ Ïù¥Ïäà Í∞ÄÎä•)\n    let q = db.collection(\"robots\");\n\n    // orderByÎäî ÌïÑÎìúÍ∞Ä ÏïàÏ†ïÏ†ÅÏúºÎ°ú Îì§Ïñ¥Í∞ÄÏïº Ìï®. Ïïà Îì§Ïñ¥Í∞Ñ Î¨∏ÏÑúÍ∞Ä ÏûàÏúºÎ©¥ Ï†ïÎ†¨ÏóêÏÑú Îπ†Ïßà Ïàò ÏûàÏùå.\n    // ÎÑà updateStatusÏóêÏÑú updated_atÏùÑ Ìï≠ÏÉÅ ÎÑ£Í≥† ÏûàÏñ¥ÏÑú OK. :contentReference[oaicite:2]{index=2}\n    q = q.orderBy(\"updated_at\", \"desc\").limit(limit);\n\n    const snap = await q.get();\n    const robots = snap.docs.map(d => d.data());\n\n    msg.statusCode = 200;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { robots };\n    resolve(msg);\n  } catch (err) {\n    node.error(err);\n    msg.statusCode = 500;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { error: \"failed to fetch robots\", detail: String(err?.message || err) };\n    resolve(msg);\n  }\n});",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 1740,
        "wires": [
            [
                "04c572829db161a8"
            ]
        ]
    },
    {
        "id": "04c572829db161a8",
        "type": "http response",
        "z": "49f8711fc297a8c1",
        "name": "res /api/robots",
        "statusCode": "",
        "headers": {},
        "x": 980,
        "y": 1740,
        "wires": []
    },
    {
        "id": "cf9e4d5c0ec26f3f",
        "type": "http in",
        "z": "49f8711fc297a8c1",
        "name": "GET /api/tasks",
        "url": "/api/tasks",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 400,
        "y": 1820,
        "wires": [
            [
                "4db69741e35d7aaa"
            ]
        ]
    },
    {
        "id": "4db69741e35d7aaa",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "buildTasksResponse",
        "func": "// let tasks = global.get('taskQueue') || [];\n\n// // ÏµúÏã†Ïàú Ï†ïÎ†¨ (VueÏóêÏÑú Î≥¥Í∏∞ Ï¢ãÍ≤å)\n// tasks = tasks.slice().sort((a, b) => (b.created_at || 0) - (a.created_at || 0));\n\n// msg.payload = { tasks };\n// msg.headers = { \"Content-Type\": \"application/json\" };\n// return msg;\n\nconst db = global.get(\"db\");\nif (!db) {\n  msg.statusCode = 503;\n  msg.headers = { \"Content-Type\": \"application/json\" };\n  msg.payload = { error: \"firestore not ready\" };\n  return msg;\n}\n\nconst q = msg.req?.query || {};\nconst status = (q.status || \"\").toString().trim(); // pending|running|done|failed Îì±\nconst limit = Math.min(parseInt((q.limit ?? \"50\"), 10) || 50, 500);\n\nreturn new Promise(async (resolve) => {\n  try {\n    let ref = db.collection(\"tasks\");\n\n    // status ÌïÑÌÑ∞ (ÏòµÏÖò)\n    if (status) {\n      ref = ref.where(\"status\", \"==\", status);\n      // where + orderBy Ï°∞Ìï© Ïãú Ïù∏Îç±Ïä§ ÌïÑÏöîÌï† Ïàò ÏûàÏùå (ÏóêÎü¨ Î©îÏãúÏßÄÏóê ÏÉùÏÑ± ÎßÅÌÅ¨ ÎÇòÏò¥)\n    }\n\n    // created_at ÏµúÏã†Ïàú\n    ref = ref.orderBy(\"created_at\", \"desc\").limit(limit);\n\n    const snap = await ref.get();\n    const tasks = snap.docs.map(d => d.data());\n\n    msg.statusCode = 200;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { tasks };\n    resolve(msg);\n  } catch (err) {\n    node.error(err);\n    msg.statusCode = 500;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { error: \"failed to fetch tasks\", detail: String(err?.message || err) };\n    resolve(msg);\n  }\n});\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 1820,
        "wires": [
            [
                "bd552ae11c61fc7b"
            ]
        ]
    },
    {
        "id": "bd552ae11c61fc7b",
        "type": "http response",
        "z": "49f8711fc297a8c1",
        "name": "res /api/tasks",
        "statusCode": "",
        "headers": {},
        "x": 970,
        "y": 1820,
        "wires": []
    },
    {
        "id": "3dc12e5ce8d5567e",
        "type": "http in",
        "z": "49f8711fc297a8c1",
        "name": "GET /api/events",
        "url": "/api/events",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 400,
        "y": 1900,
        "wires": [
            [
                "47eeabd70b7c449b"
            ]
        ]
    },
    {
        "id": "47eeabd70b7c449b",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "buildEventsResponse",
        "func": "// let events = global.get('events') || [];\n\n// // ÏµúÏã†Ïàú Ï†ïÎ†¨\n// events = events.slice().sort((a, b) => (b.ts || 0) - (a.ts || 0));\n\n// msg.payload = { events };\n// msg.headers = { \"Content-Type\": \"application/json\" };\n// return msg;\n\nconst db = global.get(\"db\");\nif (!db) {\n  msg.statusCode = 503;\n  msg.headers = { \"Content-Type\": \"application/json\" };\n  msg.payload = { error: \"firestore not ready\" };\n  return msg;\n}\n\nconst limit = Math.min(parseInt((msg.req?.query?.limit ?? \"50\"), 10) || 50, 500);\n\nreturn new Promise(async (resolve) => {\n  try {\n    const snap = await db\n      .collection(\"events\")\n      .orderBy(\"ts\", \"desc\")\n      .limit(limit)\n      .get();\n\n    const events = snap.docs.map(d => d.data());\n\n    msg.statusCode = 200;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { events };\n    resolve(msg);\n  } catch (err) {\n    node.error(err);\n    msg.statusCode = 500;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { error: \"failed to fetch events\", detail: String(err?.message || err) };\n    resolve(msg);\n  }\n});\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 1900,
        "wires": [
            [
                "14173b48771091af"
            ]
        ]
    },
    {
        "id": "14173b48771091af",
        "type": "http response",
        "z": "49f8711fc297a8c1",
        "name": "res /api/events",
        "statusCode": "",
        "headers": {},
        "x": 980,
        "y": 1900,
        "wires": []
    },
    {
        "id": "aae26e35525d4347",
        "type": "http in",
        "z": "49f8711fc297a8c1",
        "name": "GET /api/summary",
        "url": "/api/summary",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 410,
        "y": 1980,
        "wires": [
            [
                "3252b669c8d4ee2a"
            ]
        ]
    },
    {
        "id": "3252b669c8d4ee2a",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "buildSummaryResponse",
        "func": "// const robots = global.get('robots') || {};\n// const tasks = global.get('taskQueue') || [];\n\n// let total = 0, idle = 0, running = 0, charging = 0, error = 0, others = 0;\n// for (const id in robots) {\n//     total++;\n//     const s = (robots[id].state || '').toLowerCase();\n//     if (s === 'idle') idle++;\n//     else if (s === 'running') running++;\n//     else if (s === 'charging') charging++;\n//     else if (s === 'error' || s === 'failed' || s === 'fault') error++;\n//     else others++;\n// }\n\n// let tTotal = tasks.length;\n// let tPending = 0, tRunning = 0, tDone = 0, tFailed = 0;\n// for (const t of tasks) {\n//     const s = (t.status || '').toLowerCase();\n//     if (s === 'pending') tPending++;\n//     else if (s === 'running') tRunning++;\n//     else if (s === 'done') tDone++;\n//     else if (s === 'failed') tFailed++;\n// }\n\n// msg.payload = {\n//     robots: { total, idle, running, charging, error, others },\n//     tasks:  { total: tTotal, pending: tPending, running: tRunning, done: tDone, failed: tFailed }\n// };\n// msg.headers = { \"Content-Type\": \"application/json\" };\n// return msg;\n\nconst db = global.get(\"db\");\nif (!db) {\n  msg.statusCode = 503;\n  msg.headers = { \"Content-Type\": \"application/json\" };\n  msg.payload = { error: \"firestore not ready\" };\n  return msg;\n}\n\nconst q = msg.req?.query || {};\nconst taskLimit = Math.min(parseInt((q.taskLimit ?? \"200\"), 10) || 200, 1000);\n\nfunction countBy(list, keyFn) {\n  const m = {};\n  for (const x of list) {\n    const k = (keyFn(x) || \"unknown\").toLowerCase();\n    m[k] = (m[k] || 0) + 1;\n  }\n  return m;\n}\n\nreturn new Promise(async (resolve) => {\n  try {\n    // 1) robots Ï†ÑÎ∂Ä ÏùΩÏñ¥ÏÑú ÏÉÅÌÉú Ïπ¥Ïö¥Ìä∏\n    const robotsSnap = await db.collection(\"robots\").get();\n    const robots = robotsSnap.docs.map(d => d.data());\n    const robotCounts = countBy(robots, r => r.state);\n\n    const robotSummary = {\n      total: robots.length,\n      idle: robotCounts.idle || 0,\n      running: robotCounts.running || 0,\n      charging: robotCounts.charging || 0,\n      error: (robotCounts.error || 0) + (robotCounts.failed || 0) + (robotCounts.fault || 0),\n      others:\n        (robotCounts.offline || 0) +\n        (robotCounts.unknown || 0)\n    };\n\n    // 2) tasksÎäî ÏµúÍ∑º NÍ∞úÎßå ÏùΩÏñ¥ÏÑú ÏÉÅÌÉú Ïπ¥Ïö¥Ìä∏ (Phase 0 Í∞ÄÎ≤ºÏö¥ ÏßëÍ≥Ñ)\n    const tasksSnap = await db\n      .collection(\"tasks\")\n      .orderBy(\"created_at\", \"desc\")\n      .limit(taskLimit)\n      .get();\n\n    const tasks = tasksSnap.docs.map(d => d.data());\n    const taskCounts = countBy(tasks, t => t.status);\n\n    const taskSummary = {\n      total: tasks.length,\n      pending: taskCounts.pending || 0,\n      running: taskCounts.running || 0,\n      done: taskCounts.done || 0,\n      failed: taskCounts.failed || 0\n    };\n\n    msg.statusCode = 200;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { robots: robotSummary, tasks: taskSummary, meta: { taskLimit } };\n    resolve(msg);\n  } catch (err) {\n    node.error(err);\n    msg.statusCode = 500;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { error: \"failed to fetch summary\", detail: String(err?.message || err) };\n    resolve(msg);\n  }\n});\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 1980,
        "wires": [
            [
                "bb5bd9f96e8e8313"
            ]
        ]
    },
    {
        "id": "bb5bd9f96e8e8313",
        "type": "http response",
        "z": "49f8711fc297a8c1",
        "name": "res /api/summary",
        "statusCode": "",
        "headers": {},
        "x": 990,
        "y": 1980,
        "wires": []
    },
    {
        "id": "a90b7ad07ef61884",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "FIrestore Client Init",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 370,
        "y": 80,
        "wires": [
            [
                "f1509788aad45a75"
            ]
        ]
    },
    {
        "id": "f1509788aad45a75",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "Init Firestore",
        "func": "// admin, fs Îäî Function ÎÖ∏Îìú Setup(Modules)ÏóêÏÑú Ï£ºÏûÖÎ∞õÎäîÎã§Í≥† Í∞ÄÏ†ï\n\n// const keyPath = \"C:/Users/wp3wk/AppData/Roaming/SPB_Data/.node-red/agv-pjt2-firebase-adminsdk-fbsvc-18055a3bd9.json\"; // ÎÇ¥ ÌååÏù¥Ïñ¥Ïä§ÌÜ†Ïñ¥\nconst keyPath = \"C:/Users/wp3wk/AppData/Roaming/SPB_Data/.node-red/agv-pjt2-9d394-firebase-adminsdk-fbsvc-9079c95fe9.json\" // Ïú†ÏßÑÏù¥ ÌååÏù¥Ïñ¥Ïä§ÌÜ†Ïñ¥\n// 0) ÏÑúÎπÑÏä§ Í≥ÑÏ†ï ÌååÏùº Ï°¥Ïû¨ ÌôïÏù∏\nif (!fs.existsSync(keyPath)) {\n  node.error(\"‚ùå Service account json not found: \" + keyPath);\n  return null;\n}\n\nconst serviceAccount = JSON.parse(fs.readFileSync(keyPath, \"utf8\"));\n\n// 1) Í∏∞Ï°¥ firebase-admin Ïï±Ïù¥ ÏûàÏúºÎ©¥ Ï†úÍ±∞ (ÌîÑÎ°úÏ†ùÌä∏ Î≥ÄÍ≤Ω Ïãú ÌïÑÏàò)\nif (admin.apps && admin.apps.length > 0) {\n  return admin.app().delete().then(() => {\n    node.warn(\"‚ôªÔ∏è Old firebase app deleted. Re-initializing...\");\n    return init();\n  }).catch(err => {\n    node.error(\"‚ùå Failed to delete old firebase app: \" + err.message);\n    return null;\n  });\n}\n\n// 2) Ïã§Ï†ú Ï¥àÍ∏∞Ìôî Ìï®Ïàò\nfunction init() {\n  admin.initializeApp({\n    credential: admin.credential.cert(serviceAccount),\n  });\n\n  const db = admin.firestore();\n\n  global.set(\"admin\", admin);\n  global.set(\"db\", db);\n  global.set(\"firestoreReady\", true);\n\n  // 3) healthcheck write (ÏÑ±Í≥µ Ïó¨Î∂Ä Î™ÖÌôïÌûà ÌôïÏù∏)\n  return db.collection(\"_healthcheck\").doc(\"init\").set({\n    ts: Date.now(),\n    project_id: serviceAccount.project_id,\n  }).then(() => {\n    node.warn(\"‚úÖ Firestore initialized!\");\n    node.warn(\"üëâ project_id = \" + serviceAccount.project_id);\n    return null;\n  }).catch(err => {\n    node.error(\"‚ùå Firestore healthcheck write failed: \" + err.message);\n    return null;\n  });\n}\n\nreturn init();\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "admin",
                "module": "firebase-admin"
            },
            {
                "var": "fs",
                "module": "fs"
            }
        ],
        "x": 610,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "2ccacb1608c5ba74",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "FS : write task (create)",
        "func": "const db = global.get(\"db\");\nif (!db) {\n    node.warn(\"Firestore not ready - skip write\");\n    return msg;\n}\n\nconst task = msg.task;\nif (!task || !task.task_id) return msg;\n\ndb.collection(\"tasks\").doc(task.task_id).set(task, { merge: true })\n    .then(() => node.warn(`FS task created: ${task.task_id}`))\n    .catch(err => node.error(err));\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1080,
        "y": 1120,
        "wires": [
            [
                "8fa070ba704430fc",
                "ce111f86ccf22e93"
            ]
        ]
    },
    {
        "id": "58d8d616da6872e1",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "FS: update task (assigned)",
        "func": "const db = global.get(\"db\");\nif (!db) return msg;\n\nconst task = msg.task;\nif (!task || !task.task_id) return msg;\n\ndb.collection(\"tasks\").doc(task.task_id).set(task, { merge: true })\n    .then(() => node.warn(`FS task assigned: ${task.task_id}`))\n    .catch(err => node.error(err));\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1780,
        "y": 1120,
        "wires": [
            [
                "c02ac5399c925f84"
            ]
        ]
    },
    {
        "id": "241f54b35e15895f",
        "type": "delay",
        "z": "49f8711fc297a8c1",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "2",
        "nbRateUnits": "",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": true,
        "outputs": 1,
        "x": 1040,
        "y": 1420,
        "wires": [
            [
                "e5f2fa78b4c8f5b4",
                "0e18ed358d9967fb"
            ]
        ]
    },
    {
        "id": "54431a46252d1602",
        "type": "http request",
        "z": "49f8711fc297a8c1",
        "name": "",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://gms.ssafy.io/gmsapi/api.openai.com/v1/chat/completions",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 910,
        "y": 480,
        "wires": [
            [
                "7dea3543f230c5e1",
                "fd22aea86440924f"
            ]
        ]
    },
    {
        "id": "c301115701d2a789",
        "type": "mqtt out",
        "z": "49f8711fc297a8c1",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3c16a07776b27396",
        "x": 1930,
        "y": 520,
        "wires": []
    },
    {
        "id": "1f3be0f0cf23a955",
        "type": "telegram sender",
        "z": "49f8711fc297a8c1",
        "name": "",
        "bot": "d10c4415b361b866",
        "haserroroutput": false,
        "outputs": 1,
        "x": 1950,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "7dea3543f230c5e1",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "LLMValidate",
        "func": "const chatId = msg._tg?.chatId;\nconst raw = msg._tg?.raw || \"\";\nconst interactionId = msg._interactionId;\n\nif (!interactionId) {\n  node.error(\"LLMValidate: missing msg._interactionId\", msg);\n  return null;\n}\n\n\nfunction makeReply(content) {\n  return { payload: { chatId, type: \"message\", content } };\n}\n\nfunction fsUpdate(patch) {\n  return {\n    payload: {\n      interaction_id: interactionId,\n      updated_at: Date.now(),\n      ...patch\n    }\n  };\n}\n\n// content Í∫ºÎÇ¥Í∏∞\nlet content = msg.payload?.choices?.[0]?.message?.content || \"\";\n\n// JSONÎßå Ï∂îÏ∂ú\nfunction extractJson(text) {\n  if (!text) return null;\n  text = text.replace(/```json\\s*/g, \"\").replace(/```\\s*/g, \"\").trim();\n  const s = text.indexOf(\"{\");\n  const e = text.lastIndexOf(\"}\");\n  if (s === -1 || e === -1 || e <= s) return null;\n  return text.slice(s, e + 1);\n}\n\nconst jsonStr = extractJson(content);\nif (!jsonStr) {\n  const fsMsg = fsUpdate({\n    result: \"rejected\",\n    error: { stage: \"llm/validate\", message: \"no json extracted\" }\n  });\n  return [makeReply(\"Ï£ÑÏÜ°Ìï¥Ïöî üò• ÏöîÏ≤≠ÏùÑ Ïù¥Ìï¥ÌïòÏßÄ Î™ªÌñàÏñ¥Ïöî. Î≤ÑÌäºÏúºÎ°ú Îã§Ïãú Ìï¥Ï£ºÏÑ∏Ïöî.\"), null, fsMsg];\n}\n\nlet parsed;\ntry { parsed = JSON.parse(jsonStr); }\ncatch {\n  const fsMsg = fsUpdate({\n    result: \"rejected\",\n    error: { stage: \"llm/validate\", message: \"json parse failed\" }\n  });\n  return [makeReply(\"Ï£ÑÏÜ°Ìï¥Ïöî üò• ÏöîÏ≤≠ Ìï¥ÏÑù Í≤∞Í≥ºÍ∞Ä Íπ®Ï°åÏñ¥Ïöî. Î≤ÑÌäºÏúºÎ°ú Îã§Ïãú Ìï¥Ï£ºÏÑ∏Ïöî.\"), null, fsMsg];\n}\n\n// allow-list\nconst ALLOW_TYPE = new Set([\"deliver_water\", \"collect_cup\", \"collect_laundry\"]);\nconst ALLOW_AREA = new Set([\"USER1\", \"USER2\", \"DOCK\", \"BASE\"]);\n\nconst type = parsed.type;\nlet area = parsed.target_area;\n\n// typeÏùÄ Î∞òÎìúÏãú ÏûàÏñ¥Ïïº Ìï®\nif (!ALLOW_TYPE.has(type)) {\n  const fsMsg = fsUpdate({\n    result: \"rejected\",\n    error: { stage: \"llm/validate\", message: `type not allowed: ${String(type)}` },\n    parsed: { type: String(type || \"\"), target_area: String(parsed?.target_area || \"\"), confidence: parsed?.confidence ?? null }\n  });\n  return [makeReply(\"Î¨¥Ïä® ÏöîÏ≤≠Ïù∏ÏßÄ ÌåêÎã®ÌïòÏßÄ Î™ªÌñàÏñ¥Ïöî üò•\\nÎ≤ÑÌäºÏúºÎ°ú Îã§Ïãú ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.\"), null, fsMsg];\n}\n\n// ‚úÖ default area fallback (ÏûÑÏãú: flowÏóê Ï†ÄÏû•, ÏóÜÏúºÎ©¥ USER1)\nlet defaultArea = flow.get(\"default_area_\" + chatId);\nif (!defaultArea) defaultArea = \"USER1\";\n\n// ‚úÖ areaÍ∞Ä ÏóÜÍ±∞ÎÇò Ïù¥ÏÉÅÌïòÎ©¥ defaultÎ°ú Ï±ÑÏõÄ\nif (!ALLOW_AREA.has(area)) {\n  area = defaultArea;\n}\n\n// topic Í≤∞Ï†ï\nconst topic =\n  type === \"deliver_water\" ? \"cmd/water/request\" :\n  type === \"collect_cup\" ? \"cmd/cup/request\" :\n  \"cmd/laundry/request\";\n\n// mqtt\nconst mqttMsg = {\n  topic,\n  payload: JSON.stringify({\n    type,\n    target_area: area,\n    user_id: `tg_${chatId}`,\n    meta: {\n      source: \"telegram\",\n      input: \"text\",\n      raw,\n      default_area_used: !parsed.target_area,\n      interaction_id: interactionId\n    }\n  })\n};\n\nconst pretty =\n  type === \"deliver_water\" ? \"Î¨º Î∞∞Îã¨\" :\n  type === \"collect_cup\" ? \"Ïªµ ÏàòÍ±∞\" : \"ÏÑ∏ÌÉÅÎ¨º ÏàòÍ±∞\";\n\nconst usedMsg = (!parsed.target_area) ? ` (Í∏∞Î≥∏ ÏúÑÏπò: ${area})` : \"\";\n\nconst fsMsg = fsUpdate({\n  result: \"accepted\",\n  parsed: { type, target_area: area, confidence: parsed?.confidence ?? null }\n});\n\nreturn [makeReply(`‚úÖ ${pretty} ÏöîÏ≤≠ÏùÑ Ï†ëÏàòÌñàÏñ¥Ïöî!${usedMsg}`), mqttMsg, fsMsg];\n",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1450,
        "y": 480,
        "wires": [
            [
                "1f3be0f0cf23a955"
            ],
            [
                "c301115701d2a789"
            ],
            [
                "350dfce793e04058"
            ]
        ]
    },
    {
        "id": "fd22aea86440924f",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 6",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1160,
        "y": 500,
        "wires": []
    },
    {
        "id": "350dfce793e04058",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "write interaction(upsert)",
        "func": "const db = global.get(\"db\");\nif (!db) {\n  node.warn(\"Firestore not ready - skip interaction write\");\n  return msg;\n}\n\nconst interaction = msg.payload; // ‚úÖ Ïó¨Í∏∞!\nif (!interaction || !interaction.interaction_id) return msg;\n\ndb.collection(\"interactions\")\n  .doc(interaction.interaction_id)\n  .set(interaction, { merge: true })\n  .then(() => node.warn(`FS interaction upsert: ${interaction.interaction_id}`))\n  .catch(err => node.error(err));\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1810,
        "y": 740,
        "wires": [
            []
        ]
    },
    {
        "id": "1c0f552d8a376fcc",
        "type": "http request",
        "z": "49f8711fc297a8c1",
        "name": "",
        "method": "use",
        "ret": "bin",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1030,
        "y": 860,
        "wires": [
            [
                "04db854fab84c358"
            ]
        ]
    },
    {
        "id": "04db854fab84c358",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "Voice: build whisper request",
        "func": "const fs = global.get(\"fs\");\nconst path = global.get(\"path\");\nconst tempDir = global.get(\"tempDir\");\n\nif (!fs.existsSync(tempDir)) {\n  fs.mkdirSync(tempDir, { recursive: true });\n}\n\nconst filePath = path.join(\n  tempDir,\n  `tg_voice_${Date.now()}.oga`\n);\n\nfs.writeFileSync(filePath, msg.payload);\n\nmsg.voicePath = filePath;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1320,
        "y": 860,
        "wires": [
            [
                "37ab14c5f1fb76e5"
            ]
        ]
    },
    {
        "id": "8f2038d41f373286",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "Voice: build LLMReq for chat/completions",
        "func": "const chatId = msg._tg?.chatId;\nconst interactionId = msg._interactionId;\nconst text = (msg.payload?.text || \"\").trim();\n\nif (!text) {\n  // Ïã§Ìå®: ÌÖîÎ†àÍ∑∏Îû® ÏùëÎãµ + FS updateÎ°ú Î≥¥ÎÇ¥Í≥† ÎÅùÎÇ¥ÎèÑ Îê®\n  msg.payload = { chatId, type:\"message\", content:\"üéôÔ∏è ÏùåÏÑ±ÏùÑ Ïù∏ÏãùÌïòÏßÄ Î™ªÌñàÏñ¥Ïöî. Îã§Ïãú ÎßêÌï¥ Ï£ºÏÑ∏Ïöî.\", options:{} };\n  return [msg, null];\n}\n\n// ‚úÖ Ïó¨Í∏∞ÏÑúÎ∂ÄÌÑ∞Îäî Function1Ïù¥ ÎßåÎì§Îçò llmReqÏôÄ ÏôÑÏ†ÑÌûà ÎèôÏùºÌïú ÌòïÌÉúÎ°ú ÎßåÎì§Í∏∞\nmsg.headers = {\n  \"Content-Type\": \"application/json\",\n  \"Authorization\": `Bearer ${global.get(\"GMS_KEY\")}`\n};\n\nmsg.payload = {\n  model: \"gpt-4.1-nano\",\n  temperature: 0.2,\n  max_tokens: 200,\n  messages: [\n    {\n      role: \"system\",\n      content:\n        \"ÎÑàÎäî AGV ÏÇ¨Ïö©Ïûê Ïï±Ïùò Î™ÖÎ†π ÌååÏÑúÎã§. Î∞òÎìúÏãú JSONÎßå Ï∂úÎ†•Ìï¥.\\n\" +\n        \"ÌóàÏö© type: deliver_water, collect_cup, collect_laundry\\n\" +\n        \"ÌóàÏö© target_area: USER1, USER2, DOCK, BASE\\n\" +\n        'ÌòïÏãù: {\"type\":\"...\",\"target_area\":\"...\",\"confidence\":0.0}\\n' +\n        \"Ï∂îÎ°† ÏÑ§Î™Ö Í∏àÏßÄ. JSON Ïô∏ ÌÖçÏä§Ìä∏ Í∏àÏßÄ.\"\n    },\n    { role: \"user\", content: text }\n  ]\n};\n\n// validateÏóêÏÑú Ïì∞Îäî Î©îÌÉÄ Ïú†ÏßÄ\nmsg._tg = { chatId, raw: text };\nmsg._interactionId = interactionId;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2520,
        "y": 860,
        "wires": [
            [
                "54431a46252d1602"
            ]
        ]
    },
    {
        "id": "f65016bb2f2505ba",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "Set Url",
        "func": "// Voice: set url\nmsg.method = \"GET\";\nmsg.url = msg.weblink;              // ‚úÖ Ïã§Ï†ú Í∞í(https://api.telegram.org/...)Ïù¥ Îì§Ïñ¥Í∞ê\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 810,
        "y": 860,
        "wires": [
            [
                "1c0f552d8a376fcc"
            ]
        ]
    },
    {
        "id": "37ab14c5f1fb76e5",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "build exec cmd",
        "func": "const fs = global.get(\"fs\");\nconst key = global.get(\"GMS_KEY\");\n\nif (!msg.voicePath) { node.error(\"voicePath missing\", msg); return null; }\nif (!fs.existsSync(msg.voicePath)) { node.error(\"voice file not found: \" + msg.voicePath, msg); return null; }\n\nconst boundary = \"----NodeRedFormBoundary\" + Date.now();\nconst CRLF = \"\\r\\n\";\n\n// ÌååÏùº ÏùΩÍ∏∞ (Buffer)\nconst fileBuf = fs.readFileSync(msg.voicePath);\n\n// multipart ÌååÌä∏Îì§ ÎßåÎì§Í∏∞\nfunction partText(name, value) {\n  return Buffer.from(\n    `--${boundary}${CRLF}` +\n    `Content-Disposition: form-data; name=\"${name}\"${CRLF}${CRLF}` +\n    `${value}${CRLF}`\n  );\n}\n\nfunction partFile(name, filename, contentType, dataBuf) {\n  const head = Buffer.from(\n    `--${boundary}${CRLF}` +\n    `Content-Disposition: form-data; name=\"${name}\"; filename=\"${filename}\"${CRLF}` +\n    `Content-Type: ${contentType}${CRLF}${CRLF}`\n  );\n  const tail = Buffer.from(CRLF);\n  return Buffer.concat([head, dataBuf, tail]);\n}\n\nconst end = Buffer.from(`--${boundary}--${CRLF}`);\n\nconst body = Buffer.concat([\n  partText(\"model\", \"whisper-1\"),\n  partFile(\"file\", \"voice.oga\", \"audio/ogg\", fileBuf),\n  end\n]);\n\nmsg.method = \"POST\";\nmsg.url = \"https://gms.ssafy.io/gmsapi/api.openai.com/v1/audio/transcriptions\";\nmsg.headers = {\n  \"Authorization\": `Bearer ${key}`,\n  \"Content-Type\": `multipart/form-data; boundary=${boundary}`,\n  \"Content-Length\": body.length\n};\nmsg.payload = body;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1620,
        "y": 860,
        "wires": [
            [
                "44fe72582d9db9b2"
            ]
        ]
    },
    {
        "id": "996820a5df9eae6f",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "parse whisper result",
        "func": "let obj = null;\ntry {\n  obj = JSON.parse(msg.payload);\n} catch (e) {\n  node.error(\"Whisper response not JSON\", msg);\n  return null;\n}\n\nconst text = (obj.text || \"\").trim();\nif (!text) {\n  msg.payload = { text: \"\" };\n  return msg;\n}\n\n// ------------------------------\n// ‚úÖ Ïó¨Í∏∞Î∂ÄÌÑ∞ Ï∂îÍ∞Ä: Firestore interaction Ï†ïÎ¶¨(clean-up)\n// - raw_input = STT ÌÖçÏä§Ìä∏Î°ú ÎçÆÏñ¥Ïì∞Í∏∞\n// - meta(weblink Îì±) ÏÇ≠Ï†ú\n// ------------------------------\nconst db = global.get(\"db\");\nconst admin = global.get(\"admin\");        // globalÏóê admin Ïò¨Î†§Îëî Í≤ΩÏö∞\nconst interactionId = msg._interactionId; // voice ÌååÏù¥ÌîÑÏóêÏÑú Ïú†ÏßÄ Ï§ëÏù∏ Í∞í\n\nif (db && admin && interactionId) {\n  const FieldValue = admin.firestore.FieldValue;\n\n  db.collection(\"interactions\").doc(interactionId).set({\n    raw_input: text,                 // ‚úÖ Ï†ïÏ†úÎêú ÌÖçÏä§Ìä∏Î°ú ÍµêÏ≤¥\n    meta: FieldValue.delete(),       // ‚úÖ meta ÌÜµÏß∏Î°ú Ï†úÍ±∞\n    updated_at: Date.now()\n  }, { merge: true })\n    .then(() => node.warn(`FS voice cleaned: ${interactionId}`))\n    .catch(err => node.error(err));\n} else {\n  node.warn(\"FS cleanup skipped (missing db/admin/interactionId)\");\n}\n\n// Îã§Ïùå ÎÖ∏ÎìúÎ°ú text ÎÑòÍ∏∞Í∏∞\nmsg.payload = { text };\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2140,
        "y": 860,
        "wires": [
            [
                "8f2038d41f373286"
            ]
        ]
    },
    {
        "id": "44fe72582d9db9b2",
        "type": "http request",
        "z": "49f8711fc297a8c1",
        "name": "",
        "method": "use",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1870,
        "y": 860,
        "wires": [
            [
                "996820a5df9eae6f"
            ]
        ]
    },
    {
        "id": "f0fa65d36b46ef73",
        "type": "http in",
        "z": "49f8711fc297a8c1",
        "name": "GET /api/user/summary",
        "url": "/api/user/summary",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 420,
        "y": 2040,
        "wires": [
            [
                "66ef6c3af246f209"
            ]
        ]
    },
    {
        "id": "66ef6c3af246f209",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "buildUserSummaryResponse",
        "func": "// GET /api/user/summary?user_id=tg_6802468707\n// - ÏûêÎèô polling Í∏àÏßÄ(ÌîÑÎ°†Ìä∏ÏóêÏÑú Î≤ÑÌäº ÎàåÎ†ÄÏùÑ ÎïåÎßå Ìò∏Ï∂ú)\n// - Firestore ÏùΩÍ∏∞ ÏóÜÏù¥ global(robots/taskQueue/taskStats) Í∏∞Î∞òÏúºÎ°ú \"Í∞ÄÎ≥çÍ≤å\" ÏùëÎãµ\n\nconst q = msg.req?.query || {};\nconst userId = q.user_id || q.uid || null;\n\nif (!userId) {\n    msg.statusCode = 400;\n    msg.headers = { \"Content-Type\": \"application/json\" };\n    msg.payload = { error: \"missing user_id (ex: ?user_id=tg_6802468707)\" };\n    return msg;\n}\n\nconst robots = global.get(\"robots\") || {};\nconst taskQueue = global.get(\"taskQueue\") || [];\nconst taskStats = global.get(\"taskStats\") || {};\n\nconst r = robots[\"agv1\"] || null;\n\n// ---- labels\nconst AREA_LABEL = { BASE: \"Î≤†Ïù¥Ïä§\", DOCK: \"ÎèÑÌÇπ\", USER1: \"ÏÇ¨Ïö©Ïûê Íµ¨Ïó≠ 1\", USER2: \"ÏÇ¨Ïö©Ïûê Íµ¨Ïó≠ 2\" };\nconst TYPE_LABEL = { deliver_water: \"‚òï Î¨º Î∞∞Îã¨\", collect_cup: \"ü•§ Ïªµ ÌöåÏàò\", collect_laundry: \"üßπ ÌôòÍ≤Ω Ï†ïÎ¶¨\" };\n\nfunction areaName(a) { return AREA_LABEL[a] || a || \"‚Äî\"; }\nfunction typeName(t) { return TYPE_LABEL[t] || t || \"‚Äî\"; }\n\n// ---- expected duration defaults (ms)\nconst DEFAULT_EXPECT_MS = {\n    deliver_water: 20000,\n    collect_cup: 15000,\n    collect_laundry: 30000\n};\n\n// EMAÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏Í±∏ Ïö∞ÏÑ† ÏÇ¨Ïö©\nfunction expectedMsFor(type) {\n    const ema = taskStats?.[type]?.ema_ms;\n    if (ema != null) return Math.max(1000, Math.round(ema)); // ÏµúÏÜå 1Ï¥à\n    return DEFAULT_EXPECT_MS[type] || 20000;\n}\n\n// ---- KST Î≤îÏúÑ Í≥ÑÏÇ∞ (Ïò§Îäò/Ï£ºÍ∞Ñ)\nfunction startOfKstDay(ts = Date.now()) {\n    const k = new Date(ts + 9 * 3600 * 1000);\n    k.setUTCHours(0, 0, 0, 0);\n    return k.getTime() - 9 * 3600 * 1000;\n}\nfunction startOfKstWeek(ts = Date.now()) {\n    const k = new Date(ts + 9 * 3600 * 1000);\n    const day = k.getUTCDay(); // 0=Sun\n    const diff = (day === 0 ? 6 : day - 1); // Mon=0 Í∏∞Ï§Ä\n    k.setUTCDate(k.getUTCDate() - diff);\n    k.setUTCHours(0, 0, 0, 0);\n    return k.getTime() - 9 * 3600 * 1000;\n}\n\nconst now = Date.now();\nconst dayStart = startOfKstDay(now);\nconst weekStart = startOfKstWeek(now);\n\n// ---- \"ÎÇ¥ ÏûëÏóÖ\"Îßå ÌïÑÌÑ∞\nconst myTasks = taskQueue.filter(t => (t.user_id === userId));\n\n// ---- ÏßÑÌñâÏ§ë ÏûëÏóÖ ÏÑ†Ï†ï Ïö∞ÏÑ†ÏàúÏúÑ\n// 1) agv1Ïù¥ Îì§Í≥† ÏûàÎäî task_id(ÎÇ¥ ÏûëÏóÖÏù¥Î©¥)\n// 2) ÎÇ¥ ÏûëÏóÖ Ï§ë running\n// 3) ÎÇ¥ ÏûëÏóÖ Ï§ë pending ÏµúÏã†\nlet active = null;\n\nif (r?.task_id) {\n    active = myTasks.find(t => t.task_id === r.task_id) || null;\n}\nif (!active) {\n    active = myTasks.find(t => t.status === \"running\") || null;\n}\nif (!active) {\n    const pendings = myTasks.filter(t => t.status === \"pending\");\n    pendings.sort((a, b) => (Number(b.created_at || 0) - Number(a.created_at || 0)));\n    active = pendings[0] || null;\n}\n\n// ---- ETA Í≥ÑÏÇ∞(Ï¥à)\nfunction etaRemainSec(task) {\n    if (!task) return null;\n\n    const expectedMs = Number(task.expected_duration_ms || 0) || expectedMsFor(task.type);\n    const startedAt = Number(task.started_at || 0);\n    const createdAt = Number(task.created_at || 0);\n\n    // runningÏù¥Î©¥ started_at Í∏∞Ï§ÄÏúºÎ°ú Í∞êÏÜå, ÏïÑÎãàÎ©¥ expectedÎßå ÌëúÏãú\n    if ((task.status === \"running\") && (startedAt > 0)) {\n        const elapsed = now - startedAt;\n        return Math.max(0, Math.ceil((expectedMs - elapsed) / 1000));\n    }\n\n    // ÏïÑÏßÅ running Ï†ÑÏù¥Î©¥ \"ÏòàÏÉÅÍ∞í\"Îßå\n    if (expectedMs > 0 && (createdAt > 0 || startedAt > 0)) {\n        return Math.max(0, Math.ceil(expectedMs / 1000));\n    }\n    return null;\n}\n\n// ---- ÏÉÅÌÉú ÎùºÎ≤®\nfunction robotStateLabel(robot) {\n    if (!robot) return \"ÏÉÅÌÉú ÏóÜÏùå\";\n    const s = String(robot.state || \"unknown\").toLowerCase();\n    if (robot.error_code) return \"Ïò§Î•ò ‚ùó\";\n    if (s === \"running\") return \"Ïù¥Îèô Ï§ë üöö\";\n    if (s === \"charging\") return \"Ï∂©Ï†Ñ Ï§ë üîå\";\n    if (s === \"idle\") return \"ÎåÄÍ∏∞ Ï§ë ‚úÖ\";\n    return s;\n}\n\nconst nowObj = {\n    state_label: robotStateLabel(r),\n    battery: r?.battery ?? null,\n    area_label: r?.area ? areaName(r.area) : null,\n    error_label: r?.error_code ?? null,\n    active: active ? {\n        type: active.type || null,\n        type_label: typeName(active.type),\n        target_area: active.target_area || null,\n        target_label: areaName(active.target_area),\n        status: active.status || null,\n        eta_remain_sec: etaRemainSec(active)\n    } : null\n};\n\n// ---- Ïò§Îäò/Ï£ºÍ∞Ñ ÏßëÍ≥Ñ\nfunction countRange(startMs) {\n    const c = { deliver_water: 0, collect_cup: 0, collect_laundry: 0 };\n    for (const t of myTasks) {\n        const ts = Number(t.created_at || 0);\n        if (!ts || ts < startMs) continue;\n        if (t.type && (t.type in c)) c[t.type]++;\n    }\n    return c;\n}\n\nconst todayCnt = countRange(dayStart);\nconst weekCnt = countRange(weekStart);\n\n// Î¨º ml ÌôòÏÇ∞(Î∞úÌëúÏö© Í∞ÄÏ†ïÏπò)\nconst PER_WATER_ML = 500;\nconst todayWater = todayCnt.deliver_water * PER_WATER_ML;\nconst weekWater = weekCnt.deliver_water * PER_WATER_ML;\n\nfunction topType(cnt) {\n    let best = null, bestV = -1;\n    for (const k of Object.keys(cnt)) {\n        if (cnt[k] > bestV) { bestV = cnt[k]; best = k; }\n    }\n    return bestV > 0 ? best : null;\n}\n\n// ---- ÏµúÍ∑º ÏöîÏ≤≠ 5Í∞ú\nconst recent = [...myTasks]\n    .sort((a, b) => Number(b.created_at || 0) - Number(a.created_at || 0))\n    .slice(0, 5)\n    .map(t => ({\n        ts: Number(t.created_at || 0),\n        type: t.type || null,\n        type_label: typeName(t.type),\n        target_area: t.target_area || null,\n        target_label: areaName(t.target_area),\n        status: t.status || \"unknown\"\n    }));\n\nmsg.statusCode = 200;\nmsg.headers = { \"Content-Type\": \"application/json\" };\nmsg.payload = {\n    user_id: userId,\n    now: nowObj,\n    today: { ...todayCnt, water_ml: todayWater },\n    week: { ...weekCnt, water_ml: weekWater, top: topType(weekCnt) },\n    recent,\n    updated_at: now\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 2040,
        "wires": [
            [
                "48b24095339e8f46"
            ]
        ]
    },
    {
        "id": "48b24095339e8f46",
        "type": "http response",
        "z": "49f8711fc297a8c1",
        "name": "res /api/user/summary",
        "statusCode": "",
        "headers": {},
        "x": 1000,
        "y": 2040,
        "wires": []
    },
    {
        "id": "fc7132a95c44fe84",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 7",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1620,
        "y": 1200,
        "wires": []
    },
    {
        "id": "ce111f86ccf22e93",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 8",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1300,
        "y": 1200,
        "wires": []
    },
    {
        "id": "4ec68c37f9405b30",
        "type": "http in",
        "z": "49f8711fc297a8c1",
        "name": "GET /api/user/brief",
        "url": "/api/user/brief",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 410,
        "y": 2120,
        "wires": [
            [
                "642ff654d947d271"
            ]
        ]
    },
    {
        "id": "a6d2592241f69718",
        "type": "http response",
        "z": "49f8711fc297a8c1",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1590,
        "y": 2120,
        "wires": []
    },
    {
        "id": "642ff654d947d271",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "BRIEF: build + firestore aggregate",
        "func": "// BRIEF: build + firestore aggregate\n// - Outputs: 2\n//   (1) OpenAI Ìò∏Ï∂úÎ°ú Î≥¥ÎÇº msg\n//   (2) Ï∫êÏãú ÌûàÌä∏ Ïãú Ï¶âÏãú HTTP ResponseÎ°ú Î≥¥ÎÇº msg\n\nconst db = global.get(\"db\");\nlet GMS_KEY =\n  global.get(\"GMS_KEY\") ||\n  global.get(\"OPENAI_API_KEY\") ||\n  global.get(\"OPENAI_KEY\") ||\n  ((typeof env !== \"undefined\" && env.get) ? env.get(\"GMS_KEY\") : null);\n\nif (typeof GMS_KEY === \"string\" && GMS_KEY.startsWith(\"Bearer \")) {\n  GMS_KEY = GMS_KEY.slice(\"Bearer \".length);\n}\n\n\nfunction toMs(v) {\n  if (!v) return 0;\n  if (typeof v === \"number\") return v;\n  if (typeof v === \"string\") {\n    const n = Number(v);\n    if (Number.isFinite(n)) return n;\n    const d = Date.parse(v);\n    return Number.isFinite(d) ? d : 0;\n  }\n  if (typeof v === \"object\") {\n    if (typeof v.toMillis === \"function\") return v.toMillis();       // Firestore Timestamp\n    if (typeof v.seconds === \"number\") return v.seconds * 1000;       // {seconds, nanoseconds}\n  }\n  return 0;\n}\n\nfunction startOfTodayMs() {\n  const d = new Date();\n  d.setHours(0, 0, 0, 0);\n  return d.getTime();\n}\n\nfunction startOfThisWeekMsMonday() {\n  // ÏõîÏöîÏùº 00:00 ÏãúÏûë(Î°úÏª¨)\n  const d = new Date();\n  const day = d.getDay(); // 0=Ïùº ... 1=Ïõî ... 6=ÌÜ†\n  const diffToMon = (day + 6) % 7; // Ïõî=0, Ìôî=1 ... Ïùº=6\n  d.setDate(d.getDate() - diffToMon);\n  d.setHours(0, 0, 0, 0);\n  return d.getTime();\n}\n\nfunction dayLabelMon0(idx) {\n  // chartLabelÍ≥º ÎßûÏ∂îÎäî ÎäêÎÇå(Ïõî~Ïùº)\n  const arr = [\"Ïõî\", \"Ìôî\", \"Ïàò\", \"Î™©\", \"Í∏à\", \"ÌÜ†\", \"Ïùº\"];\n  return arr[idx] || String(idx);\n}\n\nreturn (async () => {\n  if (!db) {\n    const out = {\n      statusCode: 500,\n      payload: { message: \"Firestore not initialized (global.db is missing)\" },\n    };\n    out.req = msg.req;\n    out.res = msg.res;\n    return [null, out];\n  }\n  if (!GMS_KEY) {\n    const out = {\n      statusCode: 503,\n      payload: { message: \"GMS_KEY is missing\" },\n    };\n    out.req = msg.req;\n    out.res = msg.res;\n    return [null, out];\n  }\n\n  const q = msg.req?.query || {};\n  const range = String(q.range || \"day\").toLowerCase() === \"week\" ? \"week\" : \"day\";\n  const refresh = String(q.refresh || \"0\") === \"1\";\n\n  // ----- ÏÑúÎ≤Ñ Ï∫êÏãú -----\n  const now = Date.now();\n  const ttlMs = range === \"week\" ? 60 * 60 * 1000 : 10 * 60 * 1000; // week=1h, day=10m\n  const cache = global.get(\"briefCache\") || {};\n  const hit = cache[range];\n\n  if (!refresh && hit?.brief && hit?.ts && (now - hit.ts) < ttlMs) {\n    const out = {\n      statusCode: 200,\n      headers: { \"Content-Type\": \"application/json\" },\n      payload: {\n        range,\n        cached: true,\n        generated_at: hit.ts,\n        brief: hit.brief,\n        stats: hit.stats || null,\n        ttl_ms: ttlMs,\n      },\n    };\n    out.req = msg.req;\n    out.res = msg.res;\n    return [null, out];\n  }\n\n  // ----- Í∏∞Í∞Ñ Í≥ÑÏÇ∞ -----\n  const sinceMs = (range === \"week\") ? startOfThisWeekMsMonday() : startOfTodayMs();\n  const rangeName = (range === \"week\") ? \"Ïù¥Î≤à Ï£º\" : \"Ïò§Îäò\";\n\n  // ----- FirestoreÏóêÏÑú ÏµúÍ∑º NÍ∞ú Í∞ÄÏ†∏ÏôÄÏÑú Í∏∞Í∞Ñ ÌïÑÌÑ∞ -----\n  // (Ïù∏Îç±Ïä§ ÏµúÏÜåÌôîÏö©: created_at desc limit)\n  let docs = [];\n  try {\n    const snap = await db.collection(\"tasks\")\n      .orderBy(\"created_at\", \"desc\")\n      .limit(600)\n      .get();\n    docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));\n  } catch (e) {\n    const out = {\n      statusCode: 500,\n      payload: { message: \"Firestore query failed\", error: String(e?.message || e) },\n    };\n    out.req = msg.req;\n    out.res = msg.res;\n    return [null, out];\n  }\n\n  const tasks = docs\n    .map(t => {\n      const created = toMs(t.created_at);\n      const started = toMs(t.started_at);\n      const finished = toMs(t.finished_at);\n\n      // duration Í≥ÑÏÇ∞(ÏóÜÏúºÎ©¥ 0)\n      let duration_s = 0;\n      if (started && finished && finished >= started) duration_s = Math.round((finished - started) / 1000);\n      else if (t.duration_s) duration_s = Number(t.duration_s) || 0;\n\n      return {\n        ...t,\n        _created_ms: created,\n        _duration_s: duration_s,\n        _status: String(t.status || \"\").toLowerCase(),\n        _type: String(t.type || \"\"),\n      };\n    })\n    .filter(t => t._created_ms >= sinceMs);\n\n  const total = tasks.length;\n  const doneTasks = tasks.filter(t => t._status === \"done\");\n  const done = doneTasks.length;\n\n  // ÌÉÄÏûÖÎ≥Ñ\n  const countByType = {};\n  for (const t of tasks) {\n    countByType[t._type] = (countByType[t._type] || 0) + 1;\n  }\n\n  // Î¨º/Ï†ïÎ¶¨ ÏßÄÌëú(ÎÑà ÌîÑÎ°úÏ†ùÌä∏ Í∏∞Ï§Ä)\n  const waterCount = countByType[\"deliver_water\"] || 0;\n  const laundryCount = countByType[\"collect_laundry\"] || 0;\n  const cupCount = countByType[\"collect_cup\"] || 0;\n\n  const waterCupMl = 250;\n  const waterMl = waterCount * waterCupMl;\n\n  // ÌèâÍ∑† ÏÜåÏöî\n  const durations = doneTasks.map(t => t._duration_s).filter(n => Number.isFinite(n) && n > 0);\n  const avgDurationS = durations.length ? Math.round(durations.reduce((a,b)=>a+b,0) / durations.length) : 0;\n\n  // Ìå®ÌÑ¥(ÌîºÌÅ¨)\n  let peakText = \"Îç∞Ïù¥ÌÑ∞Í∞Ä ÏïÑÏßÅ Ï†ÅÏñ¥ÏÑú Ìå®ÌÑ¥ÏùÑ Î≥¥Í∏∞ Ïñ¥Î†§ÏõåÏöî.\";\n  if (total > 0) {\n    if (range === \"day\") {\n      const buckets = Array(24).fill(0);\n      for (const t of tasks) {\n        const h = new Date(t._created_ms).getHours();\n        buckets[h]++;\n      }\n      const mx = Math.max(...buckets);\n      const idx = buckets.indexOf(mx);\n      if (mx > 0) peakText = `${idx}ÏãúÎåÄÏóê ÏöîÏ≤≠Ïù¥ Í∞ÄÏû• Î™∞Î†∏Ïñ¥Ïöî.`;\n    } else {\n      const buckets = Array(7).fill(0); // Ïõî=0~Ïùº=6\n      for (const t of tasks) {\n        const d = new Date(t._created_ms).getDay(); // 0=Ïùº..6=ÌÜ†\n        const mon0 = (d + 6) % 7;\n        buckets[mon0]++;\n      }\n      const mx = Math.max(...buckets);\n      const idx = buckets.indexOf(mx);\n      if (mx > 0) peakText = `${dayLabelMon0(idx)}ÏöîÏùºÏóê ÏöîÏ≤≠Ïù¥ Í∞ÄÏû• ÎßéÏïòÏñ¥Ïöî.`;\n    }\n  }\n\n  // ÏµúÍ∑º 3Í∞ú(Í∏∞Í∞Ñ ÎÇ¥)\n  const recent3 = tasks\n    .slice()\n    .sort((a,b) => b._created_ms - a._created_ms)\n    .slice(0, 3)\n    .map(t => ({\n      type: t._type,\n      status: t._status,\n      area: t.target_area || null,\n      created_at: t._created_ms,\n      duration_s: t._duration_s,\n    }));\n\n  const pct = total ? Math.round((done / total) * 100) : 0;\n\n  const stats = {\n    range,\n    since_ms: sinceMs,\n    total,\n    done,\n    done_pct: pct,\n    avg_duration_s: avgDurationS,\n    by_type: countByType,\n    water_count: waterCount,\n    water_ml: waterMl,\n    laundry_count: laundryCount,\n    cup_count: cupCount,\n    peak: peakText,\n    recent3,\n  };\n\n  // ----- LLM ÌîÑÎ°¨ÌîÑÌä∏(ÏÇ¨Ïö©Ïûê ÏπúÌôî + Í∞ÄÏπò Ï§ëÏã¨, Ïö¥ÏòÅÏûê ÌÜ§ Í∏àÏßÄ) -----\n  const prompt = `\nÎÑàÎäî ÏÇ¨Ïö©ÏûêÎ•º ÏúÑÌïú \"ÏßßÍ≥† Ïú†Ïö©Ìïú ÏÉùÌôú Î∏åÎ¶¨Ìïë\"ÏùÑ ÏûëÏÑ±ÌïúÎã§.\nÏö¥ÏòÅÏûê/Í¥ÄÎ¶¨Ïûê Í¥ÄÏ†ê(ÏöîÏ≤≠ Ï≤òÎ¶¨, ÏôÑÎ£å Î≥¥Í≥†ÏÑú ÌÜ§) Í∏àÏßÄ. ÏÇ¨Ïö©ÏûêÍ∞Ä ÏñªÎäî Í∞ÄÏπò(ÏäµÍ¥Ä/Ïª®ÎîîÏÖò/ÏÉùÌôú Î¶¨Îì¨)Î•º Ï§ëÏã¨ÏúºÎ°ú ÎßêÌï¥Îùº.\nÏùòÌïôÏ†Å Ï°∞Ïñ∏/ÏßÑÎã® Í∏àÏßÄ(Í∞ÄÎ≥çÍ≤å Í∂åÏû•Îßå).\n\n[Í∏∞Í∞Ñ] ${rangeName}\n[ÏßëÍ≥Ñ]\n- Ï¥ù ÏöîÏ≤≠: ${total}Í±¥, ÏôÑÎ£å: ${done}Í±¥(ÏôÑÎ£åÏú® ${pct}%)\n- ÌèâÍ∑† ÏÜåÏöî(ÏôÑÎ£åÍ±¥): ${avgDurationS}s\n- Î¨º Î∞∞Îã¨: ${waterCount}Ìöå (Ï∂îÏ†ï ÏÑ≠Ï∑® ${waterMl}ml, 1Ìöå=${waterCupMl}ml Í∞ÄÏ†ï)\n- ÌôòÍ≤Ω Ï†ïÎ¶¨(collect_laundry): ${laundryCount}Ìöå\n- Ïªµ ÏàòÍ±∞(collect_cup): ${cupCount}Ìöå\n- Ìå®ÌÑ¥: ${peakText}\n- ÏµúÍ∑º ÏöîÏ≤≠ 3Í∞ú: ${JSON.stringify(recent3)}\n\n[Ï∂úÎ†• ÌòïÏãù] ÏïÑÎûò 5Ï§ÑÏùÑ Ï†ïÌôïÌûà ÏßÄÏºúÎùº(Í∞Å Ï§ÑÏùÄ Ïù¥Î™®ÏßÄÎ°ú ÏãúÏûë)\nüßæ ÌïúÏ§ÑÏöîÏïΩ: ...\nüíß Î¨º/Ïª®ÎîîÏÖò: ...\nüßπ Ï†ïÎ¶¨/ÏÉùÌôú: ...\n‚è±Ô∏è Ìå®ÌÑ¥: ...\n‚úÖ Ïò§Îäò(ÎòêÎäî Ïù¥Î≤à Ï£º) Ï∂îÏ≤ú 1Í∞ÄÏßÄ: ...\n`.trim();\n\n  const body = {\n    model: \"gpt-4.1-nano\",\n    max_completion_tokens: 220,\n    messages: [\n      { role: \"developer\", content: \"Answer in Korean.\" },\n      { role: \"user\", content: prompt },\n    ],\n  };\n\n  msg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"Authorization\": `Bearer ${GMS_KEY}`,\n  };\n  msg.payload = JSON.stringify(body);\n\n  // parse ÎÖ∏ÎìúÏóêÏÑú Ï∫êÏãú Ï†ÄÏû•Ïö©ÏúºÎ°ú ÎÑòÍπÄ\n  msg._brief_meta = { range, ttlMs, stats };\n\n  return [msg, null];\n})().catch((e) => {\n  const out = {\n    statusCode: 500,\n    payload: { message: \"BRIEF build failed\", error: String(e?.message || e) },\n  };\n  out.req = msg.req;\n  out.res = msg.res;\n  return [null, out];\n});",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 2120,
        "wires": [
            [
                "5290db53cf0d5b80"
            ],
            [
                "a6d2592241f69718"
            ]
        ]
    },
    {
        "id": "5290db53cf0d5b80",
        "type": "http request",
        "z": "49f8711fc297a8c1",
        "name": "",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://gms.ssafy.io/gmsapi/api.openai.com/v1/chat/completions",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1050,
        "y": 2120,
        "wires": [
            [
                "0199749053698397",
                "e003202d2963564d"
            ]
        ]
    },
    {
        "id": "0199749053698397",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "BRIEF: parse + respond",
        "func": "// // BRIEF: parse + respond\n// // - OpenAI ÏùëÎãµ ÌååÏã±\n// // - ÏÑúÎ≤Ñ Ï∫êÏãú Ï†ÄÏû•(global.briefCache)\n// // - ÏµúÏ¢Ö HTTP Response payload ÏÉùÏÑ±\n\n// const meta = msg._brief_meta || {};\n// const range = meta.range || \"day\";\n// const ttlMs = meta.ttlMs || 0;\n// const stats = meta.stats || null;\n\n// function fallbackBrief() {\n//   const rangeName = range === \"week\" ? \"Ïù¥Î≤à Ï£º\" : \"Ïò§Îäò\";\n//   const total = stats?.total ?? 0;\n//   const done = stats?.done ?? 0;\n//   const pct = stats?.done_pct ?? 0;\n//   const waterMl = stats?.water_ml ?? 0;\n//   const waterCount = stats?.water_count ?? 0;\n//   const laundryCount = stats?.laundry_count ?? 0;\n//   const peak = stats?.peak || \"ÏïÑÏßÅ Ìå®ÌÑ¥ÏùÑ Î≥¥Í∏∞Ïóî Îç∞Ïù¥ÌÑ∞Í∞Ä Î∂ÄÏ°±Ìï¥Ïöî.\";\n\n//   return [\n//     `üßæ ÌïúÏ§ÑÏöîÏïΩ: ${rangeName}Ïóî ${total}Î≤à ÎèÑÏõÄÏùÑ ÏöîÏ≤≠ÌñàÍ≥†, ${done}Î≤à Ï≤òÎ¶¨ÎêêÏñ¥Ïöî(ÏôÑÎ£åÏú® ${pct}%).`,\n//     `üíß Î¨º/Ïª®ÎîîÏÖò: Î¨º Î∞∞Îã¨ ${waterCount}Ìöå ‚Üí ÎåÄÎûµ ${waterMl}ml ÎßàÏã† ÏÖàÏù¥ÏóêÏöî.`,\n//     `üßπ Ï†ïÎ¶¨/ÏÉùÌôú: ÌôòÍ≤Ω Ï†ïÎ¶¨ ${laundryCount}ÌöåÎ°ú ÏÉùÌôú Í≥µÍ∞ÑÏùÑ Ïûò Ïú†ÏßÄÌñàÏñ¥Ïöî.`,\n//     `‚è±Ô∏è Ìå®ÌÑ¥: ${peak}`,\n//     `‚úÖ ${rangeName} Ï∂îÏ≤ú 1Í∞ÄÏßÄ: Î¨º Ìïú Î≤à Îçî Ï±ôÍ∏∞Í±∞ÎÇò, ÏûêÏ£º Ïì∞Îäî Íµ¨Ïó≠ Ï†ïÎ¶¨Î•º Î£®Ìã¥ÏúºÎ°ú Í≥†Ï†ïÌï¥Î¥êÏöî.`,\n//   ].join(\"\\n\");\n// }\n\n// let brief = \"\";\n// try {\n//   const data = (typeof msg.payload === \"string\") ? JSON.parse(msg.payload) : msg.payload;\n//   brief = String(data?.choices?.[0]?.message?.content || \"\").trim();\n// } catch {\n//   brief = \"\";\n// }\n\n// if (!brief) brief = fallbackBrief();\n\n// // ---- ÏÑúÎ≤Ñ Ï∫êÏãú Ï†ÄÏû• ----\n// try {\n//   const cache = global.get(\"briefCache\") || {};\n//   cache[range] = { ts: Date.now(), brief, stats };\n//   global.set(\"briefCache\", cache);\n// } catch {}\n\n// // ---- response ----\n// msg.statusCode = 200;\n// msg.headers = { \"Content-Type\": \"application/json\" };\n// msg.payload = {\n//   range,\n//   cached: false,\n//   generated_at: Date.now(),\n//   ttl_ms: ttlMs,\n//   brief,\n//   stats,\n// };\n\n// return msg;\n// BRIEF: parse + respond\n// - OpenAI ÏùëÎãµ ÌååÏã±\n// - ÏÑúÎ≤Ñ Ï∫êÏãú Ï†ÄÏû•(global.briefCache)\n// - ÏµúÏ¢Ö HTTP Response payload ÏÉùÏÑ±\n\nconst meta = msg._brief_meta || {};\nconst range = meta.range || \"day\";\nconst ttlMs = meta.ttlMs || 0;\nconst stats = meta.stats || null;\n\nfunction fallbackBrief() {\n  const rangeName = range === \"week\" ? \"Ïù¥Î≤à Ï£º\" : \"Ïò§Îäò\";\n  const total = stats?.total ?? 0;\n  const done = stats?.done ?? 0;\n  const pct = stats?.done_pct ?? 0;\n  const waterMl = stats?.water_ml ?? 0;\n  const waterCount = stats?.water_count ?? 0;\n  const laundryCount = stats?.laundry_count ?? 0;\n  const peak = stats?.peak || \"ÏïÑÏßÅ Ìå®ÌÑ¥ÏùÑ Î≥¥Í∏∞Ïóî Îç∞Ïù¥ÌÑ∞Í∞Ä Î∂ÄÏ°±Ìï¥Ïöî.\";\n\n  return [\n    `üßæ ÌïúÏ§ÑÏöîÏïΩ: ${rangeName}Ïóî ${total}Î≤à ÎèÑÏõÄÏùÑ ÏöîÏ≤≠ÌñàÍ≥†, ${done}Î≤à Ï≤òÎ¶¨ÎêêÏñ¥Ïöî(ÏôÑÎ£åÏú® ${pct}%).`,\n    `üíß Î¨º/Ïª®ÎîîÏÖò: Î¨º Î∞∞Îã¨ ${waterCount}Ìöå ‚Üí ÎåÄÎûµ ${waterMl}ml ÎßàÏã† ÏÖàÏù¥ÏóêÏöî.`,\n    `üßπ Ï†ïÎ¶¨/ÏÉùÌôú: ÌôòÍ≤Ω Ï†ïÎ¶¨ ${laundryCount}ÌöåÎ°ú ÏÉùÌôú Í≥µÍ∞ÑÏùÑ Ïûò Ïú†ÏßÄÌñàÏñ¥Ïöî.`,\n    `‚è±Ô∏è Ìå®ÌÑ¥: ${peak}`,\n    `‚úÖ ${rangeName} Ï∂îÏ≤ú 1Í∞ÄÏßÄ: Î¨º Ìïú Î≤à Îçî Ï±ôÍ∏∞Í±∞ÎÇò, ÏûêÏ£º Ïì∞Îäî Íµ¨Ïó≠ Ï†ïÎ¶¨Î•º Î£®Ìã¥ÏúºÎ°ú Í≥†Ï†ïÌï¥Î¥êÏöî.`,\n  ].join(\"\\n\");\n}\n\n// ‚úÖ Ïó¨Í∏∞ Ï∂îÍ∞Ä: Ïù¥Î™®ÏßÄ(üßæüíßüßπ‚è±Ô∏è‚úÖ)Í∞Ä ÎÇòÏò§Î©¥ Î¨¥Ï°∞Í±¥ \"Ï§Ñ ÏãúÏûë\"ÏúºÎ°ú Ï†ïÎ†¨\nfunction normalizeBrief(raw) {\n  if (!raw) return \"\";\n\n  let s = String(raw)\n    .replace(/\\r\\n/g, \"\\n\")\n    .replace(/\\r/g, \"\\n\")\n    .trim();\n\n  // Ïù¥Î™®ÏßÄ ÎßàÏª§(‚è±Ô∏èÎäî Î≥ÄÌòï(‚è±)ÎèÑ Ïû°ÏïÑÏ§å)\n  // ÎßàÏª§ ÏïûÏóê Î¨¥Ï°∞Í±¥ Í∞úÌñâÏùÑ ÎÑ£Í≥†, Ï§ëÎ≥µ Í∞úÌñâÏùÄ ÌïòÎÇòÎ°ú Ï†ïÎ¶¨\n  s = s.replace(/(üßæ|üíß|üßπ|‚è±Ô∏è|‚è±|‚úÖ)/g, \"\\n$1\");\n\n  // ÏïûÏ™Ω Î∂àÌïÑÏöî Í∞úÌñâ Ï†úÍ±∞ + Í≥µÎ∞± Ï†ïÎ¶¨\n  s = s.replace(/^\\n+/, \"\");\n  s = s.replace(/\\n[ \\t]+/g, \"\\n\");\n  s = s.replace(/[ \\t]+\\n/g, \"\\n\");\n\n  // Í∞úÌñâÏù¥ Ïó¨Îü¨ Í∞ú ÏÉùÍ∏∞Î©¥ 1Í∞úÎ°ú\n  s = s.replace(/\\n{2,}/g, \"\\n\").trim();\n\n  return s;\n}\n\nlet brief = \"\";\ntry {\n  const data = (typeof msg.payload === \"string\") ? JSON.parse(msg.payload) : msg.payload;\n  brief = String(data?.choices?.[0]?.message?.content || \"\").trim();\n} catch {\n  brief = \"\";\n}\n\nif (!brief) brief = fallbackBrief();\n\n// ‚úÖ Í∞ïÏ†ú Ï†ïÎ†¨\nbrief = normalizeBrief(brief);\n\n// ---- ÏÑúÎ≤Ñ Ï∫êÏãú Ï†ÄÏû• ----\ntry {\n  const cache = global.get(\"briefCache\") || {};\n  cache[range] = { ts: Date.now(), brief, stats };\n  global.set(\"briefCache\", cache);\n} catch {}\n\n// ---- response ----\nmsg.statusCode = 200;\nmsg.headers = { \"Content-Type\": \"application/json\" };\nmsg.payload = {\n  range,\n  cached: false,\n  generated_at: Date.now(),\n  ttl_ms: ttlMs,\n  brief,\n  stats,\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 2120,
        "wires": [
            [
                "a6d2592241f69718"
            ]
        ]
    },
    {
        "id": "e003202d2963564d",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 9",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1200,
        "y": 2180,
        "wires": []
    },
    {
        "id": "196ad6fd54f9c6b6",
        "type": "http in",
        "z": "49f8711fc297a8c1",
        "name": "GET /api/app/settings",
        "url": "/api/app/settings",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 420,
        "y": 2300,
        "wires": [
            [
                "9e4d823bea057f41"
            ]
        ]
    },
    {
        "id": "9e4d823bea057f41",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "GET /api/app/settings function",
        "func": "// // GET /api/app/settings\n// // Firestore Ï†ÑÏó≠ ÏÑ§Ï†ï Î¨∏ÏÑúÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞\n\n// const db =\n//   global.get(\"db\") ||\n//   global.get(\"firestore\") ||\n//   global.get(\"fsdb\");\n\n// if (!db) {\n//   msg.statusCode = 500;\n//   msg.payload = { ok: false, error: \"Firestore db not found in global context\" };\n//   return msg;\n// }\n\n// return (async () => {\n//   const ref = db.collection(\"app_config\").doc(\"global\"); // ‚úÖ Ï†ÑÏó≠ 1Î¨∏ÏÑú\n//   const snap = await ref.get();\n\n//   msg.statusCode = 200;\n//   global.set(\"appSettings\", settings);\n//   msg.payload = { ok: true, settings: snap.exists ? snap.data() : null };\n//   return msg;\n// })().catch((e) => {\n//   msg.statusCode = 500;\n//   msg.payload = { ok: false, error: String(e) };\n//   return msg;\n// });\n\n// GET /api/app/settings function\nconst db = global.get(\"db\") || global.get(\"firestore\") || global.get(\"fsdb\");\nif (!db) {\n  msg.statusCode = 503;\n  msg.payload = { ok: false, error: \"Firestore not ready\" };\n  return msg;\n}\n\nreturn (async () => {\n  const snap = await db.collection(\"app_config\").doc(\"global\").get();\n  const data = snap.exists ? (snap.data() || {}) : null;\n\n  // ‚úÖ Ï†ÑÏó≠ Ï∫êÏãú (undefined Î≥ÄÏàò Ïì∞ÏßÄ Îßê Í≤É)\n  global.set(\"appSettings\", data || null);\n\n  msg.statusCode = 200;\n  msg.payload = { ok: true, settings: data || null };\n  return msg;\n})().catch((err) => {\n  node.error(err);\n  msg.statusCode = 500;\n  msg.payload = { ok: false, error: String(err?.message || err) };\n  return msg;\n});\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 2300,
        "wires": [
            [
                "92e58e87bb22bc94"
            ]
        ]
    },
    {
        "id": "92e58e87bb22bc94",
        "type": "http response",
        "z": "49f8711fc297a8c1",
        "name": "res /api/app/settings",
        "statusCode": "",
        "headers": {},
        "x": 1000,
        "y": 2300,
        "wires": []
    },
    {
        "id": "cd4ac22d736413b0",
        "type": "http in",
        "z": "49f8711fc297a8c1",
        "name": "POST /api/app/settings",
        "url": "/api/app/settings",
        "method": "post",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 420,
        "y": 2400,
        "wires": [
            [
                "3afe60812ab7ff80"
            ]
        ]
    },
    {
        "id": "3afe60812ab7ff80",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "POST /api/app/settings function",
        "func": "// // POST /api/app/settings\n// // body: { settings: {...} }\n\n// const db =\n//   global.get(\"db\") ||\n//   global.get(\"firestore\") ||\n//   global.get(\"fsdb\");\n\n// if (!db) {\n//   msg.statusCode = 500;\n//   msg.payload = { ok: false, error: \"Firestore db not found in global context\" };\n//   return msg;\n// }\n\n// const settings = msg.payload?.settings;\n// if (!settings || typeof settings !== \"object\") {\n//   msg.statusCode = 400;\n//   msg.payload = { ok: false, error: \"settings object required\" };\n//   return msg;\n// }\n\n// // ‚úÖ ÌôîÏù¥Ìä∏Î¶¨Ïä§Ìä∏Î°ú ÏïàÏ†ÑÌïòÍ≤å Ï†ÄÏû•(ÏõêÌïòÎäî Í≤ÉÎßå)\n// const clean = {\n//   user_place: String(settings.user_place || \"RES_A\"),\n//   water_goal_ml: Number(settings.water_goal_ml || 0) || 0,\n//   routines: Array.isArray(settings.routines) ? settings.routines : [],\n//   updated_at: Date.now(),\n// };\n\n// return (async () => {\n//   await db.collection(\"app_config\").doc(\"global\").set(clean, { merge: true });\n//   global.set(\"appSettings\", setData);\n//   msg.statusCode = 200;\n//   msg.payload = { ok: true };\n//   return msg;\n// })().catch((e) => {\n//   msg.statusCode = 500;\n//   msg.payload = { ok: false, error: String(e) };\n//   return msg;\n// });\n\n\n// POST /api/app/settings function\nconst db = global.get(\"db\") || global.get(\"firestore\") || global.get(\"fsdb\");\nif (!db) {\n  msg.statusCode = 503;\n  msg.payload = { ok: false, error: \"Firestore not ready\" };\n  return msg;\n}\n\n// body ÌååÏã± (string/json Î™®Îëê ÎåÄÏùë)\nlet body = msg.payload;\nif (typeof body === \"string\") {\n  try { body = JSON.parse(body); } catch (e) { }\n}\n\nconst settingsIn = body?.settings;\nif (!settingsIn || typeof settingsIn !== \"object\") {\n  msg.statusCode = 400;\n  msg.payload = { ok: false, error: \"Invalid body: { settings: {...} } required\" };\n  return msg;\n}\n\n// Î£®Ìã¥ sanitize\nfunction normTimeHHMM(t) {\n  if (!t) return \"00:00\";\n  const s = String(t).trim();\n  // \"HH:MM\"\n  if (/^\\d{2}:\\d{2}$/.test(s)) return s;\n  // \"H:MM\" -> \"0H:MM\"\n  if (/^\\d{1}:\\d{2}$/.test(s)) return \"0\" + s;\n  // \"HHMM\"\n  if (/^\\d{4}$/.test(s)) return s.slice(0, 2) + \":\" + s.slice(2);\n  return s.slice(0, 5);\n}\n\nfunction cleanRoutine(r) {\n  const rr = r && typeof r === \"object\" ? r : {};\n  return {\n    id: String(rr.id || `rt_${Date.now()}`),\n    enabled: rr.enabled !== false,\n    time: normTimeHHMM(rr.time),\n    repeat: rr.repeat === \"weekly\" ? \"weekly\" : \"daily\",\n    days: Array.isArray(rr.days) ? rr.days : [],\n    action_type: String(rr.action_type || rr.type || \"deliver_water\"),\n    target_mode: rr.target_mode === \"custom\" ? \"custom\" : \"my\",\n    target_area: String(rr.target_area || rr.area || \"\"),\n    created_at: Number(rr.created_at || Date.now()),\n  };\n}\n\nconst clean = {\n  // ÌïÑÏöîÌïú Í≤ÉÎì§Îßå ÌôïÏã§Ìûà Î≥¥Ï°¥\n  user_place: String(settingsIn.user_place || \"RES_A\"),\n  water_goal_ml: Number(settingsIn.water_goal_ml || 0) || 0,\n  routines: Array.isArray(settingsIn.routines) ? settingsIn.routines.map(cleanRoutine) : [],\n  updated_at: Date.now(),\n};\n\nreturn (async () => {\n  await db.collection(\"app_config\").doc(\"global\").set(clean, { merge: true });\n\n  // ‚úÖ Ï†ÑÏó≠ Ï∫êÏãú ÏóÖÎç∞Ïù¥Ìä∏ (undefined setData Í∏àÏßÄ)\n  global.set(\"appSettings\", clean);\n\n  msg.statusCode = 200;\n  msg.payload = { ok: true };\n  return msg;\n})().catch((err) => {\n  node.error(err);\n  msg.statusCode = 500;\n  msg.payload = { ok: false, error: String(err?.message || err) };\n  return msg;\n});\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 2400,
        "wires": [
            [
                "a4f359686768196d"
            ]
        ]
    },
    {
        "id": "a4f359686768196d",
        "type": "http response",
        "z": "49f8711fc297a8c1",
        "name": "res /api/app/settings",
        "statusCode": "",
        "headers": {},
        "x": 1000,
        "y": 2400,
        "wires": []
    },
    {
        "id": "6f9693cf9fc68603",
        "type": "inject",
        "z": "49f8711fc297a8c1",
        "name": "TICK (Routine Scheduler)",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "5",
        "crontab": "",
        "once": true,
        "onceDelay": "5",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 440,
        "y": 2560,
        "wires": [
            [
                "8808fa070f001f8e"
            ]
        ]
    },
    {
        "id": "8808fa070f001f8e",
        "type": "function",
        "z": "49f8711fc297a8c1",
        "name": "Routine Scheduler -> create msg.task",
        "func": "// /**\n//  * Routine Scheduler -> create msg.task\n//  * Fixes:\n//  * 1. KST Timezone Ï†ÅÏö© (UTC+9)\n//  * 2. global.taskQueueÏóê push (Ïã§Ï†ú Ïã§ÌñâÏùÑ ÏúÑÌï¥)\n//  * 3. node.send() Î∞©Ïãù ÏÇ¨Ïö© (ÏïàÏ†ïÏÑ±)\n//  */\n\n// function pad2(n) { return String(n).padStart(2, \"0\"); }\n\n// // KST Í∏∞Ï§Ä ÌòÑÏû¨ ÏãúÍ∞Ñ Í∞ùÏ≤¥ Î∞òÌôò\n// function getKSTDate() {\n//   const now = new Date();\n//   const utc = now.getTime() + (now.getTimezoneOffset() * 60000);\n//   const kstGap = 9 * 60 * 60 * 1000;\n//   return new Date(utc + kstGap);\n// }\n\n// function pickTimeStr(r) {\n//   const t = r.time ?? r.hhmm ?? r.at ?? r.run_at ?? r.when;\n//   if (!t) return null;\n//   if (typeof t === \"string\") {\n//     const s = t.trim();\n//     if (/^\\d{2}:\\d{2}$/.test(s)) return s;\n//     if (/^\\d{4}$/.test(s)) return s.slice(0, 2) + \":\" + s.slice(2, 4);\n//     return null;\n//   }\n//   if (typeof t === \"object\") {\n//     const hh = t.hh ?? t.hour;\n//     const mm = t.mm ?? t.minute;\n//     if (hh == null || mm == null) return null;\n//     return pad2(hh) + \":\" + pad2(mm);\n//   }\n//   return null;\n// }\n\n// function getIsoDow(jsDow) { return jsDow === 0 ? 7 : jsDow; } // Sun=0->7\n\n// function normalizeDays(days) {\n//   if (!Array.isArray(days) || days.length === 0) return null;\n//   const out = [];\n//   for (const d of days) {\n//     if (typeof d === \"number\" && Number.isFinite(d)) out.push(d);\n//     else if (typeof d === \"string\") {\n//       const s = d.trim().toLowerCase();\n//       const map = { sun: 0, mon: 1, tue: 2, wed: 3, thu: 4, fri: 5, sat: 6 };\n//       if (s in map) out.push(map[s]);\n//       else if (/^\\d+$/.test(s)) out.push(Number(s));\n//     }\n//   }\n//   return out.length ? out : null;\n// }\n\n// function matchDow(r, kstDate) {\n//   const jsDow = kstDate.getDay();      // 0(Sun)..6(Sat) (KST Í∏∞Ï§Ä)\n//   const isoDow = getIsoDow(jsDow);     // 1(Mon)..7(Sun)\n\n//   const daysRaw = r.days ?? r.dow ?? r.daysOfWeek ?? r.weekdays;\n//   const days = normalizeDays(daysRaw);\n//   if (!days) return true; // ÏöîÏùº ÏÑ§Ï†ï ÏóÜÏúºÎ©¥ Îß§Ïùº\n\n//   const has0 = days.includes(0);\n//   const has7 = days.includes(7);\n//   const looksIso = !has0 && (has7 || days.some(x => x >= 1 && x <= 7));\n\n//   if (looksIso) return days.includes(isoDow);\n//   return days.includes(jsDow);\n// }\n\n// function sanitizeId(s) {\n//   return String(s ?? \"\").trim().replace(/[^a-zA-Z0-9_-]/g, \"_\").slice(0, 60);\n// }\n\n// // ÏòàÏÉÅ ÏÜåÏöîÏãúÍ∞Ñ Í∏∞Î≥∏Í∞í\n// const baseMsMap = {\n//   water: 20000, drop: 15000, charge: 25000, wash: 20000, cancel: 3000, unknown: 20000\n// };\n\n// // Î©îÏù∏ Î°úÏßÅ ÏãúÏûë\n// (async () => {\n//   const db = global.get(\"db\") || global.get(\"fs\") || global.get(\"firestore\");\n//   if (!db) {\n//     node.status({ fill: \"red\", shape: \"ring\", text: \"Firestore not ready\" });\n//     // DB ÏóÜÏúºÎ©¥ Ï¢ÖÎ£å\n//     return;\n//   }\n\n//   // 1) routines Í∞ÄÏ†∏Ïò§Í∏∞ (global cache Ïö∞ÏÑ†)\n//   let settings = global.get(\"appSettings\");\n//   if (!settings) {\n//     try {\n//       const doc = await db.collection(\"app_config\").doc(\"global\").get();\n//       settings = doc.exists ? (doc.data() || {}) : {};\n//     } catch (e) {\n//       node.status({ fill: \"red\", shape: \"ring\", text: \"Read config failed\" });\n//       node.error(e);\n//       return;\n//     }\n//   }\n\n//   const routines = Array.isArray(settings.routines) ? settings.routines : [];\n//   if (!routines.length) {\n//     node.status({ fill: \"grey\", shape: \"ring\", text: \"No routines\" });\n//     return;\n//   }\n\n//   // 2) KST ÏãúÍ∞Ñ Í≥ÑÏÇ∞ (UTC+9)\n//   const nowKST = getKSTDate();\n//   const hhmm = pad2(nowKST.getHours()) + \":\" + pad2(nowKST.getMinutes());\n//   const ymd = String(nowKST.getFullYear()) + pad2(nowKST.getMonth() + 1) + pad2(nowKST.getDate());\n//   const keyMinute = `${ymd}_${hhmm.replace(\":\", \"\")}`; // YYYYMMDD_HHMM\n\n//   let lastFired = context.get(\"lastFired\") || {};\n\n//   // Í∏ÄÎ°úÎ≤å ÌÅê Í∞ÄÏ†∏Ïò§Í∏∞ (Ï§ëÏöî!)\n//   let queue = global.get('taskQueue') || [];\n//   let isQueueChanged = false;\n\n//   const outCreate = [];\n//   const outDbg = [];\n\n//   // ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞ (function2ÏôÄ ÎèôÏùº Î°úÏßÅ)\n//   const taskStats = global.get(\"taskStats\") || {};\n\n//   for (let i = 0; i < routines.length; i++) {\n//     const r = routines[i] || {};\n//     const enabled = (r.enabled ?? r.on ?? r.use ?? true) !== false;\n//     if (!enabled) continue;\n\n//     const t = pickTimeStr(r);\n//     if (!t || t !== hhmm) continue;     // ÏãúÍ∞Ñ Ï≤¥ÌÅ¨ (KST Í∏∞Ï§Ä)\n//     if (!matchDow(r, nowKST)) continue; // ÏöîÏùº Ï≤¥ÌÅ¨ (KST Í∏∞Ï§Ä)\n\n//     const routineId = sanitizeId(r.id ?? r.routine_id ?? r.name ?? `idx${i}`);\n//     if (!routineId) continue;\n\n//     // Ï§ëÎ≥µ Ïã§Ìñâ Î∞©ÏßÄ\n//     if (lastFired[routineId] === keyMinute) continue;\n//     lastFired[routineId] = keyMinute;\n\n//     // Task ÏÉùÏÑ±\n//     const typeRaw = (r.type ?? r.task_type ?? r.kind ?? \"water\");\n//     const type = String(typeRaw).trim().toLowerCase();\n//     const targetArea = String(r.target_area ?? r.area ?? r.target ?? \"WATER\").trim().toUpperCase();\n//     const priority = Number.isFinite(Number(r.priority)) ? Number(r.priority) : 50;\n\n//     const taskId = `task_rt_${routineId}_${keyMinute}`;\n//     const nowMs = Date.now(); // ÏÉùÏÑ± ÏãúÍ∞ÑÏùÄ timestamp(UTC) Í∑∏ÎåÄÎ°ú Ïç®ÎèÑ Îê® (ÌëúÏ§Ä)\n\n//     // ÏòàÏÉÅ ÏãúÍ∞Ñ Í≥ÑÏÇ∞ (EMA)\n//     const stat = taskStats[type];\n//     const expectedMs = (stat && stat.ema_ms) ? Math.round(stat.ema_ms) : (baseMsMap[type] || 20000);\n\n//     const task = {\n//       task_id: taskId,\n//       type,\n//       user_id: r.user_id ?? \"public\",\n//       status: \"pending\",\n//       created_at: nowMs,\n//       scheduled_at: nowMs,\n//       target_area: targetArea,\n//       priority,\n//       expected_duration_ms: expectedMs,\n//       eta_basis: (stat && stat.ema_ms) ? \"ema\" : \"default\",\n//       source: \"routine\",\n//       routine_id: routineId,\n//       params: r.params ?? {},\n//       interaction_id: null // Î£®Ìã¥ÏùÄ Ïù∏ÌÑ∞ÎûôÏÖò ÏóÜÏùå\n//     };\n\n//     // 1. OutputÏö© Î©îÏãúÏßÄ Ï§ÄÎπÑ\n//     outCreate.push({ task: task, payload: task });\n//     outDbg.push({ payload: { ok: true, created: true, hhmm, routineId, taskId } });\n\n//     // 2. Global QueueÏóê Ï∂îÍ∞Ä (Ï§ëÏöî!)\n//     queue.push(task);\n//     isQueueChanged = true;\n//   }\n\n//   // ÏÉÅÌÉú Ï†ÄÏû•\n//   context.set(\"lastFired\", lastFired);\n//   if (isQueueChanged) {\n//     global.set('taskQueue', queue);\n//     // ÌïÑÏöîÌïòÎã§Î©¥ Ïó¨Í∏∞ÏÑú ÌÅê ÏóÖÎç∞Ïù¥Ìä∏ Ïù¥Î≤§Ìä∏ Ìä∏Î¶¨Í±∞ Í∞ÄÎä•\n//   }\n\n//   if (!outCreate.length) {\n//     node.status({ fill: \"blue\", shape: \"dot\", text: `tick ${hhmm}` });\n//     return;\n//   }\n\n//   node.status({ fill: \"green\", shape: \"dot\", text: `created ${outCreate.length} @ ${hhmm}` });\n\n//   // Î™ÖÏãúÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°\n//   node.send([outCreate, outDbg]);\n\n// })().catch(err => {\n//   node.error(err);\n//   node.status({ fill: \"red\", shape: \"dot\", text: \"Error\" });\n// });\n\n// Routine Scheduler -> create msg.task\n// output1: tasks to create (msg.task Ìè¨Ìï®)\n// output2: debug\n\nconst db = global.get(\"db\");\nif (!db) {\n  node.warn(\"Firestore not ready in Routine Scheduler\");\n  return [null, [{ payload: { ok: false, error: \"Firestore not ready\" } }]];\n}\n\n// ---- KST Í∏∞Ï§Ä ÏãúÍ∞Ñ(ÏÑúÎ≤Ñ TZ ÏÉÅÍ¥ÄÏóÜÏù¥) ----\nfunction pad2(n) { return String(n).padStart(2, \"0\"); }\nfunction nowKST() {\n  const k = new Date(Date.now() + 9 * 60 * 60 * 1000);\n  return {\n    y: k.getUTCFullYear(),\n    mo: k.getUTCMonth() + 1,\n    d: k.getUTCDate(),\n    hh: k.getUTCHours(),\n    mm: k.getUTCMinutes(),\n    isoDow: (() => { // 1=Mon ... 7=Sun\n      const js = k.getUTCDay(); // 0=Sun..6=Sat\n      return js === 0 ? 7 : js;\n    })(),\n  };\n}\n\nfunction normTimeHHMM(t) {\n  if (!t) return null;\n  const s = String(t).trim();\n  if (/^\\d{2}:\\d{2}$/.test(s)) return s;\n  if (/^\\d{1}:\\d{2}$/.test(s)) return \"0\" + s;\n  if (/^\\d{4}$/.test(s)) return s.slice(0, 2) + \":\" + s.slice(2);\n  return null;\n}\n\n// UserAppÏùò daysÎäî \"Ïõî=0..Ïùº=6\" (mon0) ÌòïÌÉúÎ°ú Îì§Ïñ¥Ïò¨ Ïàò ÏûàÏùå :contentReference[oaicite:6]{index=6}\n// ‚Üí Ïä§ÏºÄÏ§ÑÎü¨Îäî ISO(1..7)Î°ú Î∞îÍøîÏÑú ÎπÑÍµê\nfunction daysToIso(daysRaw) {\n  if (!Array.isArray(daysRaw) || daysRaw.length === 0) return null;\n\n  const mapStr = { mon: 1, tue: 2, wed: 3, thu: 4, fri: 5, sat: 6, sun: 7 };\n  const nums = [];\n\n  for (const x of daysRaw) {\n    if (typeof x === \"string\") {\n      const k = x.trim().toLowerCase();\n      if (mapStr[k]) nums.push(mapStr[k]);\n      continue;\n    }\n    if (Number.isFinite(x)) nums.push(Math.trunc(x));\n  }\n\n  if (nums.length === 0) return null;\n\n  // Ïù¥ÎØ∏ ISO(1..7)\n  if (nums.every(v => v >= 1 && v <= 7)) return Array.from(new Set(nums));\n\n  // mon0(0..6, Mon=0..Sun=6) ‚Üí ISO\n  if (nums.every(v => v >= 0 && v <= 6)) {\n    return Array.from(new Set(nums.map(v => (v === 6 ? 7 : v + 1))));\n  }\n\n  return null;\n}\n\nfunction normalizeType(raw) {\n  const s = String(raw || \"\").trim().toLowerCase();\n  if (!s) return \"deliver_water\";\n  const alias = {\n    water: \"deliver_water\",\n    cup: \"collect_cup\",\n    laundry: \"collect_laundry\",\n    charge: \"go_charge\",\n  };\n  return alias[s] || s;\n}\n\nfunction priorityOf(type) {\n  const p = {\n    deliver_water: 1,\n    collect_cup: 2,\n    collect_laundry: 3,\n    go_charge: 10,\n    cancel: 0,\n  };\n  return p[type] ?? 99;\n}\n\nconst k = nowKST();\nconst hhmmNow = `${pad2(k.hh)}:${pad2(k.mm)}`;\nconst keyMinute = `${k.y}${pad2(k.mo)}${pad2(k.d)}_${pad2(k.hh)}${pad2(k.mm)}`;\n\n// lastFired(Î∂Ñ Îã®ÏúÑ Ï§ëÎ≥µ Î∞©ÏßÄ)\nlet lastFired = context.get(\"lastFired\") || {};\n// ÎÑàÎ¨¥ Ïª§ÏßÄÏßÄ ÏïäÍ≤å Ï†ïÎ¶¨\nconst keys = Object.keys(lastFired);\nif (keys.length > 5000) lastFired = {};\n\nlet outCreate = [];\nlet outDebug = [];\n\nreturn (async () => {\n  // settings: global cache Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ Firestore\n  let settings = global.get(\"appSettings\");\n  if (!settings || typeof settings !== \"object\") {\n    const snap = await db.collection(\"app_config\").doc(\"global\").get();\n    settings = snap.exists ? (snap.data() || {}) : {};\n    global.set(\"appSettings\", settings);\n  }\n\n  const routines = Array.isArray(settings.routines) ? settings.routines : [];\n  if (routines.length === 0) return [null, null];\n\n  for (const r of routines) {\n    if (!r || r.enabled === false) continue;\n\n    const runAt = normTimeHHMM(r.time);\n    if (!runAt) continue;\n    if (runAt !== hhmmNow) continue;\n\n    // repeat/day Ï≤¥ÌÅ¨\n    const repeat = (r.repeat === \"weekly\") ? \"weekly\" : \"daily\";\n    if (repeat === \"weekly\") {\n      const isoDays = daysToIso(r.days);\n      if (isoDays && !isoDays.includes(k.isoDow)) continue;\n    }\n\n    const routineId = String(r.id || \"noid\");\n    const firedKey = `${routineId}:${keyMinute}`;\n    if (lastFired[firedKey]) continue;\n    lastFired[firedKey] = Date.now();\n\n    // ‚úÖ action_type Ïö∞ÏÑ† ÏÇ¨Ïö© (UserAppÏù¥ Ïù¥ ÌïÑÎìúÎ°ú Ï†ÄÏû•Ìï®) :contentReference[oaicite:7]{index=7}\n    const type = normalizeType(r.action_type ?? r.type ?? r.task_type ?? r.kind ?? \"deliver_water\");\n\n    const targetArea =\n      String(\n        r.target_area ||\n        r.area ||\n        (r.target_mode === \"my\" ? settings.user_place : \"\") ||\n        settings.user_place ||\n        \"USER1\"\n      ).trim();\n\n    const task = {\n      task_id: `task_rt_${routineId}_${keyMinute}`,\n      source: \"routine\",\n      routine_id: routineId,\n      type,\n      target_area: targetArea,\n      priority: priorityOf(type),\n      status: \"pending\",\n      scheduled_at: Date.now(),\n      created_at: Date.now(),\n      meta: {\n        repeat,\n        time: runAt,\n        days: Array.isArray(r.days) ? r.days : [],\n      },\n    };\n\n    outCreate.push({ task, payload: task });\n    outDebug.push({ payload: { ok: true, fired: firedKey, task_id: task.task_id, type, target_area: targetArea } });\n  }\n\n  context.set(\"lastFired\", lastFired);\n\n  return [\n    outCreate.length ? outCreate : null,\n    outDebug.length ? outDebug : null,\n  ];\n})().catch((err) => {\n  node.error(err);\n  return [null, [{ payload: { ok: false, error: String(err?.message || err) } }]];\n});\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 870,
        "y": 2560,
        "wires": [
            [
                "2ccacb1608c5ba74"
            ],
            [
                "1082c3d0195e3e5c"
            ]
        ]
    },
    {
        "id": "1082c3d0195e3e5c",
        "type": "debug",
        "z": "49f8711fc297a8c1",
        "name": "debug 10",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1200,
        "y": 2560,
        "wires": []
    },
    {
        "id": "d10c4415b361b866",
        "type": "telegram bot",
        "botname": "yujinnnojin",
        "usernames": "",
        "chatids": "",
        "baseapiurl": "",
        "testenvironment": false,
        "updatemode": "polling",
        "pollinterval": 300,
        "usesocks": false,
        "sockshost": "",
        "socksprotocol": "socks5",
        "socksport": 6667,
        "socksusername": "anonymous",
        "sockspassword": "",
        "bothost": "",
        "botpath": "",
        "localbothost": "0.0.0.0",
        "localbotport": 8443,
        "publicbotport": 8443,
        "privatekey": "",
        "certificate": "",
        "useselfsignedcertificate": false,
        "sslterminated": false,
        "verboselogging": false
    },
    {
        "id": "3c16a07776b27396",
        "type": "mqtt-broker",
        "name": "Server",
        "broker": "localhost",
        "port": 1883,
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": 4,
        "keepalive": 60,
        "cleansession": true,
        "autoUnsubscribe": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthRetain": "false",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closeRetain": "false",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willRetain": "false",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "e6e1b7942a2b8330",
        "type": "ui_group",
        "name": "Robots",
        "tab": "8949e4e33e605647",
        "order": 2,
        "disp": true,
        "width": 6,
        "collapse": false,
        "className": ""
    },
    {
        "id": "7e8e44e7110066b9",
        "type": "ui_group",
        "name": "Summary",
        "tab": "8949e4e33e605647",
        "order": 1,
        "disp": true,
        "width": 6,
        "collapse": false,
        "className": ""
    },
    {
        "id": "920df32220cd089d",
        "type": "ui_group",
        "name": "Tasks",
        "tab": "8949e4e33e605647",
        "order": 3,
        "disp": true,
        "width": 6,
        "collapse": false,
        "className": ""
    },
    {
        "id": "ab2f507577ca5dbe",
        "type": "ui_group",
        "name": "Events",
        "tab": "8949e4e33e605647",
        "order": 4,
        "disp": true,
        "width": 6,
        "collapse": false,
        "className": ""
    },
    {
        "id": "8949e4e33e605647",
        "type": "ui_tab",
        "name": "AGV Control Center",
        "icon": "dashboard",
        "order": 1,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "337f092a465fc819",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-telegrambot": "17.0.3",
            "node-red-dashboard": "3.6.6"
        }
    }
]